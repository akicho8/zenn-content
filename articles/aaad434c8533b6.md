---
title: "Fabric.js ã®ä½¿ã„æ–¹ãƒ¡ãƒ¢"
emoji: "ğŸ–¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fabric"]
published: true
---

<!-- # ã¯ã˜ã‚ã« # -->

Canvas å†…ã«ç”»åƒã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’é…ç½®ã—ãŸã‚Šã™ã‚‹ã®ã«ä¾¿åˆ©ãª [Fabric.js](http://fabricjs.com/) ã®ä½¿ã„æ–¹ã®è‡ªåˆ†ç”¨ãƒ¡ãƒ¢ã§ã™

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« #

```shell
yarn add fabric
```

# ã„ã¡ã°ã‚“ç°¡å˜ãªè¡¨ç¤ºã®ä¾‹ #

```vue
<template lang="pug">
  canvas(ref="canvas_el" width="200" height="200")
</template>

<script>
import { fabric } from "fabric"
export default {
  mounted() {
    const canvas = new fabric.Canvas(this.$refs.canvas_el)
    const rect = new fabric.Rect({width: 50, height: 50, fill: "blue"})
    canvas.add(rect)
    rect.center()
  },
}
</script>

<style lang="sass">
canvas
  border: 1px dashed blue
</style>
```

  * Vue.js ã®ã‚ªãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã§æ›¸ã„ã¦ã‚‹
  * æœ€åˆã« `fabric.Canvas` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
  * ãã‚Œã«å¯¾ã—ã¦ä»–ã®è¦ç´ ã‚’ `add` ã—ã¦ã„ã
  * `center()` ã¯ `add` ã—ã¦ã‹ã‚‰ã§ãªã„ã¨åŠ¹ã‹ãªã‹ã£ãŸ (ãã‚Œã¯ãã†)

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãŠç´„æŸçš„ãªã“ã¨ #

ã‚¤ãƒ³ã‚¿ãƒ³ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã§ãã‚‹å±æ€§åã¨åŒã˜ã‚¢ã‚¯ã‚»ã‚µãŒã‚ã‚‹ã£ã½ã„
ãªã®ã§æ¬¡ã®2ã¤ã¯åŒã˜ã“ã¨ (ã ã¨å‹æ‰‹ã«æ€ã£ã¦ã„ã‚‹)

```javascript
const canvas = new fabric.Canvas(html_element, {selection: false})
```

```javascript
const canvas = new fabric.Canvas(html_element)
canvas.selection = false
```

# èƒŒæ™¯ç”»åƒã®èª­ã¿è¾¼ã¿ #

## æ–¹æ³•1. ã¨ã«ã‹ãèª­ã¿è¾¼ã‚€ ##

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
canvas.setBackgroundImage(url, () => canvas.renderAll())
```
  * `fabric.Image.fromURL` ã§èª­ã¿è¾¼ã‚“ã ã‚‚ã®ã‚’ `canvas.setBackgroundImage` ã«æ¸¡ã—ã¦ã‚‚ã‚ˆã„
  * ç¬¬äºŒå¼•æ•°ã®è¬
    * ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ã¯ `canvas.renderAll.bind(canvas)` ã¨æ›¸ã„ã¦ã‚ã‚‹
    * ã‚°ã‚°ã£ã¦ã‚‚ãã‚Œã°ã‹ã‚Šã§ã¦ãã‚‹
    * æ„å‘³ãŒã‚ã‹ã‚‰ãªã„ã®ã§ `() => canvas.renderAll()` ã«å¤‰ãˆãŸã‚‰å‹•ã„ãŸã®ã§ã‚ˆã—ã¨ã™ã‚‹
  * `renderAll()` ã‚’å‘¼ã°ãªã„ã¨è¡¨ç¤ºã•ã‚Œãªã„
  * `toDataURL` ã§ããªã„ç½ ã‚ã‚Š (å¾Œè¿°)

## æ–¹æ³•2. èƒŒæ™¯ç”»åƒã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’åˆã‚ã›ã‚‹ ##

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
canvas.setBackgroundImage(url, e => {
  canvas.setDimensions({width: e.width, height: e.height})
  canvas.renderAll()
})
```

  * ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã¯å¤‰ã‚ã‚‹ã‘ã©éš™é–“ã¯ã§ããªã„
  * ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå·¨å¤§åŒ–ã™ã‚‹æã‚Œã‚ã‚Š
  * ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã¯ã‚ã¨ã‹ã‚‰å¤‰æ›´ã§ããªã„ã¨æ€ã£ã¦ãŸã‘ã©å‹˜é•ã„ã ã£ãŸã‚ˆã†ã 

## æ–¹æ³•3. ã‚­ãƒ£ãƒ³ãƒã‚¹ã«èƒŒæ™¯ç”»åƒã‚’åˆã‚ã›ã‚‹ ##

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
fabric.Image.fromURL(url, e => {
  e.scaleToWidth(canvas.width)
  canvas.setBackgroundImage(e, () => canvas.renderAll())
})
```

  * ä¸Šã¯æ¨ªå¹…ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åã‚ã‚‹å ´åˆã®ä¾‹
  * ç¸¦å¹…ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åã‚ã‚‹å ´åˆã¯ `e.scaleToHeight(canvas.height)` ã¨ã™ã‚‹

# toDataURL ãŒå¤±æ•—ã™ã‚‹å•é¡Œ #

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
canvas.setBackgroundImage(url, e => {
  canvas.renderAll()
})

const data_url = canvas.toDataURL()
```

  * ä¸Šã®ã‚ˆã†ã«å¤–éƒ¨ã®ç”»åƒã‚’èª­ã¿è¾¼ã‚€ã¨ `toDataURL` ãŒå¤±æ•—ã™ã‚‹
  * ã€Œã‚­ãƒ£ãƒ³ãƒã‚¹æ±šæŸ“ã•ã‚Œã¦ã„ã‚‹ã€ã¨ã„ã†ã ã‘ã®ä¸è¦ªåˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã‚‹

å¯¾ç­–1. è¦ç´ ã« crossOrigin æŒ‡å®š

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
canvas.setBackgroundImage(url, e => {
  e.crossOrigin = "anonymous"
  canvas.renderAll()
}
```

å¯¾ç­–2. setBackgroundImage ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« crossOrigin æŒ‡å®š

```javascript
const url = "https://dummyimage.com/600x400/008/FFF.png"
canvas.setBackgroundImage(url, e => {
  canvas.renderAll()
}, {
  crossOrigin: "anonymous",
})
```

ä¸Šã®ã©ã¡ã‚‰ã‚‚ã§ã‚‚å›é¿ã§ããŸ
ä¼¼ãŸå¯¾å‡¦æ–¹ãŒè¤‡æ•°ã‚ã£ã¦ãªã‚“ã¨ã‚‚ã™ã£ãã‚Šã—ãªã„

##### å‚è€ƒ ğŸ™ #####

https://blog.np-sys.com/tainted-canvases-may-not-be-exported/

# originX originY ã¨ã¯ä½•ãªã®ã‹ï¼Ÿ #

  * å…¬å¼ã‚µã‚¤ãƒˆã®[ã‚µãƒ³ãƒ—ãƒ«](http://fabricjs.com/test/misc/origin.html)ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸ
  * è¦ç´ ã®åº§æ¨™ã¯è¦ç´ ã®ã©ã“ã‚’åŸºç‚¹ã¨ã—ã¦ã„ã‚‹ã‹ã‚’è¡¨ã‚ã™
  * çµ„ã¿åˆã‚ã›çš„ã«ã¯å¤šã„ãŒè€ƒæ…®ã™ã‚‹ã®ã¯**å·¦ä¸Š**ã¨**ä¸­å¤®**ã®äºŒã¤ã—ã‹ãªã„

| originX | originY | åŸºç‚¹  |        |
|---------|---------|--------|--------|
| left    | top     | å·¦ä¸Š   | åˆæœŸå€¤ |
| center  | center  | ä¸­å¤®   |        |

  * Rust ã® nannou ã®ã‚ˆã†ã«ã€ã‚ˆã‚ŠæŠ½è±¡åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä¸­å¤®åŸºç‚¹ã®ã“ã¨ãŒå¤šã„
  * fabric ã‚‚ä¸­å¤®ãŒåˆæœŸå€¤ã®æ–¹ãŒã‚ˆã‹ã£ãŸ

ã¨ã‚Šã‚ãˆãšãƒ‘ãƒ¼ãƒ„é¡ã‚’é…ç½®ã™ã‚‹ã¨ãã¯ã“ã†ã‚„ã£ã¦ãŠã

```javascript
const el = new fabric.Rect({
  originX: "center",
  originY: "center",
  ...
})
canvas.add(el)
```

## è¦ç´ ã®ä¸­å¤®ã®åº§æ¨™ã‚’æ±‚ã‚ã‚‹ã®ã«ç„¡é§„ã«ãŒã‚“ã°ã£ã¦ã¯ã„ã‘ãªã„ ##

ä»®ã« 100x100 ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸­å¤®ä»˜è¿‘ã« 50x50 ã®è¦ç´ ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã¨ãã®è¦ç´ ã® `aCoords` ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã„ã‚‹

```text
{
  tl: { x: 24.5, y: 24.5 },
  tr: { x: 75.5, y: 24.5 },
  br: { x: 75.5, y: 75.5 },
  bl: { x: 24.5, y: 75.5 },
}
```

`tl` ã¯å·¦ä¸Šã§ `br` ã¯å³ä¸‹ãªã®ã§ X åº§æ¨™ã®ä¸­å¿ƒã‚’æ±‚ã‚ã‚‹ãªã‚‰
`tl.x + (br.x - tl.x) / 2`
ãªã®ã§
`24.5 + (75.5 - 24.5) / 2`
ã¨ã—ã¦ 50 ã«ãªã‚‹
åŒæ§˜ã« Y åº§æ¨™ã‚‚è¨ˆç®—ã™ã‚‹ã¨ 50 ã«ãªã‚‹

ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§ã„ã‹ã«ã‚‚é–“é•ãˆãã†ãªè¨ˆç®—ã‚’ã—ãªã„ã§ã„ã„ã‚ˆã†ã« originX ã¨ originY ã«ã¯ center ã‚’æŒ‡å®šã—ã¦ãŠã

```javascript
new fabric.Rect({
  originX: "center",
  originY: "center",
  ...
})
```

ãã†ã™ã‚Œã° `(left, top)` ã¯æœ€åˆã‹ã‚‰ `(50, 50)` ã«ãªã£ã¦ã„ã‚‹

# è¦‹ãˆã‚‹åŒ–ã™ã‚‹ #

```javascript
template(v-if="canvas")
  p {{canvas.getActiveObject()}}
  b-table(:data="canvas.getObjects()")
    template(slot-scope="{row}")
      b-table-column(label="type") {{row.type}}
      b-table-column(label="x") {{row.top}}
      b-table-column(label="y") {{row.left}}
      b-table-column(label="w") {{row.width}}
      b-table-column(label="h") {{row.height}}
      b-table-column(label="raw") {{row}}
      b-table-column
        button.button(@click="canvas.remove(row)") remove
```

å‹•ä½œæ¤œè¨¼ã—ã¦ã„ã‚‹ç’°å¢ƒãŒå¤§æ˜”ã® Vue.js + Buefy ã§ä½•ã‹ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã¨ä½•ã‹ãŒå£Šã‚Œã‚‹ã¨ã„ã†æ‚²ã—ã„çŠ¶æ³ãªã®ã§ã‹ãªã‚Šå¤ã‚ã‹ã—ã„æ›¸ãæ–¹ã«ãªã£ã¦ã—ã¾ã£ãŸ
ã¨ã‚Šã‚ãˆãšã„ã‚ã„ã‚è¡¨ç¤ºã—ã¨ã‹ãªã„ã¨ã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªã„
`getObjects()` ã§ä¿æŒã—ã¦ã„ã‚‹è¦ç´ ã®é…åˆ—ãŒè¿”ã‚‹

ãŸã ã“ã®ã¾ã¾ã ã¨å†æç”»ã•ã‚Œãªã„ã®ã§ãƒã‚¦ã‚¹æ“ä½œã‚’å¤‰æ›´ã®ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦å†æç”»ã™ã‚‹

```javascript
this.canvas.on("mouse:move", () => this.$forceUpdate())
```

ã‚‚ã—ãã¯ `deep: true` ã§å¤‰æ›´ã‚’ç›£è¦–ã—ã¦å†æç”»ã™ã‚‹

```javascript
watch: {
  canvas: {
    handler() { this.$forceUpdate() },
    deep: true,
  },
},
```

# ãƒ†ã‚­ã‚¹ãƒˆã‚’é…ç½®ã™ã‚‹ #

```javascript
const element = new fabric.Text("ã“ã‚“ã«ã¡ã¯", {
  originX: "center",
  originY: "center",
  fill: "black",
  fontSize: 64,
  fontFamily: "Ariel",
})
canvas.add(element)
element.center()
```

  * `origin(X|Y)` ã§ã€Œã“ã‚“ã«ã¡ã¯ã€ã®ã€Œã«ã€ã®ä¸­å¿ƒã‚’åº§æ¨™ã®åŸºç‚¹ã¨ã™ã‚‹(é‡è¦)
  * èƒŒæ™¯ç”»åƒã®ä¸Šã«é…ç½®ã™ã‚‹å ´åˆã¯èª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã“ã‚Œã‚’è¿½åŠ ã—ã¦ç¸å–ã‚‹

```javascript
stroke: "white",   // ç¸å–ã‚Šè‰²
strokeWidth: 1.0,  // ç¸å–ã‚Šå¹…
```

# ã‚ˆãä½¿ã†ãƒ¡ã‚½ãƒƒãƒ‰ #

Canvas
| Code                                | æ„å‘³                             |
|-------------------------------------|----------------------------------|
| canvas.add(el)                      | è¦ç´  è¿½åŠ                         |
| canvas.remove(el)                   | è¦ç´  å‰Šé™¤                        |
| canvas.selection = false            | ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠç¦æ­¢                 |
| canvas.setZoom(1.0)                 | å…¨ä½“ã®æ‹¡ç¸® (1.0 ãŒåŸºæº–)          |
| canvas.toJSON()                     | çŠ¶æ…‹ã‚’ json åŒ– (SVGã‚’å«ã‚€)       |
| canvas.toDatalessJSON()             | çŠ¶æ…‹ã‚’ json åŒ– (SVGã‚’å«ã¾ãªã„)   |
| canvas.loadFromJSON(xxx)            | json ã§å¾©å…ƒ                      |
| canvas.setDimensions(attrs)         | width: height: ã§ w h ã‚’æŒ‡å®šã™ã‚‹ |
| canvas.setWidth(w)                  | width æŒ‡å®š                       |
| canvas.setHeight(h)                 | height æŒ‡å®š                      |
| canvas.setBackgroundImage(url, ...) | èƒŒæ™¯ç”»åƒè¨­å®šã€‚ç¬¬äºŒå¼•æ•°é‡è¦       |
| canvas.setActiveObject(el)          | æŒ‡å®šã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯             |
| canvas.getActiveObject()            | ä»Šå‹•ã‹ã›ã‚‹è¦ç´ ã‚’è¿”ã™             |
| canvas.getObjects()                 | è¦ç´ ã®é…åˆ—                       |
| canvas.size()                       | è¦ç´ ã®é…åˆ—ã®å€‹æ•°                 |

è¦ç´ 
| Code                              | æ„å‘³                           |
|-----------------------------------|--------------------------------|
| el.center()                       | ä¸Šä¸‹å·¦å³ã‚’è€ƒæ…®ã—ã¦ä¸­å¤®ã«è¡¨ç¤º   |
| el.set({hasRotatingPoint: false}) | å›è»¢ã•ã›ãªã„                   |
| el.scaleToWidth(50)               | æ¨ªå¹…å¤‰æ›´ (æ¯”ç‡ç¶­æŒ)            |
| el.scaleToHeight(50)              | ç¸¦å¹…å¤‰æ›´ (æ¯”ç‡ç¶­æŒ)            |
| el.set(left: 50})                 | å·¦ã‹ã‚‰æŒ‡å®šãƒ”ã‚¯ã‚»ãƒ«ã®ä½ç½®ã«ç§»å‹• |
| el.set({selectable: false})       | é¸æŠã•ã›ãªã„                   |
| el.set({lockScalingFlip: true})   | è£è¿”ã—ã«ã•ã›ãªã„               |
| el.set({fill: #008})              | å¡—ã‚Šæ½°ã—è‰²ã®æŒ‡å®š               |
| el.set({opacity: 0.5})            | éé€æ˜åº¦ã®æŒ‡å®š                 |
| el.moveTo(1)                      | å„ªå…ˆé †ä½ã®å¤‰æ›´ ç›´æ¥            |
| el.bringToFront()                 | å„ªå…ˆé †ä½ã®å¤‰æ›´ å‰é¢ã¸          |
| el.sendToBack()                   | å„ªå…ˆé †ä½ã®å¤‰æ›´ èƒŒé¢ã¸          |

# Rect ãŒæŒã£ã¦ã„ã‚‹å±æ€§ #

ãƒ€ãƒ³ãƒ—ã—ãŸã¨ãã«å‡ºã¦ããŸã®ãŒã“ã‚Œã£ã¦ã„ã†ã ã‘ã§ã‚‚ã£ã¨ã‚ã‚‹ã¨æ€ã‚ã‚Œã‚‹
`hasRotatingPoint` ã¨ã‹ã€ãªã‚“ã§å‡ºã¦ã“ãªã„ã‚“ã ã‚ã†ï¼Ÿ

| å±æ€§å                   | å€¤            |
|--------------------------|---------------|
| type                     | "rect"        |
| version                  | "2.6.0"       |
| originX                  | "center"      |
| originY                  | "center"      |
| left                     | 200           |
| top                      | 200           |
| width                    | 50            |
| height                   | 50            |
| fill                     | "cyan"        |
| stroke                   | null          |
| strokeWidth              | 1             |
| strokeDashArray          | null          |
| strokeLineCap            | "butt"        |
| strokeDashOffset         | 0             |
| strokeLineJoin           | "miter"       |
| strokeMiterLimit         | 4             |
| scaleX                   | 1             |
| scaleY                   | 1             |
| angle                    | 0             |
| flipX                    | false         |
| flipY                    | false         |
| opacity                  | 1             |
| shadow                   | null          |
| visible                  | true          |
| clipTo                   | null          |
| backgroundColor          | ""            |
| fillRule                 | "nonzero"     |
| paintFirst               | "fill"        |
| globalCompositeOperation | "source-over" |
| transformMatrix          | null          |
| skewX                    | 0             |
| skewY                    | 0             |
| rx                       | 0             |
| ry                       | 0             |

# å‚ç…§ #

http://fabricjs.com/docs/
