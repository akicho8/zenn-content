---
title: "Ruby/SDL2 ã“ã¨ã¯ã˜ã‚"
emoji: "ğŸ¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ruby", "SDL2", "SDL"]
published: false
---

## ã¯ã˜ã‚ã«

ã„ã¤ã®ã¾ã«ã‹ [Ruby/SDL2](https://rubygems.org/gems/ruby-sdl2/versions/0.1.0?locale=ja) ãŒå…¬é–‹ã•ã‚Œã¦ã„ãŸã®ã§å°å…¥ã®æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

`~/src/ruby-sdl2-playground` ã«ä½œæˆã™ã‚‹ä¾‹ã§ã™ã€‚

```sh
#!/bin/sh
cd ~/src
mkdir -p ruby-sdl2-playground
cd ruby-sdl2-playground

bundle init
bundle add ruby-sdl2 --require sdl2 --optimistic
bundle exec ruby -r sdl2 -e "p SDL2"

cat <<'EOF' > main.rb
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::ACCELERATED
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

120.times do
  SDL2::Event.poll
  renderer.present
end
EOF

bundle exec ruby main.rb
```

æ¬¡ã®ã‚ˆã†ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒ2ç§’è¡¨ç¤ºã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™ã€‚

![simple_window.png](/images/7170a5dc60c97b/simple_window.png)

## ä½•ã‹å‹•ã‹ã—ã¦ã¿ã‚ˆã†

ã“ã‚“ãªã¨ãã¯ã¡ã‚‡ã£ã¨ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã’ãƒ¼å‹•ããƒªã‚µã‚¸ãƒ¥ãƒ¼çš„ãªã‚„ã¤ã«ã™ã‚‹ã¨æ±ºã¾ã£ã¦ã„ã¾ã™ã€‚

```ruby
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::ACCELERATED
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

include Math

frame_counter = 0
loop do
  while ev = SDL2::Event.poll
    case ev
    when SDL2::Event::KeyDown
      case ev.scancode
      when SDL2::Key::Scan::ESCAPE
        exit
      when SDL2::Key::Scan::Q
        exit
      end
    end
  end

  renderer.draw_blend_mode = SDL2::BlendMode::BLEND
  renderer.draw_color = [0, 0, 64, 32]
  renderer.fill_rect(SDL2::Rect.new(0, 0, *window.size))

  renderer.draw_blend_mode = SDL2::BlendMode::NONE
  renderer.draw_color = [0, 0, 16*28]

  r = 64
  w, h = window.size
  x = w / 2 + cos(PI * frame_counter * 0.03 * 0.7) * w * 0.4
  y = h / 2 + sin(PI * frame_counter * 0.03 * 0.8) * h * 0.4
  renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))

  renderer.present
  frame_counter += 1
end
```

![lissajous](/images/7170a5dc60c97b/lissajous.png)

é™æ­¢ç”»ãªã®ã§ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã¬ã‚‹ã¬ã‚‹å‹•ã„ã¦ã„ã¾ã™ã€‚

## ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯åŒ–

Ruby/SDL* ã®ãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã‚‹ã‚µãƒ³ãƒ—ãƒ«ã¯ä¸Šã®ã‚ˆã†ã«ãƒ™ã‚¿æ›¸ããŒå¤šã„ã§ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã¯ãƒ™ã‚¿æ›¸ãã®æ–¹ãŒä¸€ç›´ç·šã«å‡¦ç†ãŒè¿½ãˆã¦ã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ã™ãŒã€ãã®æ§‹é€ ã®ã¾ã¾ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¶³ã—ã¦ã„ãã¨ä½•ãŒãªã‚“ã ã‹ã‚ã‹ã‚‰ãªããªã£ã¦ãã¾ã™ã€‚
ãªã®ã§ãƒ‡ã‚¶ãƒ‘ã‚¿ã§è¨€ã†ã¨ã“ã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å¿…è¦ãªã¨ã“ã‚ã ã‘æ›¸ã‘ã°è‰¯ã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ruby
require "bundler/setup"
Bundler.require(:default)

class Base
  include Math

  class << self
    def run(*args)
      new(*args).run
    end
  end

  def run
    setup
    loop do
      event_loop
      update
      before_view
      view
      after_view
    end
  end

  private

  def setup
    SDL2.init(SDL2::INIT_EVERYTHING)
  end

  def update
  end

  def view
  end

  def before_view
  end

  def after_view
  end

  def event_loop
    while ev = SDL2::Event.poll
      event_process(ev)
    end
  end

  def event_process(ev)
    case ev
    when SDL2::Event::KeyDown
      if ev.scancode == SDL2::Key::Scan::ESCAPE
        exit
      end
      if ev.scancode == SDL2::Key::Scan::Q
        exit
      end
    end
  end
end

# Base.run
```

ä¸Šã®ã‚ˆã†ãªæ„Ÿã˜ã§å‘¼ã³å‡ºã—é †åºã¨å¿…è¦æœ€ä½é™ãªå‡¦ç†ã ã‘ã‚’æ›¸ã„ã¨ãã¾ã™ã€‚
æŠ½è±¡ã‚¯ãƒ©ã‚¹ã§ã™ãŒå®Ÿè¡Œã™ã‚‹ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå‡ºãªã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã¨ã‚Šã‚ãˆãšå‹•ãã¾ã™ã€‚

### Window ã®è¿½åŠ 

```ruby
module WindowMethods
  attr_accessor :window
  attr_accessor :renderer
  attr_accessor :frame_counter

  def setup
    super

    flags = 0
    # flags |= SDL2::Window::Flags::FULLSCREEN
    # flags |= SDL2::Window::Flags::FULLSCREEN_DESKTOP
    pos = SDL2::Window::POS_CENTERED
    @window = SDL2::Window.create("(Title)", pos, pos, 640, 480, flags)

    flags = 0
    flags |= SDL2::Renderer::Flags::ACCELERATED
    flags |= SDL2::Renderer::Flags::PRESENTVSYNC
    @renderer = @window.create_renderer(-1, flags)

    @frame_counter = 0
  end

  def before_view
    super

    renderer.draw_blend_mode = SDL2::BlendMode::BLEND
    renderer.draw_color = [0, 0, 64, 32]
    renderer.fill_rect(SDL2::Rect.new(0, 0, *window.size))

    renderer.draw_blend_mode = SDL2::BlendMode::NONE
    renderer.draw_color = [0, 0, 16*28]
  end

  def after_view
    super

    @frame_counter += 1
    renderer.present
  end
end

Base.prepend(WindowMethods)

# Base.run
```

å®Ÿè¡Œã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå‡ºã‚Œã°OKã§ã™ã€‚

ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ãŒç›®ç«‹ã¤ã‘ã©ã»ã£ã¨ãã¾ã™ã€‚
ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ã‚„ã‚„ç‰¹æ®Šã§ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã ã‚‰ã‘ã«ãªã‚ŠãŒã¡ã§ã™ã€‚
ã“ã‚Œã‚’ã¨ã‚Šã‚ãˆãšãªæ„Ÿã˜ã§æŠ½è±¡åŒ–ã—ãŸã‚Šå®šæ•°åŒ–ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚­ãƒªãŒãªããªã‚Šã¾ã™ã€‚
æŠ½è±¡åŒ–ã‚„å®šæ•°åŒ–ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã¡ã‚ƒãã¡ã‚ƒã‚ã‚‹å ´åˆã«ã‚„ã£ã¨ã™ã‚‹ã‹ã—ãªã„ã‹ãã‚‰ã„ã§ã‚ˆã„ã§ã™ã€‚

## æœ¬å½“ã«æ›¸ããŸã‹ã£ãŸã¨ã“ã‚

```ruby
class App < Base
  def view
    r = 64
    w, h = window.size
    x = w / 2 + cos(PI * frame_counter * 0.03 * 0.7) * w * 0.4
    y = h / 2 + sin(PI * frame_counter * 0.03 * 0.8) * h * 0.4
    renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))
  end

  run
end
```

ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’é©ç”¨ã—ã¦æœ€åˆã®ã‚³ãƒ¼ãƒ‰ãŒã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸã€‚

## ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ‹¡å¼µ

### FPS ã‚’è¦‹ãŸã„ã¨ãã¯ï¼Ÿ

ã„ã¾ä½•ãƒ•ãƒ¬ãƒ¼ãƒ ã§å‹•ã„ã¦ã„ã‚‹ã®ã‹çŸ¥ã‚ŠãŸã‹ã£ãŸã‚‰ã€æ¬¡ã®ã‚ˆã†ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å·®ã—è¾¼ã¿ã¾ã™ã€‚

```ruby
module FpsCounterMethods
  def setup
    super

    @real_fps = 60
    @fps_counter = 0
    @old_time = SDL2.get_ticks
  end

  def update
    super

    @fps_counter += 1
    v = SDL2.get_ticks
    t = v - @old_time
    if t >= 1000
      @real_fps = @fps_counter
      @old_time = v
      @fps_counter = 0
    end
  end
end

Base.prepend(FpsCounterMethods)
```

`@real_fps` ãŒç¾åœ¨ã®ç§’é–“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã§ã™ã€‚

ã‚¯ãƒ©ã‚¹åŒ–ã—ã¦å‡¦ç†ã‚’åˆ†ã‘ãŸã“ã¨ã§ä¸Šã®ã‚ˆã†ã«å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«æ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã¾ã—ãŸã€‚

ãªã®ã§ä¾‹ãˆã°ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’èª­ã¿å–ã£ã¦æ‰±ã„ã‚„ã™ã„å½¢ã«ã—ã¦ãŠããªã©ã‚‚ã“ã®ã‚ˆã†ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ã¦è¿½åŠ ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

ã±ã£ã¨è¦‹ã€ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å†…ã«ã‚ˆãã‚ã‹ã‚‰ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ãŒã°ã‚‰ã¾ã‹ã‚ŒãŸã®ãŒã„ã¾ã„ã¡ãªã®ã§ã‚¯ãƒ©ã‚¹åŒ–ã—ãŸæ–¹ãŒã‚ˆã„æ°—ãŒã—ã¾ã™ãŒã€ãã‚Œã¯ã„ã£ãŸã‚“ç½®ã„ã¨ãã¾ã™ã€‚

## é›‘æ„Ÿ

- [rsdl](https://rubygems.org/gems/rsdl/versions/0.1.2?locale=ja) ãŒä¸è¦ã«ãªã£ãŸã£ã½ã„
  - Ruby/SDL æ™‚ä»£ã¯ ruby ã®ã‹ã‚ã‚Šã« rsdl ã§èµ·å‹•ã—ãªã„ã¨å‹•ã‹ãªã‹ã£ãŸ
  - ã‚ã‹ã£ã¦ã„ã¦ã‚‚ã“ã®ç½ ã«ã¯ã¾ã‚Šç¶šã‘ãŸ
- SGE ã¾ã§ä¸è¦ã«ãªã£ãŸã£ã½ã„
  - Ruby/SDL æ™‚ä»£ã¯ SGE ã‚’åˆ¥é€”å…¥ã‚Œãªã„ã¨ã‚ãã«æç”»ã§ããªã‹ã£ãŸ
  - ã“ã® SGE ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ¿€ãƒ ã‚º
  - ã©ã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚Œã°ã„ã„ã®ã‹ã‚‚ã‚ã‹ã‚‰ãªã„
  - ãã®ã›ã„ã‹ Ruby/SDL æœ¬ä½“ã«ã“ã£ãã‚Šãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ãŸ
    - ãƒ“ãƒ«ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸ
- ä½¿ã„ã‚„ã™ããªã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹
  - draw_color ã§è‰²ã ã‘æŒ‡å®šã§ãã‚‹ã¨ã“ã‚ã¨ã‹
  - PRESENTVSYNC ã ã‘ã§å‚ç›´åŒæœŸã¨ã‹
- Nannou ã¨ã¯ç«‹ã¡ä½ç½®ãŒå¤§ããç•°ãªã‚‹
  - Nannou ã¯
    - çµ‚äº†ã‚„å…¨ç”»é¢åŒ–ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šæ¸ˆã¿
    - ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã‚„ã‚‰ã‚’ã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹
      - ç¯„å›²ã‚„ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¶…å¼·åŠ›
      - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã©ã“ã«ä½•ã‚’æ›¸ãã‹ãŒå³å¯†ã«æ±ºã¾ã£ã¦ã„ã‚‹
  - Ruby/SDL ã¯
    - ã™ã¹ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã‹ã›
      - Escape ã¨ã‹æŠ¼ã—ã¦ã‚‚çµ‚äº†ã—ãªã„
        - ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—è‡ªä½“è‡ªåˆ†ã§æ›¸ã
        - é¢ç™½åŠåˆ†ã«å…¨ç”»é¢ã«ã—ãŸã‚Šã™ã‚‹ã¨ãƒã‚°ã£ãŸã¨ãPCã‚’è½ã¨ã•ãªã„ã¨å¾©å¸°ã§ããªã‹ã£ãŸã‚Šã™ã‚‹
      - FPS å€¤ã‚’ã™ãã«çŸ¥ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒãªã„
      - é ˜åŸŸã‚’æ‰±ã†ä¾¿åˆ©ã‚¯ãƒ©ã‚¹ã‚„å¼·åŠ›ãªãƒ™ã‚¯ãƒˆãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ãŒãªã„
      - ã©ã“ã«ä½•ã‚’æ›¸ãã‹ãŒæ±ºã¾ã£ã¦ãªã„
      - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã„ã†ã‚ˆã‚Šãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
    - ãã‚ŒãŒã„ã„
