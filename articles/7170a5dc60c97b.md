---
title: "Ruby/SDL2 ことはじめ"
emoji: "🎨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Ruby", "SDL2", "SDL"]
published: false
---

## はじめに

いつのまにか [Ruby/SDL2](https://rubygems.org/gems/ruby-sdl2/versions/0.1.0?locale=ja) が公開されていたので導入の手順を紹介します。

## セットアップ

`~/src/ruby-sdl2-playground` に作成する例です。

```sh
#!/bin/sh
cd ~/src
mkdir -p ruby-sdl2-playground
cd ruby-sdl2-playground

bundle init
bundle add ruby-sdl2 --require sdl2 --optimistic
bundle exec ruby -r sdl2 -e "p SDL2"

cat <<'EOF' > main.rb
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::ACCELERATED
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

120.times do
  SDL2::Event.poll
  renderer.present
end
EOF

bundle exec ruby main.rb
```

次のようなウィンドウが2秒表示されたら成功です。

![simple_window.png](/images/7170a5dc60c97b/simple_window.png)

## 何か動かしてみよう

こんなときはちょっとのコードですげー動くリサジュー的なやつにすると決まっています。

```ruby
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::ACCELERATED
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

include Math

frame_counter = 0
loop do
  while ev = SDL2::Event.poll
    case ev
    when SDL2::Event::KeyDown
      case ev.scancode
      when SDL2::Key::Scan::ESCAPE
        exit
      when SDL2::Key::Scan::Q
        exit
      end
    end
  end

  renderer.draw_blend_mode = SDL2::BlendMode::BLEND
  renderer.draw_color = [0, 0, 64, 32]
  renderer.fill_rect(SDL2::Rect.new(0, 0, *window.size))

  renderer.draw_blend_mode = SDL2::BlendMode::NONE
  renderer.draw_color = [0, 0, 16*28]

  r = 64
  w, h = window.size
  x = w / 2 + cos(PI * frame_counter * 0.03 * 0.7) * w * 0.4
  y = h / 2 + sin(PI * frame_counter * 0.03 * 0.8) * h * 0.4
  renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))

  renderer.present
  frame_counter += 1
end
```

![lissajous](/images/7170a5dc60c97b/lissajous.png)

静止画なのでわかりませんがぬるぬる動いています。

## ミニフレームワーク化

Ruby/SDL* のリポジトリに含まれるサンプルは上のようにベタ書きが多いです。
サンプルとしてはベタ書きの方が一直線に処理が追えてわかりやすいのですが、その構造のままコードを書き足していくと何がなんだかわからなくなってきます。
なのでデザパタで言うところのテンプレートメソッドパターンで必要なところだけ書けば良いようにします。

```ruby
require "bundler/setup"
Bundler.require(:default)

class Base
  include Math

  class << self
    def run(*args)
      new(*args).run
    end
  end

  def run
    setup
    loop do
      event_loop
      update
      before_view
      view
      after_view
    end
  end

  private

  def setup
    SDL2.init(SDL2::INIT_EVERYTHING)
  end

  def update
  end

  def view
  end

  def before_view
  end

  def after_view
  end

  def event_loop
    while ev = SDL2::Event.poll
      event_process(ev)
    end
  end

  def event_process(ev)
    case ev
    when SDL2::Event::KeyDown
      if ev.scancode == SDL2::Key::Scan::ESCAPE
        exit
      end
      if ev.scancode == SDL2::Key::Scan::Q
        exit
      end
    end
  end
end

# Base.run
```

上のような感じで呼び出し順序と必要最低限な処理だけを書いときます。
抽象クラスですが実行するとウィンドウが出ないアプリケーションがとりあえず動きます。

### Window の追加

```ruby
module WindowMethods
  attr_accessor :window
  attr_accessor :renderer
  attr_accessor :frame_counter

  def setup
    super

    flags = 0
    # flags |= SDL2::Window::Flags::FULLSCREEN
    # flags |= SDL2::Window::Flags::FULLSCREEN_DESKTOP
    pos = SDL2::Window::POS_CENTERED
    @window = SDL2::Window.create("(Title)", pos, pos, 640, 480, flags)

    flags = 0
    flags |= SDL2::Renderer::Flags::ACCELERATED
    flags |= SDL2::Renderer::Flags::PRESENTVSYNC
    @renderer = @window.create_renderer(-1, flags)

    @frame_counter = 0
  end

  def before_view
    super

    renderer.draw_blend_mode = SDL2::BlendMode::BLEND
    renderer.draw_color = [0, 0, 64, 32]
    renderer.fill_rect(SDL2::Rect.new(0, 0, *window.size))

    renderer.draw_blend_mode = SDL2::BlendMode::NONE
    renderer.draw_color = [0, 0, 16*28]
  end

  def after_view
    super

    @frame_counter += 1
    renderer.present
  end
end

Base.prepend(WindowMethods)

# Base.run
```

実行してウィンドウが出ればOKです。

マジックナンバーが目立つけどほっときます。
クリエイティブコーディングはやや特殊でマジックナンバーだらけになりがちです。
これをとりあえずな感じで抽象化したり定数化しようとするとキリがなくなります。
抽象化や定数化するメリットがめちゃくちゃある場合にやっとするかしないかぐらいでよいです。

## 本当に書きたかったところ

```ruby
class App < Base
  def view
    r = 64
    w, h = window.size
    x = w / 2 + cos(PI * frame_counter * 0.03 * 0.7) * w * 0.4
    y = h / 2 + sin(PI * frame_counter * 0.03 * 0.8) * h * 0.4
    renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))
  end

  run
end
```

ミニフレームワークを適用して最初のコードがとてもシンプルになりました。

## ミニフレームワークの拡張

### FPS を見たいときは？

いま何フレームで動いているのか知りたかったら、次のようなモジュールを差し込みます。

```ruby
module FpsCounterMethods
  def setup
    super

    @real_fps = 60
    @fps_counter = 0
    @old_time = SDL2.get_ticks
  end

  def update
    super

    @fps_counter += 1
    v = SDL2.get_ticks
    t = v - @old_time
    if t >= 1000
      @real_fps = @fps_counter
      @old_time = v
      @fps_counter = 0
    end
  end
end

Base.prepend(FpsCounterMethods)
```

`@real_fps` が現在の秒間フレーム数です。

クラス化して処理を分けたことで上のように元のコードを変更せずに機能を追加できました。

なので例えばジョイスティックの状態を読み取って扱いやすい形にしておくなどもこのようにモジュール化して追加すればよいです。

ぱっと見、ミニフレームワーク内によくわからないインスタンス変数がばらまかれたのがいまいちなのでクラス化した方がよい気がしますが、それはいったん置いときます。

## 雑感

- [rsdl](https://rubygems.org/gems/rsdl/versions/0.1.2?locale=ja) が不要になったっぽい
  - Ruby/SDL 時代は ruby のかわりに rsdl で起動しないと動かなかった
  - わかっていてもこの罠にはまり続けた
- SGE まで不要になったっぽい
  - Ruby/SDL 時代は SGE を別途入れないとろくに描画できなかった
  - この SGE のインストールが激ムズ
  - どこからダウンロードしてくればいいのかもわからない
  - そのせいか Ruby/SDL 本体にこっそりバンドルされていた
    - ビルドオプションをつけると一緒にインストールできた
- 使いやすくなっている気がする
  - draw_color で色だけ指定できるところとか
  - PRESENTVSYNC だけで垂直同期とか
- Nannou とは立ち位置が大きく異なる
  - Nannou は
    - 終了や全画面化のキーバインディング設定済み
    - クリエイティブコーディングとやらをすぐに始められる
      - 範囲やベクトルのライブラリが超強力
      - フレームワークとしてどこに何を書くかが厳密に決まっている
  - Ruby/SDL は
    - すべてユーザーまかせ
      - Escape とか押しても終了しない
        - メインループ自体自分で書く
        - 面白半分に全画面にしたりするとバグったときPCを落とさないと復帰できなかったりする
      - FPS 値をすぐに知るメソッドがない
      - 領域を扱う便利クラスや強力なベクトルライブラリなどがない
      - どこに何を書くかが決まってない
      - フレームワークというよりバインディング
    - それがいい
