---
title: "Ruby/SDL2 ã“ã¨ã¯ã˜ã‚"
emoji: "ğŸ¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ruby", "SDL2", "SDL"]
published: true
---

## ã¯ã˜ã‚ã«

Ruby/SDL ã¯æ›´æ–°ã•ã‚Œãªã„ã‚‚ã®ã¨è«¦ã‚ã¦ã„ãŸã‚‰ã²ã£ãã‚Šã¨ [Ruby/SDL2](https://rubygems.org/gems/ruby-sdl2) ãŒå…¬é–‹ã•ã‚Œã¦ã„ãŸã®ã§ä½¿ã£ã¦ã¿ã‚‹ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¨ã‚Šã‚ãˆãš `~/src/ruby-sdl2-playground` ã«ä½œã‚‹ã€‚

```sh
#!/bin/sh
cd ~/src
rm -fr ruby-sdl2-playground
mkdir -p ruby-sdl2-playground
cd ruby-sdl2-playground
bundle init
bundle add ruby-sdl2 --require sdl2 --optimistic
bundle exec ruby -r sdl2 -e "p SDL2"

cat <<'EOF' > main.rb
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

120.times do
  SDL2::Event.poll
  renderer.present
end
EOF

bundle exec ruby main.rb
```

- `SDL2::Renderer::Flags::PRESENTVSYNC` ã‚’æŒ‡å®šã™ã‚‹ã¨å‚ç›´åŒæœŸã™ã‚‹

ä¸Šã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æµã›ã°æ¬¡ã®ã‚ˆã†ã« Window ã‚’2ç§’é–“è¡¨ç¤ºã™ã‚‹ã€‚

![window](/images/7170a5dc60c97b/window.png)

ã¡ãªã¿ã«æœ€å¾Œã®ã¨ã“ã‚ã®ãƒ«ãƒ¼ãƒ—ã‚’æ¬¡ã®ã‚ˆã†ã«5å›ã«ã—ãŸã‚‰ Window ãŒé–‹ã‹ãš6å›ã«ã—ãŸã‚‰é–‹ãæŒ™å‹•ã¯è¬ã€‚

```ruby
5.times do
  SDL2::Event.poll
  renderer.present
end
sleep(2)
```

ãƒªãƒã‚¸ãƒˆãƒªã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ `renderer.present` ã‚’å‘¼ã¶ã ã‘ã§ Window ãŒèµ·å‹•ã™ã‚‹æƒ³å®šã«ãªã£ã¦ã„ã‚‹ã®ã«ãªã‚“ã§ã ã‚ã†ï¼Ÿ (èª°ã‹æ•™ãˆã¦)

## ä½•ã‹å‹•ã‹ã—ã¦ã¿ã‚‹

```ruby
require "bundler/setup"
Bundler.require(:default)

SDL2.init(SDL2::INIT_EVERYTHING)
pos = SDL2::Window::POS_CENTERED
window = SDL2::Window.create("(title)", pos, pos, 640, 480, 0)
flags = 0
flags |= SDL2::Renderer::Flags::ACCELERATED
flags |= SDL2::Renderer::Flags::PRESENTVSYNC
renderer = window.create_renderer(-1, flags)

include Math

frame_counter = 0
loop do
  while ev = SDL2::Event.poll
    case ev
    when SDL2::Event::Quit
      exit
    when SDL2::Event::KeyDown
      case ev.scancode
      when SDL2::Key::Scan::ESCAPE
        exit
      when SDL2::Key::Scan::Q
        exit
      end
    end
  end

  renderer.draw_blend_mode = SDL2::BlendMode::BLEND
  renderer.draw_color = [0, 0, 64, 28]
  renderer.fill_rect(SDL2::Rect.new(0, 0, *window.size))

  renderer.draw_blend_mode = SDL2::BlendMode::NONE
  renderer.draw_color = [255, 255, 255]

  r = 64
  w, h = window.size
  x = w / 2 + cos(PI * frame_counter * 0.02 * 0.7) * w * 0.4
  y = h / 2 + sin(PI * frame_counter * 0.02 * 0.8) * h * 0.4
  renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))

  renderer.present
  frame_counter += 1
end
```

- `SDL2::Renderer::Flags::ACCELERATED` ã¯ãªã‚“ã¨ãªãå¼·ãã†ãªã®ã§å…¥ã‚Œã¦ã¿ãŸ

![lissajous](/images/7170a5dc60c97b/lissajous.gif)

<!-- ![lissajous](/images/7170a5dc60c97b/lissajous.png) -->

GIF ãªã®ã§ã‚«ã‚¯ã‚«ã‚¯ã—ã¦ã„ã‚‹ã‘ã©å®Ÿéš›ã¯ã¬ã‚‹ã¬ã‚‹ã—ã¦ã„ã‚‹ã€‚

## ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯åŒ–

ãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã‚‹ã‚µãƒ³ãƒ—ãƒ«ã¯ä¸Šã®ã‚ˆã†ã«ãƒ™ã‚¿æ›¸ããŒå¤šã„ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã¯ãƒ™ã‚¿æ›¸ãã®æ–¹ãŒä¸€ç›´ç·šã«å‡¦ç†ãŒè¿½ãˆã¦ã‚ã‹ã‚Šã‚„ã™ã„ã‘ã©ã€ãã®ã¾ã¾ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¶³ã—ã¦ã„ãã¨ä½•ãŒãªã‚“ã ã‹ã‚ã‹ã‚‰ãªããªã‚‹ã€‚
ãã‚Œã«åˆæœŸåŒ–å‡¦ç†ã‚„ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®šã®ã‚­ãƒ¼ã§æŠœã‘ã‚‹å‡¦ç†ã‚’æ¯å›æ›¸ããŸããªã„ã€‚
ãªã®ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å¿…è¦ãªã¨ã“ã‚ã ã‘æ›¸ãã‚ˆã†ã«ã™ã‚‹ã€‚

```ruby
require "bundler/setup"
Bundler.require(:default)

class Base
  include Math

  class << self
    def run(*args)
      new(*args).run
    end
  end

  def run
    setup
    loop do
      event_loop
      update
      before_view
      view
      after_view
    end
  end

  private

  def setup
    SDL2.init(SDL2::INIT_EVERYTHING)
  end

  def update
  end

  def view
  end

  def before_view
  end

  def after_view
  end

  def event_loop
    while ev = SDL2::Event.poll
      event_handle(ev)
    end
  end

  def event_handle(ev)
    case ev
    when SDL2::Event::Quit
      exit
    when SDL2::Event::KeyDown
      case ev.scancode
      when SDL2::Key::Scan::ESCAPE
        exit
      when SDL2::Key::Scan::Q
        exit
      end
    end
  end
end

# Base.run
```

â”€â”€ã¨ã—ã¦å‘¼ã³å‡ºã—é †åºã¨æœ€ä½é™å¿…è¦ãªå‡¦ç†ã ã‘æ›¸ã„ã¨ãã€‚
æŠ½è±¡ã‚¯ãƒ©ã‚¹ã ã‘ã© Window ãŒå‡ºãªã„ã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè¡Œã§ãã‚‹ã€‚

### Window ã®è¿½åŠ 

```ruby
module WindowMethods
  attr_accessor :window
  attr_accessor :renderer
  attr_accessor :frame_counter

  def setup
    super

    flags = 0
    # flags |= SDL2::Window::Flags::FULLSCREEN
    # flags |= SDL2::Window::Flags::FULLSCREEN_DESKTOP
    pos = SDL2::Window::POS_CENTERED
    @window = SDL2::Window.create("(Title)", pos, pos, 640, 480, flags)

    flags = 0
    flags |= SDL2::Renderer::Flags::ACCELERATED
    flags |= SDL2::Renderer::Flags::PRESENTVSYNC
    @renderer = @window.create_renderer(-1, flags)

    @frame_counter = 0
  end

  def before_view
    super

    renderer.draw_blend_mode = SDL2::BlendMode::BLEND
    renderer.draw_color = [0, 0, 64, 28]
    renderer.fill_rect(SDL2::Rect.new(0, 0, *@window.size))

    renderer.draw_blend_mode = SDL2::BlendMode::NONE
    renderer.draw_color = [255, 255, 255]
  end

  def after_view
    super

    @frame_counter += 1
    renderer.present
  end
end

Base.prepend WindowMethods

# Base.run
```

å®Ÿè¡Œã—ã¦ Window ãŒå‡ºã‚Œã°OK

ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ãŒç›®ç«‹ã¤ã‘ã©ã»ã£ã¨ãã€‚
æŠ½è±¡åŒ–ã—ãŸã‚Šå®šæ•°åŒ–ã—ãŸããªã£ã¦ãã‚‹ã‘ã©é€†ã«ã‚„ã‚‰ãªã„æˆ‘æ…¢ãŒå¤§åˆ‡ã§ã€ã‚„ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã¡ã‚ƒãã¡ã‚ƒã‚ã‚‹å ´åˆã«ã‚„ã£ã¨ã‚„ã‚‹ã‹ã‚„ã‚‰ãªã„ã‹ãã‚‰ã„ã§ã‚ˆã„ã€‚

## å®Œæˆ

```ruby
class App < Base
  def view
    super

    r = 64
    w, h = window.size
    x = w / 2 + cos(PI * frame_counter * 0.02 * 0.7) * w * 0.4
    y = h / 2 + sin(PI * frame_counter * 0.02 * 0.8) * h * 0.4
    renderer.fill_rect(SDL2::Rect.new(x - r, y - r, r * 2, r * 2))
  end

  run
end
```

ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚³ãƒ¼ãƒ‰ãŒã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ãŸã€‚
ã“ã“ã ã‘æ›¸ããŸã‹ã£ãŸã‚“ã™ã‚ˆã€‚

## ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ‹¡å¼µ

### ç§’é–“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’çŸ¥ã‚ŠãŸã„

```ruby
module FpsMethods
  attr_reader :fps

  def setup
    super

    @fps = 60
    @fps_counter = 0
    @old_ticks = SDL2.get_ticks
  end

  def update
    super

    @fps_counter += 1
    v = SDL2.get_ticks
    t = v - @old_ticks
    if t >= 1000
      @fps = @fps_counter
      @old_ticks = v
      @fps_counter = 0
      p fps
    end
  end
end

Base.prepend FpsMethods

# Base.run
```

ã‚¯ãƒ©ã‚¹åŒ–ã—ã¦å‡¦ç†ã‚’åˆ†ã‘ãŸã“ã¨ã§ä¸Šã®ã‚ˆã†ã«å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«æ©Ÿèƒ½ã‚’è¿½åŠ ã§ããŸã€‚

ãªã®ã§ä¾‹ãˆã°ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’èª­ã¿å–ã£ã¦æ‰±ã„ã‚„ã™ã„å½¢ã«ã—ã¦ãŠããªã©ã‚‚ã“ã®ã‚ˆã†ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ã¦è¿½åŠ ã™ã‚Œã°ã‚ˆã„ã€‚

ã±ã£ã¨è¦‹ã€ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å†…ã«ã‚ˆãã‚ã‹ã‚‰ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ãŒã°ã‚‰ã¾ã‹ã‚ŒãŸã®ãŒã„ã¾ã„ã¡ãªã®ã§ã‚¯ãƒ©ã‚¹åŒ–ã—ãŸæ–¹ãŒã‚ˆã„æ°—ãŒã™ã‚‹ã‘ã©ã€ãã‚Œã¯ã„ã£ãŸã‚“ç½®ã„ã¨ãã€‚

### ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã—ãŸã„

ä¸Šã§æ±‚ã‚ãŸç§’é–“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’ç”»é¢ä¸Šã«è¡¨ç¤ºã•ã›ã‚‹ã€‚

```ruby
require "pathname"

module FontMethods
  def setup
    super

    font_file = "~/Library/Fonts/Ricty-Regular.ttf"
    font_size = 32

    SDL2::TTF.init
    @font = SDL2::TTF.open(Pathname(font_file).expand_path.to_s, font_size)
    @font.kerning = true
  end

  def after_view
    system_line "#{frame_counter} #{fps}fps"

    super
  end

  def system_line(text)
    rect = SDL2::Rect.new(0, 0, *@font.size_text(text))

    renderer.draw_blend_mode = SDL2::BlendMode::NONE
    renderer.draw_color = [0, 0, 128]
    renderer.fill_rect(rect)

    font_color = [255, 255, 255]
    texture = renderer.create_texture_from(@font.render_blended(text, font_color))
    renderer.copy(texture, nil, rect)
  end
end

Base.prepend FontMethods

# Base.run
```

ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã™ã‚‹ã ã‘ã§ã“ã‚“ãªã«æ›¸ã‹ã‚“ã¨ã„ã‘ã‚“ã®ã‹ã£ã¦æ„Ÿã˜ã ã‘ã©ä½¿ã„ã‚„ã™ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ãŠã‘ã°ã‚ˆã•ãã†ã€‚

ã“ã‚Œã§å·¦ä¸Šã«ã‚«ã‚¦ãƒ³ã‚¿ã¨ç§’é–“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’è¡¨ç¤ºã§ããŸã€‚

![font](/images/7170a5dc60c97b/font.png)

### super ã ã‚‰ã‘ãªã®ãŒæ°—ã«ãªã‚‹

ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ Rails ã® before_action ã®ã‚ˆã†ãªãƒ–ãƒ­ãƒƒã‚¯ã«ç½®ãæ›ãˆã‚‹ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚

```ruby
require "active_support/callbacks"
require "active_support/core_ext/object/blank"

class Foo
  include ActiveSupport::Callbacks
  define_callbacks :view

  def self.view(*args, &block)
    set_callback(:view, *args, &block)
  end

  def run
    run_callbacks :view
  end

  view do
    p 1
  end
end

class Bar < Foo
  view do
    p 2
  end
  view do
    p 3
  end
end

Bar.new.run
# >> 1
# >> 2
# >> 3
```

view ã®å®šç¾©ãŒè¿½åŠ ã«ãªã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã€‚
ãŸã ã— super ã‚’å‘¼ã°ãšã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹é¸æŠã®ä½™åœ°ãŒãªããªã‚‹ã®ã§ä¸€é•·ä¸€çŸ­ã‚ã‚‹ã€‚
ãªã®ã§ãƒŸãƒ‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¸ã®é©ç”¨ã¯ã„ã£ãŸã‚“ç½®ã„ã¨ãã€‚

## ãƒ™ã‚¯ãƒˆãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã‚‹

x y ã‚’å€‹åˆ¥ã«è¨ˆç®—ã™ã‚‹ã®ãŒé¢å€’ãªã®ã§ãƒ™ã‚¯ãƒˆãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã‚‹ã€‚
ã¨ã‚Šã‚ãˆãš `gem search vector` ã§å‡ºã¦ããŸ vector2d ã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚

```sh:shell
bundle add vector2d
```

ã“ã‚“ãªæ„Ÿã˜ã§ä½¿ãˆã‚‹ã‚ˆã†ã ã€‚

```ruby
vec = Vector2d(3, 4)   # => Vector2d(3,4)
vec.x                  # => 3
vec.y                  # => 4
vec.length             # => 5.0
vec * 2                # => Vector2d(6,8)
vec * Vector2d(2, 2)   # => Vector2d(6,8)
vec + Vector2d(1, 1)   # => Vector2d(4,5)
vec.normalize.length   # => 1.0
vec.to_a               # => [3, 4]
```

ãŒã€ã“ã“ã§ç½ ãŒã‚ã£ãŸã€‚
ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ã¡ã‚ƒãã¡ã‚ƒé‡ã„ï¼

ã“ã‚“ãªæ•°å­¦ç³»ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã‚“ã‹ã¨ãã«é€Ÿåº¦ã‚’æ„è­˜ã—ã¦å®Ÿè£…ã—ã¦ãã‚Œã¦ã‚‹ã¨æ€ã†ã˜ã‚ƒã‚“ã€‚
ã ã‹ã‚‰ã€ã“ã®ã‚ã¨ã§ä½œã‚‹ãƒ‡ãƒ¢ãŒ 15 FPS ã«ãªã£ãŸåŸå› ãŒã¾ã•ã‹ Vector2d ã«ã‚ã‚‹ã¨ã¯ä¿¡ã˜ã‚‰ã‚Œã‚“ã‹ã£ãŸã€‚

Ruby ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã£ãŸã‘ã©ã€ã„ã¤ã®ã¾ã«ã‹å¤–éƒ¨ gem ã«ãªã£ã¦ã„ãŸ matrix (ã«å«ã¾ã‚Œã‚‹Vectorãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã¨é€Ÿåº¦ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚‹ã¨â”€â”€

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "matrix"
  gem "vector2d"
  gem "benchmark-ips"
end

Benchmark.ips do |x|
  x.report("Vector")   { Vector[2, 3] + Vector[4, 5]     }
  x.report("Vector2d") { Vector2d(2, 3) + Vector2d(4, 5) }
  x.compare!
end

# Warming up --------------------------------------
#               Vector    49.777k i/100ms
#             Vector2d     1.702k i/100ms
# Calculating -------------------------------------
#               Vector    493.319k (Â± 1.8%) i/s -      2.489M in   5.046831s
#             Vector2d     23.293k (Â±11.6%) i/s -    115.736k in   5.061193s
#
# Comparison:
#               Vector:   493319.3 i/s
#             Vector2d:    23293.3 i/s - 21.18x  (Â± 0.00) slower
```

ãªã‚“ã¨ 21.18 å€ã®é…ã•ã€‚
ä½•ã‚’ã‚„ã£ãŸã‚‰ã“ã‚“ãªã«é…ããªã‚‹ã®ã‹ã‚ã‹ã‚‰ãªã„ã‘ã©ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«å‘ã„ã¦ãªã„ã“ã¨ã ã‘ã¯ã‚ã‹ã‚‹ã€‚
ã˜ã‚ƒã‚ãªã‚“ã§ matrix ã‚’æœ€åˆã‹ã‚‰ä½¿ã‚ãªã‹ã£ãŸã‹ã¨ã„ã†ã¨ä½¿ã„ã¥ã‚‰ã„ã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‰ã€‚
ã§ã‚‚ã„ã„ã®ãŒãªã„ã®ã§ matrix ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚¯ãƒ©ã‚¹ã‚’æ”¹è‰¯ã—ã¦ã¿ã‚‹ã€‚
ã•ã£ãã® vector2d ã¯æ¶ˆã—ã¦ matrix ã‚’å…¥ã‚Œã‚ˆã†ã€‚

```sh:shell
bundle remove vector2d
bundle add matrix
```

```ruby
class Vector2d < Vector
  def +(v)
    if v.kind_of?(self.class)
      super
    else
      super(self.class[v, v])
    end
  end

  def -(v)
    if v.kind_of?(self.class)
      super
    else
      super(self.class[v, v])
    end
  end

  def *(v)
    if v.kind_of?(self.class)
      map2(v) { |a, b| a * b }
    else
      super
    end
  end

  def /(v)
    if v.kind_of?(self.class)
      map2(v) { |a, b| a / b }
    else
      super
    end
  end
end

def Vector2d(*args)
  Vector2d[*args]
end
```

ã§ããŸã€‚ä¸Šã®ã‚ˆã†ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸã®ã§æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```ruby
Vector2d(2, 3) + 1              # => Vector[3, 4]
Vector2d(2, 3) - 1              # => Vector[1, 2]
Vector2d(2, 3) * Vector2d(2, 3) # => Vector[4, 9]
Vector2d(2, 3) / Vector2d(2, 3) # => Vector[1, 1]
```

ã“ã‚Œã§ä½¿ã„ã‚„ã™ããªã£ãŸã¨ã¯ã„ãˆ matrix ã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ©Ÿèƒ½å„ªå…ˆã®å¤šæ¬¡å…ƒå¯¾å¿œç‰ˆãªã®ã§ã€é€Ÿåº¦é¢ã§ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ã¯å‘ã„ã¦ãªã„ã€‚
ä»Šå›ã¯ matrix ç‰ˆã‚’ä½¿ã†ã¨ã—ã¦ã‚‚ä»Šå¾Œã¯2Då°‚ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã«ç½®ãæ›ãˆãŸæ–¹ãŒã‚ˆã•ãã†ã€‚

ä»®ã«å®Ÿè£…ã—ã¦ã¿ã‚‹ã¨â”€â”€

```ruby
require "matrix"
require "benchmark/ips"

class MyVector
  attr_accessor :x, :y

  def initialize(x, y)
    @x, @y = x, y
  end

  def +(other)
    self.class.new(@x + other.x, @y * other.y)
  end
end

Benchmark.ips do |x|
  x.report("Vector")   { Vector[1, 2] + Vector[3, 4]             }
  x.report("MyVector") { MyVector.new(1, 2) + MyVector.new(3, 4) }
  x.compare!
end

# Warming up --------------------------------------
#               Vector    59.187k i/100ms
#             MyVector   138.991k i/100ms
# Calculating -------------------------------------
#               Vector    588.342k (Â±10.0%) i/s -      2.900M in   5.000701s
#             MyVector      1.371M (Â± 4.3%) i/s -      6.950M in   5.078438s
#
# Comparison:
#             MyVector:  1371388.1 i/s
#               Vector:   588342.3 i/s - 2.33x  (Â± 0.00) slower
```

2.33 å€é€Ÿããªã£ãŸã€‚

è¦ç‚¹
- vector2d ã¯ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©é…ã„
- matrix ã¯ vector2d ã‚ˆã‚Š 21.18 å€é€Ÿã„
- 2Då°‚ç”¨ã‚’è‡ªä½œã™ã‚Œã° matrix ã‚ˆã‚Š 2.33 å€é€Ÿããªã‚‹

## Tixy ã‚¯ãƒ­ãƒ¼ãƒ³ã®ãƒ™ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã¿ã‚‹

[Tixy](https://tixy.land/) (Creator: [@aemkei](https://twitter.com/aemkei)) ã¯çŸ­ã„ã‚³ãƒ¼ãƒ‰ã§ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ãã‚‹ã‚¯ãƒ¼ãƒ«ãªã‚µã‚¤ãƒˆã ã€‚
ãƒªã‚¹ãƒšã‚¯ãƒˆã®æ°—æŒã¡ã‚’æŒã£ã¦ã“ã‚Œã‚’ã¾ã­ã¦ã¿ã‚‹ã€‚

å…·ä½“çš„ã«ã¯

- Time
- Index (ã‚»ãƒ«ã®é€£ç•ª)
- x åº§æ¨™
- y åº§æ¨™

ã‚’å—ã‘ã¨ã£ã¦è¿”ã—ãŸ -1.0..1.0 ã®å€¤ã«å¿œã˜ã¦ã‚»ãƒ«ã®è‰²ã¨å¤§ãã•ãŒå¤‰ã‚ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ã€‚

```ruby
class TixyCloneApp < Base
  CELL_N = 16

  def setup
    super

    @window_rect    = Vector2d(*window.size)
    @cell_wh        = @window_rect * 1.0 / CELL_N
    @inner_top_left = @window_rect * 0.5 - @cell_wh * CELL_N * 0.5
  end

  def before_view
    renderer.draw_color = [0, 0, 0]
    renderer.clear
  end

  def view
    super

    time = SDL2.get_ticks.fdiv(1000)
    index = 0
    CELL_N.times do |y|
      CELL_N.times do |x|
        r = tixy_func(time, index, x, y)
        if r.nonzero?
          r = r.clamp(-1.0, 1.0)
          center = @inner_top_left + @cell_wh * Vector2d(x, y) + @cell_wh * 0.5
          radius = @cell_wh * 0.5 * r.abs * 0.95
          top_left = center - radius
          renderer.draw_color = tixy_color(r)
          renderer.fill_rect(SDL2::Rect.new(*top_left, *(radius * 2)))
        end
        index += 1
      end
    end
  end

  def tixy_func(t, i, x, y)
    sin(t - sqrt((x - 7.5)**2 + (y - 6)**2))
  end

  def tixy_color(v)
    if v.positive?
      v = 1.0
    else
      v = -1.0
    end
    c = v.abs * 255
    if v.positive?
      [c, c, c]
    else
      [c, 0, 0]
    end
  end

  run
end
```

![tixy_clone_base](/images/7170a5dc60c97b/tixy_clone_base.gif)

- `tixy_func` é–¢æ•°ã®ä¸­èº«ã‚’å¤‰ãˆã‚‹ã¨ã„ã‚ã‚“ãªæ¨¡æ§˜ã‚’è¡¨ç¾ã§ãã‚‹
- 16 * 16 = 256 å€‹ã® fill_rect ã‚’ã—ã¦ã‚‚60ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã¬ã‚‹ã¬ã‚‹å‹•ã„ã¦ã„ã‚‹

## ä½¿ã£ã¦ã¿ãŸæ‰€æ„Ÿ

- Window ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å‚ç›´åŒæœŸã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦å¬‰ã—ã„
  - Ruby/SDL ã ã¨ãªãœã‹ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ã¨ãã—ã‹å‚ç›´åŒæœŸã§ããªã‹ã£ãŸ
- [rsdl](https://rubygems.org/gems/rsdl) ãŒä¸è¦ã«ãªã£ã¦å¬‰ã—ã„
  - Ruby/SDL æ™‚ä»£ã¯ ruby ã®ã‹ã‚ã‚Šã« rsdl ã§èµ·å‹•ã—ãªã„ã¨å‹•ã‹ãªã‹ã£ãŸ
  - ã‚ã‹ã£ã¦ã„ã¦ã‚‚ã“ã®ç½ ã«ã¯ã¾ã‚Šç¶šã‘ãŸ
- SGE ãŒä¸è¦ã«ãªã£ã¦å¬‰ã—ã„
  - Ruby/SDL æ™‚ä»£ã¯ SGE ã‚’åˆ¥é€”å…¥ã‚Œãªã„ã¨ã‚ãã«æç”»ã§ããªã‹ã£ãŸ
  - ã“ã® SGE ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ¿€ãƒ ã‚º
    - ã©ã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚Œã°ã„ã„ã®ã‹ã‚‚ã‚ã‹ã‚‰ãªã„
      - ç¾åœ¨ã‚‚æ¶ˆæ¯ä¸æ˜
    - ã•ã‚‰ã«è¬ã®ãƒ‘ãƒƒãƒã‚’å½“ã¦ãªã„ã¨ã„ã‘ãªã„
  - ãã®ã›ã„ã‹ Ruby/SDL æœ¬ä½“ã«ã“ã£ãã‚Šãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ãŸ
    - ãƒ“ãƒ«ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸ
- ä½¿ã„ã‚„ã™ããªã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹
  - draw_color ã§è‰²ã ã‘æŒ‡å®šã§ãã‚‹ã¨ã“ã‚ã¨ã‹
  - PRESENTVSYNC ã ã‘ã§å‚ç›´åŒæœŸã¨ã‹
- é€Ÿããªã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹
  - Ruby/SDL ã§å‡¦ç†è½ã¡ã™ã‚‹æç”»æ•°ã§ã‚‚60ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç¶­æŒã—ã¦ã„ãŸ
- æ—¥æœ¬èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãªã•ãã†
- Nannou ã¨ã¯ç«‹ã¡ä½ç½®ãŒå¤§ããç•°ãªã‚‹
  - Nannou ã¯
    - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    - çµ‚äº†ã‚„å…¨ç”»é¢åŒ–ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šæ¸ˆã¿
    - ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã‚„ã‚‰ã‚’ã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹
    - ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã¡ã‚ƒãã¡ã‚ƒä½œã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹
    - é ˜åŸŸã‚’æ‰±ã†ã‚¯ãƒ©ã‚¹ã‚‚ä½œã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹
    - ã©ã“ã«ä½•ã‚’æ›¸ãã‹ãŒå³å¯†ã«æ±ºã¾ã£ã¦ã„ã‚‹
  - Ruby/SDL ã¯
    - ãƒ©ãƒƒãƒ‘ãƒ¼
    - ã™ã¹ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã‹ã›
      - Escape ã¨ã‹æŠ¼ã—ã¦ã‚‚çµ‚äº†ã—ãªã„
        - ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—è‡ªä½“è‡ªåˆ†ã§æ›¸ã
        - é¢ç™½åŠåˆ†ã«å…¨ç”»é¢ã«ã—ãŸã‚Šã™ã‚‹ã¨ãƒã‚°ã£ãŸã¨ãPCã‚’è½ã¨ã•ãªã„ã¨å¾©å¸°ã§ããªã‹ã£ãŸã‚Šã™ã‚‹
      - FPS å€¤ã‚’ã™ãã«çŸ¥ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒãªã„
      - ãƒ™ã‚¯ãƒˆãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„
      - é ˜åŸŸã‚’æ‰±ã†ä¾¿åˆ©ã‚¯ãƒ©ã‚¹ãŒãªã„
        - Rect ã¯ã‚ã‚‹ã‘ã©ã»ã¼ x, y, w, h ã‚’ä¿æŒã™ã‚‹ç¨‹åº¦ã®å½¹å‰²ã‚Š
      - ã©ã“ã«ä½•ã‚’æ›¸ãã‹ãŒæ±ºã¾ã£ã¦ãªã„
    - ãã‚ŒãŒã„ã„

## å‚ç…§

https://github.com/ohai/ruby-sdl2
http://ohai.github.io/ruby-sdl2/doc-en/
