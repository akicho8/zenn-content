---
title: "Panolens の使い方メモ"
emoji: "🖼"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Panolens", "画像", "VR"]
published: false
---

# インストール #

```shell
yarn remove three
yarn remove panolens
yarn add panolens
```

three.js がいるっていうから `yarn add three` したら変になったので three.js は panolens の依存に任せた方がいい

# いちばん簡単な表示の例  #

```vue
<template lang="pug">
.panolens_div(ref="panolens_div")
</template>

<script>
import * as PANOLENS from "panolens"
export default {
  mounted() {
    const panorama = new PANOLENS.ImagePanorama("https://i.imgur.com/wTCPouq.jpg")
    const viewer = new PANOLENS.Viewer({container: this.$refs.panolens_div})
    viewer.add(panorama)
  },
}
</script>

<style lang="sass">
.panolens_div
  width: 800px
  height: 600px
</style>
```

# スポット情報を表示する #

```javascript
const infospot = new PANOLENS.Infospot()
infospot.position.set(0, 0, -2000)  // (x, y, z)
panorama.add(infospot)
```

##### ラベルをつける場合 #####

```javascript
infospot.addHoverText("日本")
```

# Viewer のオプション #

Value が初期値というわけではない

| Key                | Value         | 意味                                                                 |
|--------------------|---------------|----------------------------------------------------------------------|
| container          | document.body | 描画する場所                                                         |
| controlBar         | false         | 左下コントローラーを表示しない                                       |
| controlButtons     | []            | 左下コントローラーの項目 ["fullscreen", "setting", "video"]          |
| autoHideControlBar | true          | 左下コントロールバー自動非表示にする (どのタイミングで？)            |
| autoHideInfospot   | false         | クリックしたときスポット情報を消さない (重要) ※後述                 |
| horizontalView     | true          | 水平カメラ制御のみ許可にする (上下の角度を変えられない)              |
| cameraFov          | 100           | Field Of View (=視野) 0:狭い 100:広い                                |
| reverseDragging    | true          | 操作に対してのカメラ移動を逆にする                                   |
| viewIndicator      | false         | 左上に計器を追加 (?)                                                 |
| indicatorSize      | 30            | 左上の計器サイズ                                                     |
| output             | "console"     | コントロールを押している間マウス位置のワールド座標をコンソールに表示 |

##### スマホVR向けの照準 #####

| Key               | Value | 意味                       |
|-------------------|-------|----------------------------|
| enableReticle     | true  | 画面中央に白点を配置して、 |
| dwellTime         | 1500  | 指定msヒットしたら、       |
| autoReticleSelect | true  | 自動で選択する             |

よくわからないが照準に合わせることでクリックしたことにするみたいな機能らしい

https://pchen66.github.io/panolens.js/docs/Viewer.html

# ジャイロセンサー対応 #

```javascript
viewer.toggleNextControl()
```

# output オプションに翻弄された件 #

  * `output: "console"` にしておくとコントロールキーを押している間だけコンソールに位置を表示してくれる
  * 要はそれを見て Infospot を登録するときに使ってね、という意図で作者が入れてくれているんだと思われる
  * それで済む人にとっては、わりと有用だと思う
  * しかし、利用者がというか私が本当に望んでいる機能は、クリックしたワールド座標を**イベント**で返してくれる機能だった
  * ここまでしてくれているならさすがに何かあるだろうと GitHub のコードを見てみると `output: "event"` にすると `position-output` イベントで座標を送ってくれる機能があった (公開されてる腐ったマニュアルには載ってない)

```javascript
viewer.addEventListener("position-output", e => console.log(e.position))
```

  * これだ！ と使ってみたらコントロールキーを押しつつマウスを動かすたびに発生する、何に使うのか理解しづらいイベントだった

# クリックした座標を求める #

組み込みの世界と違ってWEBの世界は自分が困っていることは他の人も困っているので、とくに枯れたライブラリの場合、ありがたいことにだいたいググれば解決策が出てくる

そこで見つけたこちらの Issue によると

https://github.com/pchen66/panolens.js/issues/160

自力で書けということだった

最新バージョンの `output: "console"` のロジックはこうなっているので

https://github.com/pchen66/panolens.js/blob/c90ffbc3f989b60196adc02f4ecf420e54f87528/src/viewer/Viewer.js#L1298-L1345

まんまコピペでこうしてみた

```javascript
import * as THREE from "three"

panorama.addEventListener("click", e => {
  const intersects = viewer.raycaster.intersectObject(viewer.panorama, true)
  if (intersects.length > 0) {
    const point = intersects[0].point.clone() // => Vector3 {x: 2572.0764633107765, y: 1892.102225883789, z: -3839.4888925916653}
    const converter = new THREE.Vector3(-1, 1, 1)
    const world = viewer.panorama.getWorldPosition(new THREE.Vector3())
    point.sub(world).multiply(converter)
    console.log(point)                        // => Vector3 {x: -2572.0764633107765, y: 1892.102225883789, z: -3839.4888925916653}
  }
})
```

何をしているのかさっぱりわからないが欲しい座標が取れたっぽいことだけはわかる

# クリックした座標に Infospot を表示する #

`console.log(point)` のところにこれを入れるとその位置に Infospot が出る

```javascript
const infospot = new PANOLENS.Infospot()
infospot.position.set(point.x, point.y, point.z)
panorama.add(infospot)
```

##### クリックする度に Infospot の表示がトグルする問題 #####

クリックによって消えた Infospot を元に戻す方法として昔は `toggleInfospotVisibility(false)` とする方法しかなかったのかもしれない
が、トグル機能自体を OFF にするオプションがあるのでそれを使う

```javascript
const viewer = new PANOLENS.Viewer({
  ...
  autoHideInfospot: false, // 画面をクリックするごとに Infospot の表示を切り替えない
})
```

ただし、これをやると `panorama.add(infospot)` としても Infospot が表示されくなる (不具合？)
とりあえず次のように `infospot.show()` を入れてみたら表示されたのでよしとする

```javascript
const infospot = new PANOLENS.Infospot()
infospot.position.set(point.x, point.y, point.z)
panorama.add(infospot)
infospot.show()
```

https://github.com/pchen66/panolens.js/issues/160#issuecomment-488075651
https://github.com/pchen66/panolens.js/issues/128

##### Infospot が重なってしまうのを回避する #####

```javascript
panorama.addEventListener("click", e => {
  if (e.intersects.length > 0) {
    console.log("重なっているので何もしない")
  } else {
    ...
  }
})
```

  * `e.intersects` に交差情報が配列で入っている
  * その要素の object 属性が Infospot のインスタンスになっている

# スポット情報をクリックしたときに何かする #

##### まずクリックに反応させる #####

```javascript
infospot.addEventListener("click", e => console.log(e.target))
```

* `e.target` が Infospot のインスタンス

##### どのスポット情報をクリックしたか判別する(方法1) #####

```javascript
const infospot = new PANOLENS.Infospot()
console.log(infospot.uuid)     // => "6DAC16D5-0ABE-4025-AFDC-0287471C0481"
infospot.position.set(0, 0, -2000)
infospot.addHoverText("A")
infospot.addEventListener("click", e => {
  console.log(e.target.uuid)   // => "6DAC16D5-0ABE-4025-AFDC-0287471C0481"
})
```

インスタンスを生成したときに `uuid` が入っているのでそれで判別する

https://threejs.org/docs/#api/en/core/Object3D.uuid

##### どのスポット情報をクリックしたか判別する(方法2) #####

```javascript
const infospot = new PANOLENS.Infospot()
infospot.userData.foo = 1        // 何を設定してもよい
infospot.position.set(0, 0, -2000)
infospot.addHoverText("A")
infospot.addEventListener("click", e => {
  console.log(e.target.userData) // => {foo: 1}
})
```

  * uuid を元に他に用意したデータを参照するのではなく Infospot のインスタンス自体にデータを登録できる仕組みがある
  * userData には何を設定してもよいのでそれを活用する手もある

https://threejs.org/docs/#api/en/core/Object3D.userData

# 本家 #

https://github.com/pchen66/panolens.js
