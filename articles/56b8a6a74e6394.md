---
title: "Rust製テキスト検索ツール ripgrep (rg) の使い方メモ"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ripgrep", "rg", "rust"]
published: false
---

たくさんある grep 系のツールのなかで [ripgrep](https://github.com/BurntSushi/ripgrep) はいちばん速いそうです。
速いといっても grep 系ツールはどれも十分に速いので速度にはあまり関心がないですが、Gitとの親和性がよく使いやすさの方が気にいっています。

# インストール #

```shell
cargo install ripgrep
```

  * 2022-07-18 での最新バージョンは 13.0.0

# オプション #

#### 表示の仕方 ####

| 表記                            | 意味                                                    |
|---------------------------------|---------------------------------------------------------|
| -C, --context <NUM>             | マッチした行の上下NUM行も表示                           |
| -A, --after-context <NUM>       | マッチした行の下NUM行も表示                             |
| -B, --before-context <NUM>      | マッチした行の上NUM行も表示                             |
| --context-separator <SEP>       | -A -B -C を使ったときの境目の '--' を変更できる         |
| --field-context-separator <SEP> | -A -B -C を使ったときのマッチしてない行の横の境目の変更 |

| 表記                          | 意味                                              |
|-------------------------------|---------------------------------------------------|
| -c, --count                   | マッチした**行数**を表示する                      |
| --count-matches               | マッチした**個数**を表示する                      |
| --include-zero                | マッチしないとき0を表示する                       |
| --with-filename               | 対象のファイルが1つのときでもファイル名を表示する |

| 表記                    | 意味                                                               |
|-------------------------|--------------------------------------------------------------------|
| -M, --max-columns <NUM> | 長過ぎる行を NUM で truncate する                                  |
| --max-columns-preview   | turncate しなかった部分は表示する (無効だと何も表示されなくて不便) |

| 表記                           | 意味                                                         |
|--------------------------------|--------------------------------------------------------------|
| --binary                       | バイナリファイルも見る                                       |
| -b, --byte-offset              |                                                              |
| -s, --case-sensitive           | 大文字小文字の違いを区別する                                 |
| --color <WHEN>                 | never なら全体で色を無効化                                   |
| --colors <COLOR_SPEC>...       | 'match:fg:cyan' ならマッチした部分が水色になる               |
| --column                       | カラム位置も表示する ファイル名:行:カラム                    |
| -o, --only-matching            | マッチした行ではなく部分だけ表示する                         |
| --crlf                         | 改行コードが \r\n なときでも $ が行末にマッチするようにする  |
| --debug                        | どの設定ファイルで何が有効になったか調べるときに使う         |
| --trace                        | さらにどこで何がマッチしたかみたいなのもわかる(開発者用)     |
| --dfa-size-limit <NUM+SUFFIX?> | 正規表現 DFA の上限の制限                                    |
| -E, --encoding <ENCODING>      | shift_jis のときは -E shift_jis とする                       |
| --engine <ENGINE>              | 正規表現のライブラリを明示する。知らなくていい               |
| --field-match-separator <SEP>  | 「ファイル名:行」の「:」の部分の変更                         |
| -f, --file <PATTERNFILE>...    | 指定のファイルからパターンを読み込む                         |
| --files                        | 検索は行わず、対象のファイル名を列挙する                     |
| -l, --files-with-matches       | マッチしたファイル名を表示する                               |
| --files-without-match          | マッチしなかったファイル名を表示する                         |
| -F, --fixed-strings            | パターンを正規表現としない                                   |
| -L, --follow                   | symlink 先を追う                                             |
| -g, --glob <GLOB>...           | 対象を glob 形式で書く (.gitignore の書き方と同じ)           |
| --glob-case-insensitive        | --glob のとき大文字小文字の区別をしない                      |
| --iglob                        | --glob --glob-case-insensitive と同じ                        |
| --heading                      | ファイル名とマッチした行を一緒に表示しない(デフォルト・不便) |
| -., --hidden                   | "." で始まるファイルやディレクトリも見る                     |
| -i, --ignore-case              | 大文字小文字を区別しない                                     |
| --ignore-file <PATH>...        | .gitignore 形式の別のファイルを指定する                      |
| --ignore-file-case-insensitive | ?                                                            |
| -v, --invert-match             | マッチしなかった行を表示する                                 |
| --line-buffered                |                                                              |
| --block-buffered               | 表示するとき1行単位ではなくバッファ単位にする                |
| -n, --line-number              | 行番号を表示する (デフォルト)                                |
| -x, --line-regexp              | 1行分マッチさせる foo が /foo/ でなく /^foo$/ になる         |

| 表記                         | 意味                                                 |
|------------------------------|------------------------------------------------------|
| -m, --max-count <NUM>        | ファイルごとに一致する行数を NUM に制限する          |
| --max-depth <NUM>            | ディレクトリの深さの制限                             |
| --max-filesize <NUM+SUFFIX?> | 100K なら 100KB 以下のファイルに制限する             |
| --mmap                       | 脆いが指定すると速くなるらしい(デフォルト)           |
| -U, --multiline              | 複数行に跨って検索できる "a\nb" には "a\nb" でマッチ |
| --multiline-dotall           | -U と合わせて指定すると "a\nb" に "a.b" でマッチする |
| --no-config                  | RIPGREP_CONFIG_PATH の先を読まない                   |
| -I, --no-filename            | ファイル名を表示しない                               |
| --no-heading                 | ファイル名をマッチした行と一緒に表示する(おすすめ)   |

| --no-ignore                      | なんとか ignore や exclude を全部を無視する                          |
| --no-ignore-dot                  | .ignore を無視する                                                   |
| --no-ignore-exclude              | .git/info/exclude を無視する                                         |
| --no-ignore-files                | --ignore-file の指定を無視する                                       |
| --no-ignore-global               | $HOME/.config/git/ignore の指定を無視する                            |
| --no-ignore-messages             |                                                                      |
| --no-ignore-parent               | 先祖ディレクトリにある ignore 系ファイルを無視する                   |
| --no-ignore-vcs                  | Git管理下の除外設定を無視する                                        |
| -N, --no-line-number             | 行番号を表示しない                                                   |
| --no-messages                    | ファイルの読み取り時のエラーを表示しない                             |
| --no-mmap                        | 高速になる可能性があってもメモリマップを使わない                     |
| --no-require-git                 |                                                                      |
| --no-unicode                     | 指定すると日本語が使えなくなる                                       |
| -0, --null                       | ファイル名の後で NUL を入れる。xargs -0 用                           |
| --null-data                      | マッチしたファイル全体を表示し、最後に NUL を入れる                  |
| --one-file-system                | ファイルシステムを跨がない                                           |
| --passthru                       | マッチしてない部分も全部表示する。行番号の後がハイフンになる         |
| --path-separator <SEP>           | 表示する際のパスの '/' を変更できる                                  |
| -P, --pcre2                      | 正規表現エンジンを PCRE2 に切り替える                                |
| --pcre2-version                  | ?                                                                    |
| --pre <COMMAND>                  | 事前に COMMAND を噛ます。PDFやExcelをテキスト化するなど。            |
| --pre-glob <GLOB>...             | --pre で指定のコマンドに送るファイルを絞る '*.pdf' など              |
| -p, --pretty                     | --color always --heading --line-number の一括指定                    |
| -q, --quiet                      | 何も表示しない                                                       |
| --regex-size-limit <NUM+SUFFIX?> | コンパイルされた正規表現のサイズ制限。知らなくていい                 |
| -e, --regexp <PATTERN>...        | 次の引数が正規表現であると明示できるので -- -foo を -e -foo と書ける |
| -r, --replace <REPLACEMENT_TEXT> | マッチした部分を置換して表示をする (ファイルを更新するわけじゃない)  |
| -z, --search-zip                 | 圧縮ファイルの中も見る                                               |
| -S, --smart-case                 | foo なら /foo/i で Foo なら /Foo/ で検索                             |
| --sort <SORTBY>                  | 並び替え none path modified accessed created                         |
| --sortr <SORTBY>                 | 並び替え 逆順                                                        |
| --stats                          | 何件中、いくつマッチしたかなどの情報を追加表示する                   |
| --json                           | JSON 形式で表示                                                      |
| -a, --text                       | バイナリファイルもテキストと見なす (なんのメリットが？)              |
| -j, --threads <NUM>              | スレッド数の指定。知らなくていい                                     |
| --trim                           | 表示の際に左側のスペースを取る。Ruby の lstrip 相当                    |

    -t, --type <TYPE>...
            Only search files matching TYPE. Multiple type flags may be provided. Use the
            --type-list flag to list all available types.

            This flag supports the special value 'all', which will behave as if --type
            was provided for every file type supported by ripgrep (including any custom
            file types). The end result is that '--type all' causes ripgrep to search in
            "whitelist" mode, where it will only search files it recognizes via its type
            definitions.

        --type-add <TYPE_SPEC>...
            Add a new glob for a particular file type. Only one glob can be added at a
            time. Multiple --type-add flags can be provided. Unless --type-clear is used,
            globs are added to any existing globs defined inside of ripgrep.

            Note that this MUST be passed to every invocation of ripgrep. Type settings are
            NOT persisted. See CONFIGURATION FILES for a workaround.

            Example:

                rg --type-add 'foo:*.foo' -tfoo PATTERN.

            --type-add can also be used to include rules from other types with the special
            include directive. The include directive permits specifying one or more other
            type names (separated by a comma) that have been defined and its rules will
            automatically be imported into the type specified. For example, to create a
            type called src that matches C++, Python and Markdown files, one can use:

                --type-add 'src:include:cpp,py,md'

            Additional glob rules can still be added to the src type by using the
            --type-add flag again:

                --type-add 'src:include:cpp,py,md' --type-add 'src:*.foo'

            Note that type names must consist only of Unicode letters or numbers.
            Punctuation characters are not allowed.

        --type-clear <TYPE>...
            Clear the file type globs previously defined for TYPE. This only clears the
            default type definitions that are found inside of ripgrep.

            Note that this MUST be passed to every invocation of ripgrep. Type settings are
            NOT persisted. See CONFIGURATION FILES for a workaround.

        --type-list
            Show all supported file types and their corresponding globs.

    -T, --type-not <TYPE>...
            Do not search files matching TYPE. Multiple type-not flags may be provided. Use
            the --type-list flag to list all available types.

    -u, --unrestricted
            Reduce the level of "smart" searching. A single -u won't respect .gitignore
            (etc.) files (--no-ignore). Two -u flags will additionally search hidden files
            and directories (-./--hidden). Three -u flags will additionally search binary
            files (--binary).

            'rg -uuu' is roughly equivalent to 'grep -r'.

    -V, --version
            Prints version information

        --vimgrep
            Show results with every match on its own line, including line numbers and
            column numbers. With this option, a line with more than one match will be
            printed more than once.

    -H, --with-filename
            Display the file path for matches. This is the default when more than one
            file is searched. If --heading is enabled (the default when printing to a
            terminal), the file path will be shown above clusters of matches from each
            file; otherwise, the file name will be shown as a prefix for each matched line.

            This flag overrides --no-filename.

    -w, --word-regexp
            Only show matches surrounded by word boundaries. This is roughly equivalent to
            putting \b before and after all of the search patterns.

            This overrides the --line-regexp flag.

#

# はまりがちなこと #

#### ~/.ripgreprc を置いたのに読んでないっぽい ####

export RIPGREP_CONFIG_PATH=$HOME/.ripgreprc

ホーム以下にドットファイルをぶちまけるという規約を

#### Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis あ a.txt
```

#### それでも Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis 'あ$' --crlf a.txt
```

改行コードだと \r\n だと $ が改行にマッチしない問題

```shell
$ ruby -e '"foo\r\n".display' > a.txt
$ rg 'foo$' a.txt
$ rg 'foo$' a.txt --crlf
1:foo
```

#### *.min.js にマッチしてしまい端末が大変なことになった ####

--max-columns=128

#### 128文字超えた行が何も表示されない ####

--max-columns=128 --max-columns-preview

# 実用例 #

#### 拡張子が png の怪しいファイルのヘッダに PNG が含まれるか確認する ####

```shell
$ rg PNG image.png
image.png: binary file matches (found "\0" byte around offset 8)
```

  * デフォルトで --binary オプションが有効なのでバイナリファイルも見れる
  * file コマンドでいい気がした

#### 常に PDF 内のテキストを検索する ####

```shell
```

#### --stats で表示される情報を取り込みたい ####

```shell
```

--json

