---
title: "Rust製テキスト検索ツール ripgrep (rg) の使い方メモ"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ripgrep", "rg", "rust"]
published: false
---

https://github.com/BurntSushi/ripgrep

# インストール #

```shell
cargo install ripgrep
```

  * 2022-07-18 での最新バージョンは 13.0.0

# オプション #

#### 検索パターンの解釈 ####

| 表記                 | 意味                                                 |
|----------------------|------------------------------------------------------|
| -i, --ignore-case    | 大文字小文字を区別しない /foo/i                      |
| -s, --case-sensitive | 大文字小文字を区別する /foo/                         |
| -w, --word-regexp    | 単語とみなす /\bfoo\b/                               |
| -S, --smart-case     | 大文字が含まれるときだけ /Foo/i ではなく /Foo/       |
| -x, --line-regexp    | 1行分マッチさせる foo が /^foo$/ になる              |
| -U, --multiline      | 複数行に跨って検索できる "a\nb" には "a\nb" でマッチ |
| --multiline-dotall   | -U と合わせて指定すると "a\nb" に "a.b" でマッチする |
| -F, --fixed-strings  | 正規表現としない                                     |

#### 結果表示の方法 ####

| 表記                     | 意味                                                    |
|--------------------------|---------------------------------------------------------|
| --no-heading             | ファイル名をマッチした行と一緒に表示する(必須)          |
| -l, --files-with-matches | マッチしたファイル名だけ列挙する                        |
| -m, --max-count <N>      | ファイルごとに一致する行数を N に制限する               |
| -n, --line-number        | 行番号を表示する (デフォルト)                           |
| -H, --with-filename      | 1つのファイルを指定しているときでもファイル名を表示する |
| --trim                   | 表示の際に左側のスペースを取る。Ruby の lstrip 相当     |
| -q, --quiet              | 何も表示しない                                          |

#### 結果表示の方法 (めったに使わない) ####

| 表記                          | 意味                                                       |
|-------------------------------|------------------------------------------------------------|
| -I, --no-filename             | ファイル名を表示しない                                     |
| --heading                     | ファイル名を一緒に表示しない (デフォルトかつ不便)          |
| --column                      | カラム位置も表示する ファイル名:行:**カラム**              |
| --files-without-match         | マッチしなかったファイル名だけ列挙する                     |
| -v, --invert-match            | マッチしなかった行を表示する                               |
| -N, --no-line-number          | 行番号を表示しない                                         |
| -o, --only-matching           | マッチした行ではなくマッチした箇所だけ表示する             |
| -p, --pretty                  | --color always --heading --line-number の一括指定。less 用 |
| --vimgrep                     | 1行でN回マッチしたらカラム位置情報と合わせてN行分表示する  |
| --path-separator <SEP>        | 表示する際のパスの '/' を変更できる                        |
| --field-match-separator <SEP> | 「ファイル名:行」の「:」の部分の変更                       |

#### マッチした数を表示する ####

| 表記            | 意味                                              |
|-----------------|---------------------------------------------------|
| -c, --count     | マッチした行数を表示する                          |
| --count-matches | マッチした個数を表示する                          |
| --include-zero  | マッチしないときでも0を表示する                   |

#### 長すぎる一行を途中で切る ####

| 表記                  | 意味                               |
|-----------------------|------------------------------------|
| -M, --max-columns <N> | N 文字以上なら一行まるごと省略する |
| --max-columns-preview | N 文字分は表示する                 |

  * --max-columns だけだと一行がまるごと省略メッセージに置き換わってしまう
  * --max-columns-preview も指定すると「途中で切る」になる
  * `*.min.js` にマッチして大変な目に合わないようにデフォルトで指定しておきたい

#### WIP:バイナリファイルの扱い ####

#### 対象のファイルをGLOB形式で書く ####

| 表記                    | 意味                                      |
|-------------------------|-------------------------------------------|
| -g, --glob <GLOB>...    | 対象をGLOB形式で書く                      |
| --glob-case-insensitive | --glob のとき、大文字小文字の区別をしない |
| --iglob                 | --glob --glob-case-insensitive と同じ     |

`rg foo *.rb` と書いてもGLOB形式だけど、これはカレントディレクトリだけの `*.rb` を対象として、シェルが展開してしまうので -g とはかなり動作が異なる

#### 対象を広げる ####

| 表記             | 意味                   |
|------------------|------------------------|
| -L, --follow     | symlink 先を追う       |
| -z, --search-zip | 圧縮ファイルの中も見る |

#### ファイル容量やディレクトリの深さで制限する ####

| 表記                       | 意味                                   |
|----------------------------|----------------------------------------|
| --max-filesize <N+SUFFIX?> | 100K なら 100KB 以下のファイルだけ見る |
| --max-depth <N>            | ディレクトリの深さ N までしか潜らない  |
| --one-file-system          | ファイルシステムを跨がない             |

#### さらに除外する ####

| 表記                           | 意味                                     |
|--------------------------------|------------------------------------------|
| --ignore-file <PATH>...        | .gitignore 形式の別のファイルを指定する  |
| --ignore-file-case-insensitive | ?                                        |

#### 除外条件を緩くする ####

| 表記                 | 意味                                               |
|----------------------|----------------------------------------------------|
| -u, --unrestricted   | -u -uu -uuu と増やす度に制限が緩くなる             |
| --no-ignore          | なんとか ignore や exclude を全部を無視する        |
| -., --hidden         | "." で始まるファイルやディレクトリも見る           |
| --no-ignore-dot      | .ignore を無視する                                 |
| --no-ignore-exclude  | .git/info/exclude を無視する                       |
| --no-ignore-files    | --ignore-file の指定を無視する                     |
| --no-ignore-global   | $HOME/.config/git/ignore の指定を無視する          |
| --no-ignore-parent   | 先祖ディレクトリにある ignore 系ファイルを無視する |
| --no-ignore-vcs      | Git管理下の除外設定を無視する                      |
| --no-ignore-messages | ?                                                  |

#### ファイルのグループ化 ####

| 表記                      | 意味                                         |
|---------------------------|----------------------------------------------|
| --type-list               | 事前にグループ化されているキーを確認する     |
| -t, --type <TYPE>...      | -t ruby なら Ruby に関連するファイルを探す   |
| -T, --type-not <TYPE>...  | -T ruby なら Ruby に関連しないファイルを探す |
| --type-add <TYPE_SPEC>... | 登録 'ruby*.rb,Rakefile'                     |
| --type-clear <TYPE>...    | 削除                                         |

  * コマンドラインで使うのは基本 `-t` だけ
  * 初期設定ファイルであらかじめ登録しておく

#### 文字コードがらみ ####

| 表記                      | 意味                                                        |
|---------------------------|-------------------------------------------------------------|
| -E, --encoding <ENCODING> | Shift_JIS のときは -E shift_jis とする                |
| --crlf                    | 改行が `\r\n` なときでも `$` が行末にマッチするようになる |

本来 `$` で `\r\n` にマッチするはずの正規表現エンジンが対応していないので、仕方なく ripgrep 側で `--crlf` オプションを用意しているらしい

結局 Windows なファイルには `-E shift_jis --crlf` としないといけない

#### 事前に別のコマンドを噛ます ####

| 表記                 | 意味                                                      |
|----------------------|-----------------------------------------------------------|
| --pre <COMMAND>      | 事前に COMMAND を噛ます。PDFやExcelをテキスト化するなど。 |
| --pre-glob <GLOB>... | --pre で指定のコマンドに送るファイルを絞る '*.pdf' など   |

#### 上下余分に表示する ####

| 表記                            | 意味                                      |
|---------------------------------|-------------------------------------------|
| -B, --before-context <N>        | マッチした行の上 N 行も表示する           |
| -A, --after-context <N>         | マッチした行の下 N 行も表示する           |
| -C, --context <N>               | マッチした行の上下 N 行も表示する         |
| --context-separator <SEP>       | 塊と塊の間の -- を変更する                |
| --field-context-separator <SEP> | 余分に表示した行の横の境目の - を変更する |

#### ファイル名の並び替え ####

| 表記             | 意味 |
|------------------|------|
| --sort <SORTBY>  | 正順 |
| --sortr <SORTBY> | 逆順 |

`none path modified accessed created` が指定できる

#### 検証用 ####

| 表記    | 意味                                                               |
|---------|--------------------------------------------------------------------|
| --files | 対象のファイルをすべて列挙する。そもそもファイル見てんのか？な時用 |
| --debug | どの設定ファイルで何が有効になったか調べるときに使う               |
| --trace | どこで何がマッチしたかみたいなのもわかる(開発者用)                 |

#### 統計表示 ####

| 表記    | 意味                                           |
|---------|------------------------------------------------|
| --stats | 何件中何個マッチしたかなどの情報を追加表示する |
| --json  | JSON 形式で表示                                |

  * --stats の情報をプログラムで読み取るなら --json をつけた方がいい
  * --json は --stats 専用ってわけじゃない

#### 色 ####

| 表記                     | 意味                                           |
|--------------------------|------------------------------------------------|
| --color <WHEN>           | never なら OFF                                 |
| --colors <COLOR_SPEC>... | 'match:fg:cyan' ならマッチした部分が水色になる |

#### 正規表現関連 ####

| 表記                         | 意味                           |
|------------------------------|--------------------------------|
| --engine <ENGINE>            | 正規表現のライブラリを明示する |
| -P, --pcre2                  | PCRE2 に切り替える             |
| --pcre2-version              | ?                              |
| --dfa-size-limit <N+SUFFIX?> | 正規表現 DFA の上限の制限      |

  * ビルドの時点で PCRE2 を含めてないと切り替えられなかったので検証できなかった
  * PCRE は Perl で使われている正規表現ライブラリらしい

#### 知らなくてよさそうなやつ ####

| 表記              | 意味                                             |
|-------------------|--------------------------------------------------|
| --mmap            | 脆いが指定すると速くなるらしい (デフォルト)      |
| --no-mmap         | 高速化の余地があってもメモリマップを使わない              |
| -j, --threads <N> | スレッド数の指定                                 |
| --no-unicode      | 指定すると日本語が使えなくなる                   |

#### いまいち用途がわからないやつ ####

| 表記                      | 意味                                                      |
|---------------------------|-----------------------------------------------------------|
| --null-data               | マッチしたファイル全体を表示し、最後に NUL を入れる       |
| -r, --replace <TEXT>      | マッチした箇所を置換表示する (更新してくれるわけじゃない) |
| --passthru                | マッチしてない部分も全部表示する                          |
| --regex-size-limit <N+S?> | コンパイルされた正規表現のサイズ制限。知らなくていい      |

#### その他 ####

| 表記                          | 意味                                                                 |
|-------------------------------|----------------------------------------------------------------------|
| --no-config                   | RIPGREP_CONFIG_PATH の先を読まない                                   |
| --binary                      | バイナリファイルも見る (ただし NUL が来るまで)                       |
| -a, --text                    | バイナリファイルもテキストと見なす (なんのメリットが？)              |
| -b, --byte-offset             |                                                                      |
| -f, --file <PATTERNFILE>...   | 指定のファイルからパターンを読み込む                                 |
| --line-buffered               |                                                                      |
| --block-buffered              | 表示するとき1行単位ではなくバッファ単位にする                        |
| --no-messages                 | ファイルの読み取り時のエラーを表示しない                             |
| --no-require-git              |                                                                      |
| -0, --null                    | ファイル名の後で NUL を入れる。xargs -0 用                           |
| -e, --regexp <PATTERN>...     | 次の引数が正規表現であると明示できるので -- -foo を -e -foo と書ける |

# はまりがちなこと #

#### ~/.ripgreprc を置いたのに読んでないっぽい ####

export RIPGREP_CONFIG_PATH=$HOME/.ripgreprc

ホーム以下にドットファイルをぶちまけるという規約を

#### Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis あ a.txt
```

#### それでも Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis 'あ$' --crlf a.txt
```

改行コードだと \r\n だと $ が改行にマッチしない問題

```shell
$ ruby -e '"foo\r\n".display' > a.txt
$ rg 'foo$' a.txt
$ rg 'foo$' a.txt --crlf
1:foo
```

#### *.min.js にマッチしてしまい端末が大変なことになった ####

--max-columns=128

#### 128文字超えた行が何も表示されない ####

--max-columns=128 --max-columns-preview

#### ときどきファイル名が表示されない ####

  * 引数にファイルを1つ指定すると表示の際にファイル名を省略する
  * これはファイル数が変更する場合に困る
  * 1件でも2件でも同じように読み取りたいプログラムがあったとき1件だとバグる
  * 常にファイル名を表示するには `--with-filename` とする

#### --binary オプションが常に効いている？ ####

  * `rg --binary PNG` とすると `--binary` があるので png ファイルにマッチする
    * ヘッダ内のPNG文字列がマッチする
  * ところが `rg PNG foo.png` としても `--binary` を指定していないのにマッチする
  * これは探したファイルと明示的に指定されたファイルとでは扱いが異なるため
  * 明示的に指定されたファイルはデフォルトの除外ルールが省かれる
  * なので --binary は効いてなくても foo.png は対象になる
  * このように従来の不親切なツールに慣れていると、親切な仕様に戸惑うことがある

# 実用例 #

#### マッチしすぎるときの応手 ####

| Command              | 意味                                       |
|----------------------|--------------------------------------------|
| rg foo -t ruby       | 種類で絞る                                 |
| rg foo -g '*.rb'     | 拡張子で絞る                               |
| rg foo -g '\*user\*' | user が含まれるファイル名に絞る            |
| rg foo -m 3          | 1つのファイルにつき表示は3行だけにする     |
| rg foo -c            | ファイルとマッチした行数だけにする         |
| rg foo -l            | もうファイル名だけでいい                   |
| rg foo --max-depth 1 | ファイル名も多いので孫ディレクトリはみない |
| rg foo -q            | 何も表示しない                             |

#### 拡張子が png なのにヘッダに PNG が含まれない偽画像ファイルを探す ####

```shell
rg --files-without-match --binary -g '*.png' PNG
```

  * --binary オプションをつけると画像ファイルも読む

#### PDF 内のテキストを検索する ####

ちょっと面倒だけど、あらかじめPDFからテキストに変換するコマンドを用意しておく

```shell:~/bin/rg-processor
#!/bin/sh
exec pdftotext - -
```

として `~/bin/rg-processor something.pdf` でテキストが表示されればOK
次にコマンドを `--pre` に指定する

```shell
rg --pre ~/bin/rg-processor --pre-glob '*.pdf' foo
```

さらに `--pre-glob '*.pdf'` でPDF以外のファイルがプリプロセッサに渡るのを防ぐ
このあたり、わりとややこしいので本家の説明を読む

https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md#preprocessor

#### --stats で表示される情報を取り込みたい ####

```shell
```

--json

#### include ####

rg --type-add xxx:include:c,ruby -t xxx foo2

#### 結果を less する ####

```ruby
rg -p foo | less -R
```
