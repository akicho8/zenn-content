---
title: "Rust製テキスト検索ツール ripgrep (rg) の使い方メモ"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ripgrep", "rg", "rust"]
published: false
---

https://github.com/BurntSushi/ripgrep

# インストール #

```shell
cargo install ripgrep
```

  * 2022-07-18 での最新バージョンは 13.0.0

# オプション #

#### 検索パターンの解釈 ####

| 表記                 | 意味                                           |
|----------------------|------------------------------------------------|
| -i, --ignore-case    | 大文字小文字を区別しない /foo/i                |
| -s, --case-sensitive | 大文字小文字を区別する /foo/                   |
| -w, --word-regexp    | 単語とみなす /\bfoo\b/                         |
| -S, --smart-case     | 大文字が含まれるときだけ /Foo/i ではなく /Foo/ |
| -F, --fixed-strings  | 正規表現としない                               |

#### 表示方法 ####

| --trim | 表示の際に左側のスペースを取る。Ruby の lstrip 相当 |

#### 長すぎる一行を途中で切る ####

| 表記                  | 意味                               |
|-----------------------|------------------------------------|
| -M, --max-columns <N> | N 文字以上なら一行まるごと省略する |
| --max-columns-preview | N 文字分は表示する                 |

  * --max-columns だけだと一行がまるごと省略メッセージに置き換わってしまう
  * --max-columns-preview も指定すると「途中で切る」になる
  * `*.min.js` にマッチして大変な目に合わないようにデフォルトで指定しておきたい

#### 上下余分に表示する ####

| 表記                            | 意味                                      |
|---------------------------------|-------------------------------------------|
| -B, --before-context <N>        | マッチした行の上 N 行も表示する           |
| -A, --after-context <N>         | マッチした行の下 N 行も表示する           |
| -C, --context <N>               | マッチした行の上下 N 行も表示する         |
| --context-separator <SEP>       | 塊と塊の間の -- を変更する                |
| --field-context-separator <SEP> | 余分に表示した行の横の境目の - を変更する |

#### マッチした数を表示する ####

| 表記            | 意味                                              |
|-----------------|---------------------------------------------------|
| -c, --count     | マッチした行数を表示する                          |
| --count-matches | マッチした個数を表示する                          |
| --include-zero  | マッチしないときでも0を表示する                   |

#### WIP:バイナリファイルの扱い ####

#### 色 ####

| 表記                     | 意味                                           |
|--------------------------|------------------------------------------------|
| --color <WHEN>           | never なら OFF                                 |
| --colors <COLOR_SPEC>... | 'match:fg:cyan' ならマッチした部分が水色になる |

| 表記                           | 意味                                                         |
|--------------------------------|--------------------------------------------------------------|
| --binary                       | バイナリファイルも見る (ただし NUL が来るまで)               |
| -b, --byte-offset              |                                                              |
| --column                       | カラム位置も表示する ファイル名:行:カラム                    |
| -o, --only-matching            | マッチした行ではなく部分だけ表示する                         |
| --debug                        | どの設定ファイルで何が有効になったか調べるときに使う         |
| --trace                        | さらにどこで何がマッチしたかみたいなのもわかる(開発者用)     |
| --dfa-size-limit <N+SUFFIX?>   | 正規表現 DFA の上限の制限                                    |
| --engine <ENGINE>              | 正規表現のライブラリを明示する。知らなくていい               |
| --field-match-separator <SEP>  | 「ファイル名:行」の「:」の部分の変更                         |
| -f, --file <PATTERNFILE>...    | 指定のファイルからパターンを読み込む                         |
| --files                        | 検索は行わず、対象のファイル名を列挙する                     |
| -l, --files-with-matches       | マッチしたファイル名だけ列挙する                             |
| --files-without-match          | マッチしなかったファイル名だけ列挙する                       |
| -L, --follow                   | symlink 先を追う                                             |
| --heading                      | ファイル名とマッチした行を一緒に表示しない(デフォルト・不便) |
| -., --hidden                   | "." で始まるファイルやディレクトリも見る                     |
| --ignore-file <PATH>...        | .gitignore 形式の別のファイルを指定する                      |
| --ignore-file-case-insensitive | ?                                                            |
| -v, --invert-match             | マッチしなかった行を表示する                                 |
| --line-buffered                |                                                              |
| --block-buffered               | 表示するとき1行単位ではなくバッファ単位にする                |
| -n, --line-number              | 行番号を表示する (デフォルト)                                |
| -x, --line-regexp              | 1行分マッチさせる foo が /foo/ でなく /^foo$/ になる         |

#### 対象のファイルをGLOB形式で書く ####

| 表記                    | 意味                                      |
|-------------------------|-------------------------------------------|
| -g, --glob <GLOB>...    | 対象をGLOB形式で書く                      |
| --glob-case-insensitive | --glob のとき、大文字小文字の区別をしない |
| --iglob                 | --glob --glob-case-insensitive と同じ     |

`rg foo *.rb` と書いてもGLOB形式だけど、これはカレントディレクトリだけの `*.rb` を対象として、シェルが展開してしまうので -g とはかなり動作が異なる

#### 検証用 ####

| 表記    | 意味                                                               |
|---------|--------------------------------------------------------------------|
| --files | 対象のファイルをすべて列挙する。そもそもファイル見てんのか？な時用 |

#### ファイルのグループ化 ####

| 表記                      | 意味                                         |
|---------------------------|----------------------------------------------|
| --type-list               | 事前にグループ化されているキーを確認する     |
| -t, --type <TYPE>...      | -t ruby なら Ruby に関連するファイルを探す   |
| -T, --type-not <TYPE>...  | -T ruby なら Ruby に関連しないファイルを探す |
| --type-add <TYPE_SPEC>... | 登録 'ruby*.rb,Rakefile'                     |
| --type-clear <TYPE>...    | 削除                                         |

  * コマンドラインで使うのは基本 `-t` だけ
  * 初期設定ファイルであらかじめ登録しておく

| 表記                         | 意味                                                 |
|------------------------------|------------------------------------------------------|
| -m, --max-count <N>        | ファイルごとに一致する行数を N に制限する          |
| --max-depth <N>            | ディレクトリの深さの制限                             |
| --max-filesize <N+SUFFIX?> | 100K なら 100KB 以下のファイルに制限する             |
| -U, --multiline              | 複数行に跨って検索できる "a\nb" には "a\nb" でマッチ |
| --multiline-dotall           | -U と合わせて指定すると "a\nb" に "a.b" でマッチする |
| --no-config                  | RIPGREP_CONFIG_PATH の先を読まない                   |
| -I, --no-filename            | ファイル名を表示しない                               |
| --no-heading                 | ファイル名をマッチした行と一緒に表示する(おすすめ)   |

#### 除外ルールを除外する系 ####

| 表記                 | 意味                                               |
|----------------------|----------------------------------------------------|
| --no-ignore          | なんとか ignore や exclude を全部を無視する        |
| --no-ignore-dot      | .ignore を無視する                                 |
| --no-ignore-exclude  | .git/info/exclude を無視する                       |
| --no-ignore-files    | --ignore-file の指定を無視する                     |
| --no-ignore-global   | $HOME/.config/git/ignore の指定を無視する          |
| --no-ignore-messages |                                                    |
| --no-ignore-parent   | 先祖ディレクトリにある ignore 系ファイルを無視する |
| --no-ignore-vcs      | Git管理下の除外設定を無視する                      |

#### 結果表示のカスタマイズ ####

| 表記                             | 意味                                                                 |
|----------------------------------|----------------------------------------------------------------------|
| -N, --no-line-number             | 行番号を表示しない                                                   |

#### 別に知らなくてよさそうなやつ ####

| 表記              | 意味                                             |
|-------------------|--------------------------------------------------|
| --mmap            | 脆いが指定すると速くなるらしい(デフォルト)       |
| --no-mmap         | 高速になる可能性があってもメモリマップを使わない |
| -j, --threads <N> | スレッド数の指定                                 |

#### 文字コードがらみ ####

| 表記                      | 意味                                                        |
|---------------------------|-------------------------------------------------------------|
| -E, --encoding <ENCODING> | shift_jis のときは -E shift_jis とする                      |
| --crlf                    | 改行が `\r\n` なときでも `$` が行末にマッチするようになる |

本来 `$` で `\r\n` にマッチするはずの正規表現エンジンが対応していないので、仕方なく ripgrep 側で `--crlf` オプションを用意しているらしい

結局 Windows なファイルには `-E shift_jis --crlf` としないといけない

#### 事前に別のコマンドを噛ます ####

| 表記                 | 意味                                                      |
|----------------------|-----------------------------------------------------------|
| --pre <COMMAND>      | 事前に COMMAND を噛ます。PDFやExcelをテキスト化するなど。 |
| --pre-glob <GLOB>... | --pre で指定のコマンドに送るファイルを絞る '*.pdf' など   |

#### ファイル名の並び替え ####

| 表記             | 意味                                         |
|------------------|----------------------------------------------|
| --sort <SORTBY>  | 並び替え none path modified accessed created |
| --sortr <SORTBY> | 並び替え 逆順                                |

#### 用途がいまいちわからないやつ ####

| 表記                 | 意味                                                                |
|----------------------|---------------------------------------------------------------------|
| --null-data          | マッチしたファイル全体を表示し、最後に NUL を入れる                 |
| -r, --replace <TEXT> | マッチした箇所を置換表示する (ファイルを更新してくれるわけじゃない) |
| --passthru           | マッチしてない部分も全部表示する。行番号の後がハイフンになる        |

#### その他 ####

| 表記                             | 意味                                                                 |
|----------------------------------|----------------------------------------------------------------------|
| --no-messages                    | ファイルの読み取り時のエラーを表示しない                             |
| --no-require-git                 |                                                                      |
| --no-unicode                     | 指定すると日本語が使えなくなる                                       |
| -0, --null                       | ファイル名の後で NUL を入れる。xargs -0 用                           |
| --one-file-system                | ファイルシステムを跨がない                                           |
| --path-separator <SEP>           | 表示する際のパスの '/' を変更できる                                  |
| -P, --pcre2                      | 正規表現エンジンを PCRE2 に切り替える                                |
| --pcre2-version                  | ?                                                                    |
| -p, --pretty                     | --color always --heading --line-number の一括指定                    |
| -q, --quiet                      | 何も表示しない                                                       |
| --regex-size-limit <N+SUFFIX?>   | コンパイルされた正規表現のサイズ制限。知らなくていい                 |
| -e, --regexp <PATTERN>...        | 次の引数が正規表現であると明示できるので -- -foo を -e -foo と書ける |
| -z, --search-zip                 | 圧縮ファイルの中も見る                                               |
| --stats                          | 何件中、いくつマッチしたかなどの情報を追加表示する                   |
| --json                           | JSON 形式で表示                                                      |
| -a, --text                       | バイナリファイルもテキストと見なす (なんのメリットが？)              |
| -u, --unrestricted               | -u -uu -uuu と増やす度に制限が緩くなる                               |
| --vimgrep                        | 1行でN回マッチしたらカラム位置情報と合わせてN行分表示する            |
| -H, --with-filename              | 1つのファイルを指定しているときでもファイル名を表示する              |

# はまりがちなこと #

#### ~/.ripgreprc を置いたのに読んでないっぽい ####

export RIPGREP_CONFIG_PATH=$HOME/.ripgreprc

ホーム以下にドットファイルをぶちまけるという規約を

#### Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis あ a.txt
```

#### それでも Windows で作られたファイルが読めない ####

```shell
rg -E shift_jis 'あ$' --crlf a.txt
```

改行コードだと \r\n だと $ が改行にマッチしない問題

```shell
$ ruby -e '"foo\r\n".display' > a.txt
$ rg 'foo$' a.txt
$ rg 'foo$' a.txt --crlf
1:foo
```

#### *.min.js にマッチしてしまい端末が大変なことになった ####

--max-columns=128

#### 128文字超えた行が何も表示されない ####

--max-columns=128 --max-columns-preview

#### ときどきファイル名が表示されない ####

  * 対象のファイルが1件だとファイル名が表示されない
  * これは指定するファイル数が変更する場合に困る
  * 常にファイル名をする場合は `--with-filename` とする

# 実用例 #

#### 拡張子が png の怪しいファイルのヘッダに PNG が含まれるか確認する ####

```shell
$ rg PNG image.png
image.png: binary file matches (found "\0" byte around offset 8)
```

  * デフォルトで --binary オプションが有効なのでバイナリファイルも見れる
  * file コマンドでいい気がした

#### 常に PDF 内のテキストを検索する ####

```shell
```

#### --stats で表示される情報を取り込みたい ####

```shell
```

--json

#### include ####

rg --type-add xxx:include:c,ruby -t xxx foo2
