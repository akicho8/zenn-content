---
title: "テキスト検索ツール ripgrep (rg) の使い方メモ"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ripgrep", "rg", "rust"]
published: false
---

https://github.com/BurntSushi/ripgrep

# インストール #

```shell
cargo install ripgrep
```

  * 2022-07-23 での最新バージョンは 13.0.0
  * コマンド名は `rg`

##### 更新できるときだけ更新する手順 #####

```shell
cargo install cargo-update
cargo install-update --list
cargo install-update --all
```

# オプション #

### 検索パターンの解釈 ###

| 表記                 | 意味                                                   |
|----------------------|--------------------------------------------------------|
| -i, --ignore-case    | 大小文字を区別しない。 /foo/i                      |
| -s, --case-sensitive | 大小文字を区別する。 /foo/                         |
| -w, --word-regexp    | 単語とみなす。 /\bfoo\b/                               |
| -S, --smart-case     | 大文字が含まれるときだけ。 /Foo/i ではなく /Foo/       |
| -x, --line-regexp    | 1行分マッチさせる。 foo が /^foo$/ になる              |
| -U, --multiline      | 複数行に跨って検索できる。 a\nb には a\nb でマッチ |
| --multiline-dotall   | -U と合わせて指定すると a\nb に a.b でマッチする   |
| -F, --fixed-strings  | 正規表現としない                                       |

### 結果表示 ###

| 表記                     | 意味                                                    |
|--------------------------|---------------------------------------------------------|
| --no-heading             | ファイル名をマッチした行と一緒に表示する(必須)          |
| -l, --files-with-matches | マッチしたファイル名だけ列挙する                        |
| -m, --max-count <N>      | ファイルごとに表示をN行に制限する。便利。               |
| -n, --line-number        | 行番号を表示する (デフォルト)                           |
| -H, --with-filename      | 1つのファイルを指定しているときでもファイル名を表示する |
| --trim                   | 表示の際に左側のスペースを取る。Ruby の lstrip 相当     |
| -q, --quiet              | 何も表示しない                                          |

### あまり使わない結果表示 ###

| 表記                  | 意味                                                       |
|-----------------------|------------------------------------------------------------|
| --files-without-match | マッチしなかったファイル名だけ列挙する                     |
| -v, --invert-match    | マッチしなかった行を表示する                               |
| -I, --no-filename     | ファイル名を表示しない                                     |
| -N, --no-line-number  | 行番号を表示しない                                         |
| --heading             | ファイル名を一緒に表示しない (デフォルトかつ不便)          |
| --column              | カラム位置も表示する ファイル名:行:カラム                  |
| -p, --pretty          | --color always --heading --line-number の一括指定。less 用 |
| --vimgrep             | 1行で複数回マッチしたら複数行表示する。vim専用(?)          |

### マッチした数を表示する ###

| 表記            | 意味                             |
|-----------------|----------------------------------|
| -c, --count     | マッチした行数を表示する。便利。 |
| --count-matches | マッチした個数を表示する         |
| --include-zero  | マッチしないときでも0を表示する  |

コンテンツは表示しない

### 長すぎる一行を途中で切る ###

| 表記                  | 意味                               |
|-----------------------|------------------------------------|
| -M, --max-columns <N> | N 文字以上なら一行まるごと省略する |
| --max-columns-preview | N 文字分は表示する                 |

  * --max-columns だけだと一行がまるごと省略メッセージに置き換わってしまう
  * --max-columns-preview も指定すると「途中で切る」になる
  * `*.min.js` にマッチして大変な目に合わないよう初期設定しておく

### 対象のファイルをGLOB形式で絞る ###

| 表記                    | 意味                                  |
|-------------------------|---------------------------------------|
| -g, --glob <GLOB>...    | 対象をGLOB形式で絞る。!なら逆に捨てる     |
| --glob-case-insensitive | --glob のとき大小文字の区別をしない   |
| --iglob                 | --glob --glob-case-insensitive と同じ |

`rg foo *.rb` と書いてもGLOB形式だけど、これはコマンド実行前にシェルが展開するだけなので、サブディレクトリに潜った上で内部で比較する -g とは動作が異なる

### 対象を広げる ###

| 表記             | 意味                   |
|------------------|------------------------|
| -L, --follow     | シンボリックリンク先を追う       |
| -z, --search-zip | 圧縮ファイルの中も見る |

### ファイルサイズや深さで制限する ###

| 表記                       | 意味                                    |
|----------------------------|-----------------------------------------|
| --max-filesize <N+SUFFIX?> | 100K なら 100KB 以下のファイルだけ見る  |
| --max-depth <N>            | ディレクトリN階層まで。1:自分 2:子 3:孫 |
| --one-file-system          | ファイルシステムを跨がない              |

### 除外ルールを緩める ###

| 表記               | 意味                                 |
|--------------------|--------------------------------------|
| -u, --unrestricted | --no-ignore と同じ                   |
| -uu                | --no-ignore --hidden と同じ          |
| -uuu               | --no-ignore --hidden --binary と同じ |
| --no-ignore        | ignore 的なやつ全部無視。-u と同じ   |
| -., --hidden       | ドットで始まる隠れてるやつも見る     |

マッチしなかったら -u -uu -uuu と増やす
それだけ覚えておけばいい

ほぼ知らなくていいやつ↓

| 表記                 | 意味                                                |
|----------------------|-----------------------------------------------------|
| --no-ignore-dot      | .ignore を無視する                                  |
| --no-ignore-exclude  | .git/info/exclude を無視する                        |
| --no-ignore-files    | --ignore-file の指定を無視する                      |
| --no-ignore-global   | $HOME/.config/git/ignore の指定を無視する           |
| --no-ignore-parent   | 先祖ディレクトリにある ignore 系ファイルを無視する  |
| --no-ignore-vcs      | Git管理下の除外設定を無視する                       |
| --no-ignore-messages | .gitignore でエラーになっても何も表示しない(らしい) |

そもそも .gitignore に何を書いてもエラーにならないのはなぜだろう

### ファイルのグループ化 ###

| 表記                      | 意味                                         |
|---------------------------|----------------------------------------------|
| --type-list               | 事前にグループ化されている種類を確認する     |
| -t, --type <TYPE>...      | -t ruby なら Ruby に関連するファイルを探す   |
| -T, --type-not <TYPE>...  | -T ruby なら Ruby に関連しないファイルを探す |
| --type-add <TYPE_SPEC>... | foo:*.bar なら foo グループに *.bar を登録  |
| --type-clear <TYPE>...    | 削除                                         |

  * コマンドラインで使うのは基本 `-t` だけ
  * 初期設定ファイルであらかじめ登録しておく

### バイナリファイルも見る ###

| 表記       | 意味                                                             |
|------------|------------------------------------------------------------------|
| --binary   | バイナリファイルも見る。中身の表示は控える                       |
| -a, --text | すべてをテキストと見なしてバイナリの中身もかまわず端末に出力する |

  * どちらを指定してもバイナリファイルを見る
  * --text は端末がめちゃくちゃになるので忘れていい

### 文字コードがらみ ###

| 表記               | 意味                                                      |
|--------------------|-----------------------------------------------------------|
| -E, --encoding <E> | Shift_JIS のときは -E shift_jis とする                    |
| --crlf             | 改行が `\r\n` なときでも `$` が行末にマッチするようになる |

  * ripgrep によると正規表現は本来 `$` で `\r\n` にマッチするべきらしい
    * でも Ruby は `$` が `\r\n` にマッチしない
  * しかしライブラリが対応していないので対応するまで `--crlf` で吸収しているとのこと
  * `--crlf` オプションを使わない場合は `\r?$` と書かないといけない
  * いろんな改行にマッチする `\R` には対応してない
  * 結局 Windows なファイルには `-E shift_jis --crlf` としないといけない

### 事前に別のコマンドを噛ます ###

| 表記                 | 意味                                                         |
|----------------------|--------------------------------------------------------------|
| --pre <COMMAND>      | 事前に COMMAND を噛ます。Excelをテキスト化するなど。         |
| --pre-glob <GLOB>... | --pre で指定した COMMAND に送れるファイルを絞る '*.xlsx' など |

  * バイナリファイルか判定する前に COMMAND に渡るので --binary オプションの有無は気にしなくてよい
  * COMMAND で受け付けているのに無反応な場合 --pre-glob でファイルを指定し忘れていないか確認する

### 上下余分に表示する ###

| 表記                            | 意味                                      |
|---------------------------------|-------------------------------------------|
| -B, --before-context <N>        | マッチした行の上 N 行も表示する           |
| -A, --after-context <N>         | マッチした行の下 N 行も表示する           |
| -C, --context <N>               | マッチした行の上下 N 行も表示する         |
| --context-separator <SEP>       | 塊と塊の間の -- を変更する                |
| --field-context-separator <SEP> | 余分に表示した行の横の境目の - を変更する |

### ファイル名の並び替え ###

| 表記             | 意味 |
|------------------|------|
| --sort <SORTBY>  | 正順 |
| --sortr <SORTBY> | 逆順 |

選択肢 `none path modified accessed created`

### 調べる ###

| 表記    | 意味                                                                 |
|---------|----------------------------------------------------------------------|
| --files | 対象のファイルをすべて列挙する。そもそもファイル見てんのか？なとき用 |
| --debug | どの設定ファイルで何が有効になったのか？なとき用                     |
| --trace | どこで何がマッチしたのか？なとき用 (ほぼ開発者用)                    |

### 統計表示 ###

| 表記    | 意味                                           |
|---------|------------------------------------------------|
| --stats | 何件中何個マッチしたかなどの情報を最後に表示する   |
| --json  | JSON 形式で表示                                |

  * --stats の出力をプログラムで読み取るなら --json でJSON化する
  * --json は --stats 専用ってわけじゃない

### ブロック毎に出力するか？ 一行毎に出力するか？ ###

| 表記             | 意味                                |
|------------------|-------------------------------------|
| --block-buffered | ブロック毎に出力する (デフォルト)    |
| --line-buffered  | 一行毎に出力する                        |

単に端末に表示するなら `--block-buffered` の方が速いけど `tailf -f production.log | rg foo | foo bar` のような行指向でパイプ処理する場合、ブロック毎だと一行が途中で分断されてしまうかもしれないので `tailf -f production.log | rg --line-buffered foo | foo bar` とすればいいらしい。が、ブロック毎であっても行の分断を観測できなかったので本当に必要かはよくわかっていない。とりあえず行指向なパイプ処理のときは安全のために `--line-buffered` をつけておいた方がよさそう、ぐらいの認識。

### 色 ###

| 表記                     | 意味                                           |
|--------------------------|------------------------------------------------|
| --color <WHEN>           | never なら OFF                                 |
| --colors <COLOR_SPEC>... | 'match:fg:cyan' ならマッチした部分が水色になる |

### 正規表現関連 ###

| 表記                         | 意味                           |
|------------------------------|--------------------------------|
| --dfa-size-limit <N+SUFFIX?> | 正規表現 DFA の上限の制限      |
| --engine <ENGINE>            | 正規表現のライブラリを変更する |
| -P, --pcre2                  | PCRE2 に切り替える             |
| --pcre2-version              | ?                              |

  * ビルドの時点で PCRE2 を含めてないと切り替えられなかったのでよくわからない
  * PCRE は Perl で使われている正規表現ライブラリらしい

### 何かに使えそうで何に使うかわからないやつ ###

| 表記                | 意味                                            |
|---------------------|-------------------------------------------------|
| -o, --only-matching | マッチした行ではなくマッチした箇所だけ表示する  |
| -b, --byte-offset   | -o のときマッチした箇所のオフセットも表示 |

--byte-offset は --column と似ているが行頭からではなくファイルの先頭からのオフセット

### いまいち用途がわからないやつ ###

| 表記                 | 意味                                                    |
|----------------------|---------------------------------------------------------|
| --null-data          | マッチしたファイル全体を表示し、最後に NUL を入れる     |
| -r, --replace <TEXT> | マッチ箇所を置換 (ファイルを更新してくれるわけじゃない) |
| --passthru           | マッチしてない部分も全部表示する                        |

### 知らなくてよさそうなやつ ###

| 表記                           | 意味                                                       |
|--------------------------------|------------------------------------------------------------|
| --mmap                         | 脆いが指定すると速くなるらしい (デフォルト)                |
| --no-mmap                      | 高速化の余地があってもメモリマップを使わない               |
| -j, --threads <N>              | スレッド数の指定                                           |
| --no-unicode                   | 指定すると日本語が使えなくなる                             |
| --regex-size-limit <N+S?>      | コンパイルされた正規表現のサイズ制限                       |
| --path-separator <SEP>         | 表示する際のパスの '/' を変更できる                        |
| --field-match-separator <SEP>  | 「ファイル名:行」の「:」の部分の変更                       |
| --ignore-file-case-insensitive | Windows のとき ignore 系ファイルの大小文字を区別しない |

### その他 ###

| 表記                    | 意味                                                           |
|-------------------------|----------------------------------------------------------------|
| --no-config             | RIPGREP_CONFIG_PATH の先を読まない                             |
| --no-require-git        | .git ディレクトリがなくてもGitのグローバル除外ルールを適用する |
| -e, --regexp <P>...     | ハイフンで始まるパターン用。 `-- -foo` を `-e -foo` と書ける   |
| -f, --file <FILE>...    | 指定のファイルからパターンを読み込む                           |
| --no-messages           | ファイルの読み取り時のエラーを表示しない                       |
| --ignore-file <PATH>... | .gitignore 形式の別のファイルを指定する                        |
| -0, --null              | ファイル名の後で NUL を入れる。xargs -0 用                     |

  * --ignore-file は .gitignore .ignore .rgignore 以外のファイルを使いたいとき用
  * --no-require-git は名前がよくない

# はまりがちなこと #

### ~/.ripgreprc を置いたのに読まれない ###

```ruby:~/.zshenv
export RIPGREP_CONFIG_PATH=$HOME/.ripgreprc
```

ホーム以下にドットファイルをぶちまけるのが良い規約だとは思っていないのか、デフォルトでは置いても読まれない。ファイル名も決まってない。単に `RIPGREP_CONFIG_PATH` が指す先のファイルを読む。

### Windows で作られたファイルが読めない ###

```shell
rg -E shift_jis あ something.txt
```

Shift_JIS のファイルを読むには `-E shift_jis` とする

### Windows で作られたファイルの改行に $ がマッチしない ###

```shell
rg -E shift_jis 'あ$' --crlf something.txt
```

`--crlf` を指定すると ripgrep 側でなんとかしてくれる

### プリプロセッサをPDFにも対応させたのにPDFが来ない ###

  * `--pre-glob` での指定を忘れている
  * もし `--pre-glob=*.xlsx` のままだと `*.pdf` は来ない
  * `--pre-glob=*.{xlsx,pdf}` とする

### --type-add するときの include とは？ ###

```ruby
rg --type-add web:include:html,css -t web foo
```

既存の html と css のグループをまとめるという意味

```ruby
$ rg --type-list | rg -N '^(html|css):'
# html: *.ejs, *.htm, *.html
# css: *.css, *.scss
```

となるので `web:include:html,css` は、こう書くのと結果的には同じ

```ruby
rg --type-add 'web:*.{ejs,htm,html,css,scss}' -t web foo
```

### ときどきファイル名が表示されない理由 ###

  * ファイルを1件指定したときはファイル名を表示しないようになっているから
  * 自明だから表示する必要がないだろうと判断されている
  * ただ、これは指定するファイル数が変動する場合に困る
  * 1件でも2件でも同じように読み取りたいプログラムがあったときバグる
  * 常にファイル名を表示するには `--with-filename` とする

### --binary オプションが常に効いている？ ###

  * --binary はバイナリーファイルも読むオプション
  * なので `rg --binary PNG` とすると png ファイルにマッチする
    * ヘッダ内のPNG文字列がマッチする
  * ところが `rg PNG foo.png` としても `--binary` を指定していないのにマッチする
  * これは探したファイルと明示的に指定したファイルとでは扱いが異なるため
  * ファイルを限定して指定したのにそれをわざわざ省く必要はないだろうと判断される
  * なので --binary の有無に関係なく foo.png は対象になる
  * このように従来の不親切なツールに慣れていると親切な仕様に戸惑うことがある

### --text オプションを指定したのにバイナリーファイルも見ている ###

  * 勘違いしやすいけど --text はテキストだけを見るオプションではない
  * 正しくはすべてをテキストとして扱うやばいオプション
  * なのでバイナリーファイルもテキストファイルとして扱う

### --no-require-git とは？ ###

| .git | --no-require-git | Gitのグローバル除外ルール |                        |
|------|------------------|---------------------------|------------------------|
| ある | なし             | 効く                      |                        |
| ない | なし             | 効かない                  |                        |
| ない | 指定             | 効く                      | ← .git がないのに効く |

デフォルトの挙動は .git ディレクトリがないのに勝手にGitのグローバル除外ルールを適用するのは変だろうから .git ディレクトリがあるときだけGitのグローバル除外ルールも有効にしよう、となっている。

そこであるとき、Gitで管理していないディレクトリで作業中に、Gitのグローバル除外ルールが効いていないことに気づいて、Gitのグローバル除外ルールを適用させるためだけに `mkdir .git` したとする。

その `mkdir .git` をやらなくてもGitのグローバル除外ルールを適用するのが `--no-require-git` オプションになる。

# 実用例 #

### XMLファイルはGit管理下にあるけど検索対象からは外したい ###

```shell
echo "*.xml" >> .rgignore
```

### 除外ルールは fd と共有したい ###

```shell
echo "*.xml" >> .ignore
```

### *.min.js にマッチしてしまい端末が大変なことになったときの応手 ###

| Command           | 意味                           |
|-------------------|--------------------------------|
| -g '!*.min.js'    | *.min.js は除外する            |
| -T minified       | *.min.js っぽいやつは除外する  |
| --max-columns 100 | 表示する一行の文字数を制限する |

  * `--max-columns` を指定するときは `--max-columns-preview` も一緒に指定する
  * すると100文字目までは表示される

### マッチしすぎるときの応手 ###

| Command              | 意味                                       |
|----------------------|--------------------------------------------|
| rg foo -g '*.rb'     | 拡張子で絞る                               |
| rg foo -g '!*.js'    | 絞るんじゃなくていらない方を除外する       |
| rg foo -t ruby       | 種類で絞る                                 |
| rg foo -g '\*user\*' | user が含まれるファイル名に絞る            |
| rg foo -m 3          | 1つのファイルにつき表示は3行だけにする     |
| rg foo -c            | ファイルとマッチした行数だけにする         |
| rg foo -l            | もうファイル名だけでいい                   |
| rg foo --max-depth 2 | ファイル名も多いので孫ディレクトリはみない |
| rg foo -q            | 何も表示しない                             |

### 拡張子が png なのにヘッダに PNG が含まれない偽画像ファイルを探す ###

```shell
rg --files-without-match --binary -g '*.png' PNG
```

  * --binary オプションをつけると画像ファイルも読む

### 検索結果をWEBで表示したい ###

```shell
rg --stats --json foo
```

  * --stats で検索に要した時間なども含める
  * --json でJSON化

活用すればただのテキストファイル郡が高速なデータベースとしても使えるかもしれない

### さくっと結果を less する ###

```ruby
rg -p foo | less -R
```

  * -p オプションで less に特化した見やすい表示になる
  * less の -R は色を反映するオプション

### バイナリファイルをテキスト化してから検索する ###

なんでもテキスト変換するスクリプトを用意する

```sh:~/bin/rg-preprocessor
#!/bin/sh
case "$1" in
    *.xlsx)
        exec xlsx2csv $*
        ;;
    *.pdf)
        # exiftool の方が Title, Creator, Page Count の情報が取れる
        exiftool $*
        # テキスト変換したところであまり有用な情報は得られない
        pdftotext $* -
        ;;
    *)
        case $(file --brief --mime-type "$1") in
            *image*)
                exec exiftool $*
                ;;
            *audio* | *video*)
                # ffprobe は万能なので画像系を渡してもいい
                exec ffprobe -v quiet -show_streams $*
                ;;
            *)
                echo "$* を渡さないように --pre-glob で絞ってください" 1>&2
                exit 1
                ;;
        esac
        ;;
esac
```

`~/bin/rg-preprocessor foo.xlsx` などとしてテキスト変換されるのを確認する
次に --pre と --pre-glob を設定する
コマンドラインで毎回書くのは大変なので設定ファイルに書いておく

```sh:~/.ripgreprc
# 指定のバイナリファイルは事前にテキスト変換する。 ~/ とか使うと動かないので注意
--pre=/Users/alice/bin/rg-preprocessor

# --pre のスクリプトに渡すファイルを絞る
--pre-glob=*.{xlsx,pdf}
--pre-glob=*.{png,jpg,apng,webp,gif}
--pre-glob=*.{wav,mp3,m4a,ogg}
--pre-glob=*.{mp4,mov,avi,ogg,webm}
```

(例) PDFのページ数を確認する

```shell
$ rg 'Page Count'
# file1.pdf:18:Page Count : 4
# file2.pdf:18:Page Count : 6
# file3.pdf:18:Page Count : 5
```

(例) 曲や動画の長さを確認する

```shell
$ rg -w duration
# file1.wav:21:duration=3.056333
# file2.mp3:21:duration=4.519184
# file3.mp4:21:duration=5.142417
```

(例) 画像ファイルの色の種類を確認する

```shell
$ rg 'Color Type'
# file1.png:15:Color Type : Palette
# file2.png:15:Color Type : RGB
# file3.png:15:Color Type : RGB with Alpha
```

### 初期設定ファイルの例 ###

```sh:~/.ripgreprc
# -*- mode: sh -*-
# https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md#configuration-file
# オプションに引数があるときは「=」か「改行」で区切る。半角スペースはだめ。

# 端末が死なないように長すぎる一行を切る
--max-columns=128

# 一行を切ったとき切った前の部分は表示する
--max-columns-preview

# ファイル名だけ別に表示するのではなく行と一緒に表示する
--no-heading

# ファイルを1件指定したときファイル名がわかりきっていても省略せずに表示する
--with-filename

# 表示の際に左側のスペースを取る
--trim

# 改行が \r\n であっても $ をマッチさせる
--crlf

# --multiline を使ったとき "\n" に "." でマッチするようにする
--multiline-dotall

# 一般的な圧縮ファイルの中も見る
--search-zip

# 指定サイズを超えるファイルはスキップする
--max-filesize=10M

# ファイルシステムを跨がない
--one-file-system

# .git ディレクトリがないところでもGitのグローバル除外ルールを適用する
--no-require-git

# *.min.css, *.min.html, *.min.js を除外する
--type-not=minified

# dist ディレクトリを除外する
--glob=!dist

# 指定のバイナリファイルは事前にテキスト変換する。~/ とか使うと動かないので注意
--pre=/Users/alice/bin/rg-preprocessor

# --pre のスクリプトに渡すファイルを絞る
--pre-glob=*.{xlsx,pdf}
--pre-glob=*.{png,jpg,apng,webp,gif}
--pre-glob=*.{wav,mp3,m4a,ogg}
--pre-glob=*.{mp4,mov,avi,ogg,webm}
```
