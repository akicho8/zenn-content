---
title: "Capybara ã®çŸ¥è¦‹ã¾ã¨ã‚"
emoji: "ğŸ¦«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Capybara", "Ruby", "è‡ªå‹•åŒ–"]
published: false
---

Capybara ã§ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’åŠè‡ªå‹•åŒ–ã™ã‚‹éš›ã«å¾—ãŸçŸ¥è¦‹ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« chromedriver ãŒã‚ã‚‹

```shell
$ which chromedriver
/usr/local/var/rbenv/shims/chromedriver
```

- ãã‚Œã¯ chromedriver-helper gem ã®æ®‹éª¸
- ä»–ã«ã‚‚ chromedriver ã§å§‹ã¾ã‚‹å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¯ãš
- å…¨éƒ¨æŠ¹æ®ºã™ã‚‹

```shell
$ rm /usr/local/var/rbenv/shims/chromedriver*
```

- gem ã‚‚æ¶ˆã—ã¨ã‘

```shell
$ gem uni -ax chromedriver-helper
```

## ã¾ãŸ chromedriver ãŒå‡ºã¦ããŸ

```shell
$ which chromedriver
/usr/local/bin/chromedriver
```

- ãã‚Œã¯ `brew install chromedriver` ã§å…¥ã‚ŒãŸã‚„ã¤
- æŠ¹æ®ºã™ã‚‹

```shell
$ brew uninstall chromedriver
```

## chromedriver ãŒãªã„ã¨è¨€ã‚ã‚Œã‚‹

```
Failure/Error: raise Error::WebDriverError, self.class.missing_text unless path

Selenium::WebDriver::Error::WebDriverError:
  Unable to find chromedriver. Please download the server from
  https://chromedriver.storage.googleapis.com/index.html and place it somewhere on your PATH.
  More info at https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver.
```

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šã‚Šã«ã€ŒæŒ‡å®šã® URL ã‹ã‚‰ chromedriver ã‚’è½ã¨ã—ã¦ PATH ã‚’è¨­å®šã™ã‚‹ã€ãªã©ã—ã¦ã¯ã„ã‘ãªã„
- webdrivers gem ã‚’å…¥ã‚Œã‚‹

## chromedriver ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã©ã“ã«ã‚ã‚‹ï¼Ÿ

```shell
$ exa -al --no-user ~/.webdrivers
.rwxr-xr-x 17M 10 7  2021 chromedriver
.rw-r--r--  13 16 5 06:23 chromedriver.version
```

## chromedriver ãŒã‚ã‚‹ã®ã«å‹•ä½œã—ãªã„

- Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ãªã„ã®ãŒåŸå› 
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªæ‰‹é †

```shell
"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version
~/.webdrivers/chromedriver --version
```

- Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ70ä»¥ä¸Šã§ã‚ã‚Œã° Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¸€è‡´ã™ã‚‹ã€ã¨ webdrivers ã® README ã«æ›¸ã„ã¦ã‚ã‚‹
- ã—ã‹ã— Google Chrome ãŒè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚ŒãŸç›´å¾Œã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒç”¨æ„ã•ã‚Œã¦ãªã„ã“ã¨ãŒã‚ã£ãŸ
- ãã‚Œã§ä¸€å›äº‹æ•…ã£ã¦å¤§å¤‰ãªç›®ã«ã‚ã£ãŸã®ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è‡´èª¬ã«ã¯æ™‚å·®ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ç–‘ã£ã¦ã„ã‚‹

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ãªã„äº‹æ•…ã‚’é˜²ãç¢ºå®Ÿãªæ–¹æ³•

Google Chrome ã®è‡ªå‹•æ›´æ–°ã‚’æ­¢ã‚ã‚‹ã€‚
ã“ã‚Œãªã‚‰çµ¶å¯¾ã«ãšã‚Œã‚‹ã“ã¨ã¯ãªã„ã€‚

ã¾ãšæ›´æ–°ãƒã‚§ãƒƒã‚¯é »åº¦ã‚’ 0 ã«ã™ã‚‹ã€‚

```shell
defaults write com.google.Keystone.Agent checkInterval 0
```

ãã—ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æŠ¹æ®ºï¼†ãƒ€ãƒŸãƒ¼ã«ç½®ãæ›ãˆã‚‹ã€‚
~/Library å´

```shell
sudo rm -R ~/Library/Google/GoogleSoftwareUpdate/
sudo touch ~/Library/Google/GoogleSoftwareUpdate
sudo chmod 444 ~/Library/Google/GoogleSoftwareUpdate
sudo rm ~/Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R ~/Library/Caches/com.google.Keystone*
sudo rm ~/Library/Preferences/com.google.Keystone.Agent.plist
```

/Library å´

```shell
sudo rm -R /Library/Google/GoogleSoftwareUpdate/
sudo touch /Library/Google/GoogleSoftwareUpdate
sudo chmod 444 /Library/Google/GoogleSoftwareUpdate
sudo rm /Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R /Library/Caches/com.google.Keystone*
sudo rm /Library/Preferences/com.google.Keystone.Agent.plist
```

ã“ã®å†…å®¹ã¯2000å¹´ã”ã‚ã®ä½œæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã²ã£ã±ã£ã¦ããŸã‚‚ã®ãªã®ã§ç¾åœ¨ãã®é€šã‚Šã«ã—ã¦æœŸå¾…é€šã‚Šã«ãªã‚‹ã‹ä¿è¨¼ã¯ãªã„ (ã˜ã‚ƒãè¼‰ã›ã‚“ãªã€‚å±ãªã„ã—)

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ãªã„äº‹æ•…ã‚’é˜²ãæ¥½è¦³çš„ãªæ–¹æ³•

ã„ã–äº‹æ•…ã£ãŸã‚‰æ‰‹å‹•ã§å…ƒã«æˆ»ã™ã€‚
ãã®ãŸã‚ã«æ—¥ã€…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãŠãã€‚

```sh:~/bin/capybara-env-backup.sh
#!/bin/sh
# (cd /Applications && rm -fr .git)
# (cd ~/.webdrivers && rm -fr .git)
# exit

cd /Applications
[ ! -d .git ] && git init -q
git add -A "Google Chrome.app"
"./Google Chrome.app/Contents/MacOS/Google Chrome" --version | git commit -uno -F -

cd ~/.webdrivers
[ ! -d .git ] && git init -q
git add -A
./chromedriver --version | git commit -F -
```

ã“ã‚Œã‚’ cron ã«ã‚»ãƒƒãƒˆã—ã¦ãŠãã€‚

webdrivers ã¯ Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ãŸ chromedriver ã‚’ç”¨æ„ã—ã¦ãã‚Œã‚‹ã¯ãšãªã®ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä¿¡ç”¨ã§ããªã„ã»ã©ã«äº‹æ•…ã‚’æã‚Œã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚‚ã—ã£ã‹ã‚Šç®¡ç†ä¸‹ã«å…¥ã‚Œã¦ã™ãæˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

ãã‚Œã¨ã€ã„ã–ã¨ã„ã†ã¨ãã« `/Applications/Google Chrome.app` ã ã‘ã‚’éå»ã«æˆ»ã—ã¦èµ·å‹•ã™ã‚‹ã®ã‹ä¸å®‰ã§ã¯ã‚ã‚‹ãŒã€ã¨ã‚Šã‚ãˆãšå¸¸æ™‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ããŸã„å ´åˆã¯ã“ã£ã¡ã®æ–¹ãŒã‚ˆã„ã€‚

## Selenium ã§è­¦å‘ŠãŒå‡ºã‚‹

```
WARN Selenium [DEPRECATION] [:browser_options] :options as a parameter for driver initialization is deprecated. Use :capabilities with an Array of value capabilities/options if necessary instead.
```

- capybara ãŒå¤ã„ã®ãŒåŸå› 
- ã©ã“ã§ç›´ã£ãŸã®ã‹ã¯ã‚ã‹ã‚‰ãªã„ãŒ 3.37.1 ä»¥ä¸Šã ã¨è­¦å‘Šã¯å‡ºãªããªã£ã¦ã„ãŸ

## rack application ãŒå¿…è¦ã ã¨è¨€ã‚ã‚Œã‚‹

```shell
rack-test requires a rack application, but none was given (ArgumentError)
```

è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ current_driver ã« :selenium_chrome ã‚’æŒ‡å®šã™ã‚‹ã€‚

```ruby
Capybara.current_driver = :selenium_chrome
```

## `require "capybara/dsl"` ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ

- ä¸€ã¤ã®ãƒ–ãƒ©ã‚¦ã‚¶ã—ã‹ä½¿ã‚ãªã„ã¨ã—ãŸä¸Šã§ã„ã‚ã„ã‚çŸ­ã‹ãæ›¸ã‘ã‚‹
- Capybara.page ã§ Capybara.current_session ã‚’å‘¼ã¹ã‚‹
- Capybara.page ã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Capybara ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã«ç”Ÿãˆã‚‹
- ã¤ã¾ã‚Š Capybara.xxx ã¯ Capybara.current_session.xxx ã‚’å‘¼ã¶

## é€”ä¸­ã§æ­¢ã‚ã¦DOMã®æ§‹é€ ã‚’èª¿ã¹ã‚‹

- byebug gem ã‚’å…¥ã‚Œã‚‹
- æœ¬å½“ã¯ debug gem ã®æ–¹ãŒã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„
  - ãŒã€ eshell ã‹ã‚‰ãªãœã‹ (debug gem ä½¿ã£ã¦ã„ã‚‹ irb ãŒ) å‹•ã‹ãªã„ã®ã§ byebug ã«ã—ã¦ã„ã‚‹
- ã•ãã•ãèª¿ã¹ãŸã„ã®ã§ default_max_wait_time ã‚’ 0 ã«ã—ã¦ã‹ã‚‰ debugger ã‚’èµ·å‹•ã™ã‚‹

```ruby
Capybara.using_wait_time(0) { debugger }
```

- snippet çš„ãªã‚„ã¤ã§ã™ãã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
- ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ä½œã‚’è¦‹ãˆã‚‹åŒ–ã—ã¦ãŠã
  - `Capybara.current_driver = :selenium_chrome`

## å¾…ã¤

- assert_xxx ç³»ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãã®çŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…ã¤ã®ã«ä½¿ãˆã‚‹
- sleep ã‚’ä½¿ã£ãŸã‚‰è² ã‘ã ã¨æ€ãˆ

## å¾…ã¡ç§’æ•°ã‚’å¤‰æ›´ã™ã‚‹

æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã ã‘
```ruby
Capybara.assert_title("Google", wait: 1)
```

å±€æ‰€çš„
```ruby
Capybara.using_wait_time(1) do
  Capybara.default_max_wait_time # => 1
end
```

å…¨ä½“
```ruby
Capybara.default_max_wait_time = 2
```

- ãƒãƒƒãƒã—ãªã„ã¨ãã«ã¨ã‚Šã‚ãˆãšå€¤ã‚’å¤§ããã™ã‚Œã°ã„ã„ã‚“ã˜ã‚ƒã­ï¼Ÿ ã¨ã—ã¦ã—ã¾ã„ãŒã¡ã ã‘ã©ã€ã“ã‚Œã§è§£æ±ºã™ã‚‹ã“ã¨ã¯ã»ã¼ãªã„
- é€†ã«ã‚¹ãƒ ãƒ¼ã‚ºã«å¤±æ•—ã®åˆ¤å®šã‚’ã—ã¦ã„ãŸéƒ¨åˆ†ã§æ™‚é–“ãŒã‹ã‹ã£ã¦åŠ¹ç‡ãŒæ‚ªããªã‚‹ã®ã§å¢—ã‚„ã™ãª
- ãªã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 2 ã®ã¾ã¾ã§è‰¯ã„ã€‚è§¦ã‚“ãª
- æŒ‡å®šã™ã‚‹ã¨ã—ãŸã‚‰ wait ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ã‘ã«ç•™ã‚ã‚‹

## æŒ‡å®šã®è¦ç´ ãŒ1ä»¶ã«ãªã‚‹ã¾ã§å¾…ã¤

- ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ¤œç´¢ãªã©ã§çµæœã®æ•°ãŒå¤‰å‹•ã™ã‚‹å ´åˆã«æœ‰ç”¨

```ruby
Capybara.assert_selector(".row", count: 1)
```

## æŒ‡å®šã®URLã«ãªã‚‹ã¾ã§å¾…ã¤

```ruby
Capybara.visit("https://www.youtube.com/results?search_query=capybara")
Capybara.assert_current_path("/results?search_query=capybara")
```

`Capybara.current_path` ã§ãƒ‘ã‚¹ãŒã‚ã‹ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦æ¬¡ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¯ã„ã‘ãªã„ã€‚

```ruby:é–“é•ã£ãŸä¾‹
assert Capybara.current_path == "/results"
```

ä¸Šã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã‚‹ã¨ã€å‹•ã„ãŸã‚Šå‹•ã‹ãªã‹ã£ãŸã‚Šä¸å®‰å®šãªå‹•ä½œã«ãªã‚‹ã€‚
ãã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ç½®ãæ›ãˆã‚‹ã€‚

```ruby:æ­£ã—ã„ä¾‹ (ã‚¯ã‚¨ãƒªéƒ¨åˆ†ã¯æ¯”è¼ƒã—ãªã„)
Capybara.assert_current_path("/results", ignore_query: true)
```

## æ­£ç¢ºã«ãƒãƒƒãƒã•ã›ã‚‹

ãƒ©ãƒ™ãƒ«åã‚’æŒ‡å®šã—ã¦å€¤ã‚’å…¥åŠ›ã™ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã

```ruby
Capybara.visit("https://httpbin.org/forms/post")
Capybara.fill_in("Customer", with: "alice")
```

- æœ¬å½“ã®ãƒ©ãƒ™ãƒ«ã¯ `Customer name:` ã ã‘ã©éƒ¨åˆ†ä¸€è‡´ã§è‰¯ã„ã®ã§ `Customer` ã§ãƒãƒƒãƒã™ã‚‹
- ã—ã‹ã—ã€ã‚ã¨ã‹ã‚‰ Customer ã®åå‰ãŒå¢—ãˆã‚‹ã¨é¢å€’ãªã®ã§ãƒ¡ãƒ³ãƒ†ã—ç¶šã‘ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Œã°å®Œå…¨ä¸€è‡´ã«ã—ã¦ãŠããŸã„
- ãã®å ´åˆã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ `Capybara.exact = true` ã¨ã—ã¦ãŠã
- exact ã¯ **æ­£ç¢º** ã‚’æ„å‘³ã™ã‚‹

```ruby
Capybara.exact = true
Capybara.visit("https://httpbin.org/forms/post")
Capybara.fill_in("Customer name:", with: "alice")
```

ã¾ãŸã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå€¤ã‚ˆã‚Šã‚‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆã™ã‚‹ã®ã§å€‹åˆ¥ã«æŒ‡å®šã‚‚ã§ãã‚‹

```ruby
Capybara.fill_in("Customer", with: "alice", exact: false)
Capybara.fill_in("Customer name:", with: "alice", exact: true)
```

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ `exact = true` ã«ã—ã¦ã—ã¾ã†ã¨ assert_text ã¾ã§å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã—ã¾ã†ï¼Ÿ

ãªã£ã¦ã—ã¾ã‚ãªã„

- ã‚ãˆã¦å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã«ã¯ `assert_text "xxx", exact: true` ã¨æ›¸ã
- `Capybara.exact_text = true` ã¨ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹
- ãŒã€ã“ã‚ŒãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã¯ã»ã¼ãªã„

## æ”¹è¡Œã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®å½±éŸ¿ã§ assert_text ã®åˆ¤å®šãŒæºã‚‰ã

```ruby
Capybara.assert_text("foo bar", normalize_ws: true)
```

- `normalize_ws: true` ã™ã‚‹ã¨å¯¾è±¡ã‚’ `gsub(/[[:space:]]+/, ' ').strip` ã™ã‚‹
- ãªã®ã§ ` foo \n bar ` ã«ã‚‚ `foo bar` ãŒãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«ãªã‚‹

## assert_text ã§ãƒãƒƒãƒã—ãªã„

- æƒ³å®šã—ã¦ã„ã‚‹ç”»é¢ã«ãªã£ã¦ã„ãªã„ã®ãŒã»ã¨ã‚“ã©ã®åŸå› 
- ãƒ‡ãƒãƒƒã‚¬ã§æ­¢ã‚ã¦ä»¥ä¸‹ã‚’ç¢ºèª
  - `Capybara.title`
  - `Capybara.current_url`
  - `Capybara.page.text`
  - `Capybara.page.text.include?("xxx")`

## ãƒã‚¦ã‚¹æ“ä½œã§ã¯æŠ¼ã›ã‚‹ã®ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰æŠ¼ã›ãªã„

1. ã‚µã‚¤ãƒˆå´ã®ä»•çµ„ã¿ã§å‡¦ç†ä¸­ã®æ“ä½œã‚’ç¦æ­¢ã™ã‚‹ãŸã‚ç”»é¢ã‚’ div ã§è¦†ã£ã¦ã„ã‚‹
1. å‡¦ç†ãŒçµ‚ã‚ã£ã¦ç”»é¢ã‚’è¦†ã†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯æ¶ˆãˆãŸ
1. ã ãŒã€ç”»é¢ã‚’è¦†ã† div ãŒå®Œå…¨ã«ã¯å–ã‚Šé™¤ã‹ã‚Œã¦ã„ãªã„

ãã‚“ãªã¨ãã«ä¸æ•´åˆãŒèµ·ãã‚‹ã‚ˆã†ã ã€‚
ãƒã‚¦ã‚¹ã§ã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ãŒã€Capybara ã‹ã‚‰ã¯ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã¨ã„ã†ã€‚

```
*** Selenium::WebDriver::Error::ElementClickInterceptedError Exception:
element click intercepted: Element <button>...</button> is not clickable at point (1503, 193).
Other element would receive the click: <div class="foo"></div>
```

ã“ã‚Œã¯ `<div class="foo"></div>` ãŒé‚ªé­”ã—ã¦ `(1503, 193)` ã®åœ°ç‚¹ã«ã‚ã‚‹ç›®çš„ã® button ãŒæŠ¼ã›ãªã‹ã£ãŸã¨ã„ã†æ„å‘³ã€‚

ã“ã®å ´åˆã¯ã€é‚ªé­”ã—ã¦ã„ã‚‹è¦ç´ ã‚’æŠ¹æ®ºã™ã‚‹ã€‚

```ruby
Capybara.execute_script("document.querySelector('.foo').remove()")
```

## ç¢ºå®Ÿã«é¸æŠã§ãã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’å¾—ã‚‹

Developer Tool ã§è©²å½“ã‚¿ã‚°ã®ä½ç½®ã‚’ç¤ºã™æƒ…å ±ã‚’ `Copy Selector` ã§ã‚³ãƒ”ã‚‹

## `Copy Selector` ã§ã‚³ãƒ”ã£ãŸã®ã«é¸æŠã§ããªã„

- iframe ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ãŒåŸå› 
- within_frame(selector) ã§ iframe ã«ã‚¹ã‚³ãƒ¼ãƒ—ã™ã‚‹

```html:å¯¾è±¡ã®HTML
<html>
  <body>
    <iframe>
      <form></form>
    </iframe>
  </body>
</html>
```

```ruby
Capybara.has_selector?("form")     # => false
Capybara.within_frame("iframe") do
  Capybara.assert_selector("form") # => true
end
```

## `target="_blank"` ã§é–‹ã„ãŸã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹

```ruby
Capybara.switch_to_window(Capybara.windows.last)
```

## æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦ç§»å‹•ã—ã¦ä½•ã‹ã—ã¦é–‰ã˜ã¦æˆ»ã‚‹

```ruby
Capybara.within_window(Capybara.open_new_window) do
  # Capybara.visit("https://www.youtube.com/")
  # ä½•ã‹ã™ã‚‹
  Capybara.current_window.close
end
```

## ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

ä»Šã„ã‚‹ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
if Capybara.current_window != Capybara.windows.first
  Capybara.current_window.close
end
```

ä»–ã®ã‚¿ãƒ–ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹

```ruby
(Capybara.windows.drop(1) - [Capybara.current_window]).each(&:close)
```

å³å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows.drop(windows.find_index(current_window).next).each(&:close)
end
```

å·¦å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows[1...windows.find_index(current_window)].each(&:close)
end
```

- ã„ã¡ã°ã‚“å·¦ç«¯ã®ã‚¿ãƒ– `windows.first` ã¯ close ã§ããªã„
- close ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `Not allowed to close the primary window` ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

## JavaScript ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å–å¾—ã™ã‚‹

```ruby
p Capybara.evaluate_script("window.navigator.userAgent")
# >> "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36"
```

## D&Dã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

dropybara gem ã‚’è¿½åŠ ã™ã‚‹

```ruby
`convert logo: file.png`
Capybara.visit("https://css-tricks.com/examples/DragAndDropFileUploading/")
Capybara.page.drop_file("form", "file.png")
```

## ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ã—ã‚ˆã†ã¨ã—ãŸã‚‰è¿½è¨˜ã•ã‚Œã¦ã—ã¾ã†

```ruby
Capybara.find(".foo").set("xxx", clear: :backspace)
```

## ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãªã„ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã‹ãªã„

```ruby
Capybara.find(".foo").hover
```

## `command + a` ã§ã€ã™ã¹ã¦ã‚’é¸æŠ

```ruby
Capybara.find("html").send_keys [:command, "a"]
```

## ç”»é¢ã®ä¸€ç•ªä¸‹ã¾ã§ç§»å‹•ã™ã‚‹

```ruby
Capybara.find("html").send_keys(:end)
```

## YouTubeã§ç”»é¢ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦ã‚¹ã‚¯ã‚·ãƒ§ã‚’å–ã‚‹

```ruby
Capybara.visit("https://www.youtube.com/watch?v=Ftm2uv7-Ybw")
Capybara.current_window.resize_to(640, 480)
sleep(1)
Capybara.save_screenshot("youtube.png")
```

- YouTubeã¯ç”»é¢ã®ãƒªã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãŒã€ã‹ãªã‚Šã‚‚ã£ã•ã‚Šã‚†ã£ãŸã‚Šã¨åˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãªã®ã§ã€ã“ã®ã‚ãŸã‚Šã¯æ·±è¿½ã„ã›ãšè¦‹å½“ã¤ã‘ã¦ sleep ã‚’å…¥ã‚Œã‚‹ (å‰è¨€æ’¤å›)

## RSpec å®Ÿè¡Œæ™‚ã«ã‚¹ã‚¯ã‚·ãƒ§ã‚’é›†ã‚ã‚‹

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
  gem "rspec", require: "rspec/autorun"
end

Capybara.current_driver = :selenium_chrome_headless

RSpec.configure do |config|
  config.before(:example) do |ex|
    @full_description = ex.full_description
  end

  config.include Module.new {
    def image_save
      name = @full_description.gsub(/\s+/, "_")
      Capybara.save_screenshot("#{name}.png")
    end
  }
end

RSpec.describe "Browsing" do
  it "Google" do
    Capybara.visit("https://www.google.co.jp/")
    image_save
  end

  it "YouTube" do
    Capybara.visit("https://www.youtube.com/")
    image_save
  end
end
# >> ..
# >>
# >> Finished in 7.38 seconds (files took 0.11407 seconds to load)
# >> 2 examples, 0 failures
# >>
```

```shell
$ exa -al --no-user Browsing*.png
.rw-r--r-- 130k 18 5 12:24 Browsing_Google.png
.rw-r--r-- 621k 18 5 12:24 Browsing_YouTube.png
```

- å¼•æ•°ãªã—ã§ã‚‚ `save_screenshot` ã‚’å‘¼ã¹ã‚‹ãŒã€ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã¯ã€ã©ã“ã®ã‚¹ã‚¯ã‚·ãƒ§ã ã£ãŸã‹åˆ¤æ–­ã§ããªã„
- ãã®ãŸã‚ full_description ã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºã‚ã‚‹
- ã‚¹ã‚¯ã‚·ãƒ§ãŒæ¬²ã—ã„ã¨ã“ã‚ã« image_save ã‚’æ›¸ã„ã¦ãŠã
- ã‚‚ã£ã¨ä¾¿åˆ©ã™ã‚‹ãªã‚‰ image_save ã«å¼•æ•°ã‚’ã¤ã‘ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã«è¿½åŠ ã™ã‚‹

## è‡ªå‹•åŒ–å‡¦ç†ä¸­ã«çŠ¶æ³ã‚’çŸ¥ã‚‰ã›ã‚‹

è‡ªå‹•åŒ–å‡¦ç†ä¸­ã¯ç”»é¢ã‚’ãšã£ã¨è¦‹ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§æ¬¡ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã—ã¦ãŠãã€

```ruby
def say(message)
  system "say '#{message}'"
end
```

çŸ¥ã‚‰ã›ãŸã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã—ã‚ƒã¹ã‚‰ã›ã‚‹

```ruby
say "ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"
```

## è‡ªå‹•åŒ–ã®æ•µ reCAPTCHA ãŒå‡ºãŸã‚‰äººé–“ã«é ¼ã‚€

ã“ã‚“ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ãŠã„ã¦ã€

```ruby
def pause(message = "ä¸€æ™‚åœæ­¢")
  say message
  puts message
  gets
end
```

äººé–“ã®åŠ©ã‘ãŒå¿…è¦ãªã¨ã“ã‚ã§æŒŸã‚€

```ruby
pause "reCAPTCHA ã‚’å€’ã›"
```

## ä½¿ã„æ¨ã¦ã‚µãƒ³ãƒ—ãƒ«ãŒæ¬²ã—ã„

```ruby
require "bundler/inline"

gemfile(true) do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
end

Capybara.current_driver = :selenium_chrome

Capybara.visit "https://www.google.co.jp/"
Capybara.first("form input").set("Hello, world!")
Capybara.first("form input[type=submit]").click

gets
```
