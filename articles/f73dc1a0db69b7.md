---
title: "Capybara ã®çŸ¥è¦‹ã¾ã¨ã‚"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Capybara", "Ruby", "è‡ªå‹•åŒ–"]
published: false
---

## å‹•ä½œæ¤œè¨¼ç”¨ã®ä½¿ã„æ¨ã¦ã‚µãƒ³ãƒ—ãƒ«ãŒæ¬²ã—ã„

```ruby
require "bundler/inline"

gemfile(true) do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
end

Capybara.current_driver = :selenium_chrome

Capybara.visit "https://www.google.co.jp/"
Capybara.first("form input").set("Hello, world!")
Capybara.first("form input[type=submit]").click

gets
```

## Selenium ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è­¦å‘ŠãŒå‡ºã‚‹

```
WARN Selenium [DEPRECATION] [:browser_options] :options as a parameter for driver initialization is deprecated. Use :capabilities with an Array of value capabilities/options if necessary instead.
```

- capybara ãŒå¤ã„ã®ãŒåŸå› 
- 3.37.1 ä»¥ä¸Šã ã¨è­¦å‘Šã¯å‡ºãªã‹ã£ãŸ

## chromedriver ãŒãªã„ã¨è¨€ã‚ã‚Œã‚‹

```
Failure/Error: raise Error::WebDriverError, self.class.missing_text unless path

Selenium::WebDriver::Error::WebDriverError:
  Unable to find chromedriver. Please download the server from
  https://chromedriver.storage.googleapis.com/index.html and place it somewhere on your PATH.
  More info at https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver.
```

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šã‚Šã«æŒ‡å®šã®URLã‹ã‚‰ chromedriver ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ PATH ã‚’è¨­å®šã™ã‚‹ã€ãªã©ã—ã¦ã¯ã„ã‘ãªã„
- webdrivers gem ã‚’å…¥ã‚Œã‚‹

## chromedriver ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã©ã“ã«ã‚ã‚‹ï¼Ÿ

```shell
$ exa -al --no-user ~/.webdrivers
.rwxr-xr-x 17M 10 7  2021 chromedriver
.rw-r--r--  13 16 5 06:23 chromedriver.version
```

## chromedriver ãŒã‚ã‚‹ã®ã«æ­£ã—ãå‹•ä½œã—ãªã„

- Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ãªã„ã®ã‹ã‚‚ã—ã‚Œãªã„
  - Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ `chrome://settings/help` ã§ã‚ã‹ã‚‹
  - chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ `cat ~/.webdrivers/chromedriver.version` ã§ã‚ã‹ã‚‹
- Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ70ä»¥ä¸Šã§ã‚ã‚Œã° Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¸€è‡´ã™ã‚‹ã€ã¨ webdrivers gem ã® README ã«æ›¸ã„ã¦ã‚ã‚‹
  - ã—ã‹ã— Google Chrome ãŒè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚ŒãŸç›´å¾Œã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒã¾ã ç”¨æ„ã•ã‚Œã¦ãªã„ã“ã¨ãŒã‚ã£ãŸ
  - ãã‚Œã§ä¸€å›äº‹æ•…ã£ã¦å¤§å¤‰ãªç›®ã«ã‚ã£ãŸã“ã¨ãŒã‚ã‚‹ã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è‡´èª¬ã«ã¯ç–‘å¿µã‚’æŒã£ã¦ã„ã‚‹
  - ãªã®ã§è‡ªåˆ†ã®ã¨ã“ã‚ã§ã¯ Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç„¡ç†ã‚„ã‚Šå›ºå®šã—ã¦ã„ã‚‹
- çµ¶å¯¾ã«äº‹æ•…ã‚‰ãªã„ä½•ã‹è‰¯ã„æ–¹æ³•ã¯ãªã„ã‚“ã ã‚ã†ã‹ï¼Ÿ(èª°ã‹ãŠã›ãƒ¼ã¦)

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« chromedriver ãŒã‚ã‚‹

```shell
$ which chromedriver
/usr/local/var/rbenv/shims/chromedriver
```

- ãã‚Œã¯ chromedriver-helper gem ã®æ®‹éª¸
- ä»–ã«ã‚‚ chromedriver ã§å§‹ã¾ã‚‹å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¯ãš
- å…¨éƒ¨æŠ¹æ®ºã—ã‚ˆã†

```shell
$ rm /usr/local/var/rbenv/shims/chromedriver*
```

## ã¾ãŸ chromedriver ãŒå‡ºã¦ããŸ

```shell
$ which chromedriver
/usr/local/bin/chromedriver
```

- ãã‚Œã¯ `brew install chromedriver` ã§å…¥ã‚ŒãŸã‚„ã¤
- æŠ¹æ®ºã—ã‚ˆã†

```shell
$ brew uninstall chromedriver
```

## rack application ãŒå¿…è¦ã ã¨ã‹è¨€ã‚ã‚Œã‚‹

```shell
rack-test requires a rack application, but none was given (ArgumentError)
```

- ãã‚Œã¯è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ current_driver ã« :selenium_chrome ã‚’æŒ‡å®šã™ã‚‹

```ruby
Capybara.current_driver = :selenium_chrome
```

## `require "capybara/dsl"` ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ

- ã„ã‚ã„ã‚çŸ­ã‹ãæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹
- Capybara.page ã§ Capybara.current_session ã‚’å‘¼ã¹ã‚‹ã‚ˆã†ã«ãªã‚‹
- Capybara.page ã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Capybara ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã«å®šç¾©ã•ã‚Œã‚‹
- ã¤ã¾ã‚Š Capybara.current_session.xxx ãŒ Capybara.xxx ã¨æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹

## å¾…ã¡ç§’æ•°ã‚’å¤‰æ›´ã™ã‚‹

å…¨ä½“
```ruby
Capybara.default_max_wait_time = 2
```

å±€æ‰€çš„
```ruby
Capybara.using_wait_time(1) do
  Capybara.default_max_wait_time # => 1
end
```

æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã ã‘
```ruby
Capybara.assert_title("Google", wait: 1)
```

- ãƒãƒƒãƒã—ãªã„ã¨ãã«ã“ã‚Œã‚’å¢—ã‚„ã—ãŒã¡ã ã‘ã©ã“ã‚Œã§è§£æ±ºã™ã‚‹ã“ã¨ã¯ã»ã¼ãªã„
- ãªã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 2 ã®ã¾ã¾ã§è‰¯ã„
- ä¾‹å¤–çš„ã« App Store Connect ã®ã‚ˆã†ãªæ¿€é‡ã‚µã‚¤ãƒˆã§ã‚ã‚Œã°å¢—ã‚„ã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œãªã„

## é€”ä¸­ã§æ­¢ã‚ã¦DOMã®æ§‹é€ ã‚’èª¿ã¹ã‚‹

- byebug gem ã‚’å…¥ã‚Œã‚‹
- æœ¬å½“ã¯ debug gem ã®æ–¹ãŒã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒ eshell ã‹ã‚‰ãªãœã‹å‹•ã‹ãªã„ã®ã§ byebug ã«ã—ã¦ã„ã‚‹
- ã•ãã•ãèª¿ã¹ãŸã„ã®ã§ default_max_wait_time ã‚’ 0 ã«ã—ã¦ã‹ã‚‰ debugger ã‚’èµ·å‹•ã™ã‚‹

```ruby
Capybara.using_wait_time(0) { debugger }
```

- snippet çš„ãªã‚„ã¤ã§ã™ãã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã“ã†

## å¾…ã¤

assert_xxx ç³»ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãã®çŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…ã¤ã®ã«ä½¿ãˆã‚‹

## æŒ‡å®šã®è¦ç´ ãŒ1ä»¶ã«ãªã‚‹ã¾ã§å¾…ã¤

- ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ¤œç´¢ãªã©ã§çµæœã®æ•°ãŒå¤‰å‹•ã™ã‚‹å ´åˆã«æœ‰ç”¨

```ruby
Capybara.assert_selector(".row", count: 1)
```

## æŒ‡å®šã®URLã«ãªã‚‹ã¾ã§å¾…ã¤

```ruby
Capybara.visit("https://www.youtube.com/results?search_query=ruby")
Capybara.assert_current_path("/results?search_query=ruby")
```

`Capybara.current_path` ã§ã‚‚ãƒ‘ã‚¹ãŒã‚ã‹ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦æ¬¡ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¯ã„ã‘ãªã„ã€‚

```ruby:é–“é•ã£ãŸä¾‹
raise unless Capybara.current_path == "/results"
```

ãã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ç½®ãæ›ãˆã‚‹ã€‚

```ruby:æ­£ã—ã„ä¾‹ (ã‚¯ã‚¨ãƒªéƒ¨åˆ†ã¯æ¯”è¼ƒã—ãªã„)
Capybara.assert_current_path("/results", ignore_query: true)
```

## `target="_blank"` ã§é–‹ã„ãŸã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹

```ruby
Capybara.switch_to_window(Capybara.windows.last)
```

## D&Dã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ï¼Ÿ

dropybara gem ã‚’è¿½åŠ ã™ã‚‹

```ruby
`convert logo: file.png`
Capybara.visit("https://css-tricks.com/examples/DragAndDropFileUploading/")
Capybara.page.drop_file("form", "file.png")
```

## ãƒã‚¦ã‚¹æ“ä½œã§ã¯æŠ¼ã›ã‚‹ã®ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰é¸æŠã§ããªã„

é˜»å®³ã—ã¦ã„ã‚‹ DOM ã‚’æ¢ã—å‡ºã—ã¦æŠ¹æ®ºã™ã‚‹

```ruby
Capybara.execute_script("document.querySelector('.foo').remove()")
```

## ç¢ºå®Ÿã«é¸æŠã§ãã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’å¾—ã‚‹

- Developer Tool ã§è©²å½“ã‚¿ã‚°ã®ä½ç½®ã‚’ç¤ºã™æƒ…å ±ã‚’ `Copy Selector` ã§ã‚³ãƒ”ã‚‹

## YouTubeã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”»é¢ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦ã‚¹ã‚¯ã‚·ãƒ§ã‚’å–ã‚‹

```ruby
Capybara.visit("https://www.youtube.com/watch?v=Ftm2uv7-Ybw")
Capybara.current_window.resize_to(640, 480)
sleep(1)
Capybara.save_screenshot("youtube.png")
```

- YouTubeã¯ç”»é¢ã®ãƒªã‚µã‚¤ã‚ºã«å¿œã˜ã¦åˆ‡ã‚Šæ›¿ã‚ã‚‹é€Ÿåº¦ãŒé…ã„
- ã“ã®ã‚ãŸã‚Šã¯è¦‹å½“ã¤ã‘ã¦ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚ŒãŸæ–¹ãŒã‚ˆã„ã ã‚ã†

## RSpec å®Ÿè¡Œæ™‚ã«ã‚¹ã‚¯ã‚·ãƒ§ã‚’é›†ã‚ã‚‹

## App Store Connect ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„
