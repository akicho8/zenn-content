---
title: "Capybara ã®çŸ¥è¦‹ã¾ã¨ã‚"
emoji: "ğŸ¦«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Capybara", "Ruby", "è‡ªå‹•åŒ–"]
published: false
---

Capybara ã§ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’åŠè‡ªå‹•åŒ–ã™ã‚‹éš›ã«å¾—ãŸçŸ¥è¦‹ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« chromedriver ãŒã‚ã‚‹

```shell
$ which chromedriver
/usr/local/var/rbenv/shims/chromedriver
```

- ãã‚Œã¯ chromedriver-helper gem ã®æ®‹éª¸
- ä»–ã«ã‚‚ chromedriver ã§å§‹ã¾ã‚‹å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¯ãš
- gem ã‚‚å«ã‚ã¦æŠ¹æ®ºã™ã‚‹

```shell
$ gem uni -ax chromedriver-helper
$ rm /usr/local/var/rbenv/shims/chromedriver*
```

## ã¾ãŸ chromedriver ãŒå‡ºã¦ããŸ

```shell
$ which chromedriver
/usr/local/bin/chromedriver
```

- ãã‚Œã¯ `brew install chromedriver` ã§å…¥ã‚ŒãŸã‚„ã¤
- æŠ¹æ®ºã™ã‚‹

```shell
$ brew uninstall chromedriver
```

## chromedriver ãŒãªã„

```
Failure/Error: raise Error::WebDriverError, self.class.missing_text unless path

Selenium::WebDriver::Error::WebDriverError:
  Unable to find chromedriver. Please download the server from
  https://chromedriver.storage.googleapis.com/index.html and place it somewhere on your PATH.
  More info at https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver.
```

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šã‚Šã«ã€Œã“ã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ PATH ã‚’è¨­å®šã€ã—ã¦ã¯ã„ã‘ãªã„
- webdrivers gem ã‚’ä½¿ã†

## chromedriver ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã©ã“ã«ã‚ã‚‹ï¼Ÿ

```shell
$ exa -al --no-user ~/.webdrivers
.rwxr-xr-x 17M 10 7  2021 chromedriver
.rw-r--r--  13 16 5 06:23 chromedriver.version
```

## chromedriver ãŒã‚ã‚‹ã®ã«å‹•ä½œã—ãªã„

- Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ãªã„
- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã™ãã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

```shell:~/bin/capybara-version-check
"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version
~/.webdrivers/chromedriver --version
```

- Google Chrome ãŒ 70 ä»¥ä¸Šã§ã‚ã‚Œã° chromedriver ã¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¸€è‡´ã™ã‚‹ã€ã¨ webdrivers ã® README ã«æ›¸ã„ã¦ã‚ã‚‹
- ã—ã‹ã— Google Chrome ãŒè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚ŒãŸç›´å¾Œã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒç”¨æ„ã•ã‚Œã¦ãªã„ã“ã¨ãŒã‚ã£ãŸ
- ãã‚Œã§ä¸€å›äº‹æ•…ã£ã¦å¤§å¤‰ãªç›®ã«ã‚ã£ãŸã®ã§ã€æ™‚å·®ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ç–‘ã£ã¦ã„ã‚‹
- ãŸã æ˜”ã®ã“ã¨ã§è¨˜æ†¶ãŒæ€ªã—ã„ã‘ã©ã€ã‚‚ã—ã‹ã—ãŸã‚‰ brew ã® chromedriver ã¨ chromedriver-helper gem ã¨ webdrivers gem ãŒä½•ã‚’ã™ã‚‹ã‚‚ã®ã‹æ­£ç¢ºã«æŠŠæ¡ã§ãã¦ãŠã‚‰ãš webdrivers gem ã‚’æ­£ã—ãä½¿ãˆã¦ãªã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚ã‚‚ã—ãã†ãªã‚‰ webdrivers ã«ã¯ã™ã¾ã‚“

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ãªã„äº‹æ•…ã‚’é˜²ã

### æ–¹æ³•1. Google Chrome ã‚’è‡ªå‹•æ›´æ–°ã•ã›ãªã„

ã“ã‚Œãªã‚‰çµ¶å¯¾ã«ãšã‚Œãªã„ã€‚

ã¾ãšæ›´æ–°ãƒã‚§ãƒƒã‚¯é »åº¦ã‚’ 0 ã«ã™ã‚‹ã€‚

```shell
defaults write com.google.Keystone.Agent checkInterval 0
```

ãã—ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æŠ¹æ®ºï¼†ãƒ€ãƒŸãƒ¼ã«ç½®ãæ›ãˆã‚‹ã€‚
~/Library å´

```shell
sudo rm -R ~/Library/Google/GoogleSoftwareUpdate/
sudo touch ~/Library/Google/GoogleSoftwareUpdate
sudo chmod 444 ~/Library/Google/GoogleSoftwareUpdate
sudo rm ~/Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R ~/Library/Caches/com.google.Keystone*
sudo rm ~/Library/Preferences/com.google.Keystone.Agent.plist
```

/Library å´

```shell
sudo rm -R /Library/Google/GoogleSoftwareUpdate/
sudo touch /Library/Google/GoogleSoftwareUpdate
sudo chmod 444 /Library/Google/GoogleSoftwareUpdate
sudo rm /Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R /Library/Caches/com.google.Keystone*
sudo rm /Library/Preferences/com.google.Keystone.Agent.plist
```

ä¸Šã®æ‰‹é †ã¯ã‹ãªã‚Šæ˜”ã®ä½œæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã²ã£ã±ã£ã¦ããŸã‚‚ã®ãªã®ã§ç¾åœ¨ãã®é€šã‚Šã«ã—ã¦æœŸå¾…é€šã‚Šã«ãªã‚‹ã‹ã¯ã‚ã‹ã‚‰ãªã„ (ã˜ã‚ƒãè¼‰ã›ã‚“ãªã€‚å±ãªã„ã—)

### æ–¹æ³•2. ã„ã–äº‹æ•…ã£ãŸã‚‰æ‰‹å‹•ã§æˆ»ã™

ãã®ãŸã‚ã«æ—¥ã€…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãŠãã€‚

```sh:~/bin/capybara-env-backup.sh
#!/bin/sh
# (cd /Applications && rm -fr .git)
# (cd ~/.webdrivers && rm -fr .git)
# exit

cd /Applications
[ ! -d .git ] && git init -q
git add -A "Google Chrome.app"
"./Google Chrome.app/Contents/MacOS/Google Chrome" --version | git commit -uno -F -

cd ~/.webdrivers
[ ! -d .git ] && git init -q
git add -A
./chromedriver --version | git commit -F -
```

ã“ã‚Œã‚’ cron ã«ã‚»ãƒƒãƒˆã—ã¦ãŠãã€‚

webdrivers ã¯ Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ãŸ chromedriver ã‚’ç”¨æ„ã—ã¦ãã‚Œã‚‹ã¯ãšãªã®ã§ ~/.webdrivers ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä¿¡ç”¨ã§ããªã„ã»ã©ã«äº‹æ•…ã‚’æã‚Œã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚‚ã—ã£ã‹ã‚Šç®¡ç†ä¸‹ã«å…¥ã‚Œã¦ã™ãæˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

ãã‚Œã¨ã€ã„ã–ã¨ã„ã†ã¨ãã« `/Applications/Google Chrome.app` ã ã‘ã‚’éå»ã«æˆ»ã—ã¦èµ·å‹•ã™ã‚‹ã®ã‹ä¸å®‰ã§ã¯ã‚ã‚‹ãŒã€ãã‚Œã¯é‹ã‚’å¤©ã«ä»»ã›ã‚‹ã€‚ã¨ã‚Šã‚ãˆãšå¸¸æ™‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ããŸã„å ´åˆã¯ã“ã£ã¡ã®æ–¹ãŒã‚ˆã„ã€‚

### æ–¹æ³•3. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼

çµå±€ã“ã†ã—ãŸ

1. 1ã¤ç›®ã®æ–¹æ³•ã§è‡ªå‹•æ›´æ–°ã‚’æ­¢ã‚ã‚‹
1. 2ã¤ç›®ã®æ–¹æ³•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚å–ã‚‹
1. ãã®ä¸Šã§ã€æœˆã«1å›ã»ã©æ‰‹å‹•ã§ Google Chrome ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹
    - å…·ä½“çš„ã«ã¯æ™®é€šã«æ–°è¦ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ /Applications ã«ã‚³ãƒ”ã‚‹
    - ã™ãã« webdrivers ã‚’èª­ã¿è¾¼ã‚“ã§åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒå…¥ã£ãŸã‹ç¢ºèªã™ã‚‹

## Selenium ã§è­¦å‘ŠãŒå‡ºã‚‹

```
WARN Selenium [DEPRECATION] [:browser_options] :options as a parameter for driver initialization is deprecated. Use :capabilities with an Array of value capabilities/options if necessary instead.
```

- capybara ãŒå¤ã„ã®ãŒåŸå› 
- ã©ã“ã§ç›´ã£ãŸã®ã‹ã¯ã‚ã‹ã‚‰ã‚“ã‘ã© 3.37.1 ä»¥ä¸Šã ã¨è­¦å‘Šã¯å‡ºãªããªã£ã¦ã„ãŸ
  - ãŸã  3.37.1 ã«ã™ã‚‹ã«ã¯ Ruby 2.7.0 ä»¥ä¸Šã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹

## rack application ãŒå¿…è¦ã ã¨è¨€ã‚ã‚Œã‚‹

```shell
rack-test requires a rack application, but none was given (ArgumentError)
```

è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ current_driver ã« :selenium_chrome ã‚’æŒ‡å®šã™ã‚‹ã€‚

```ruby
Capybara.current_driver = :selenium_chrome
```

## `require "capybara/dsl"` ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ

- ä¸€ã¤ã®ãƒ–ãƒ©ã‚¦ã‚¶ã—ã‹ä½¿ã‚ãªã„ã¨ã—ãŸä¸Šã§ã„ã‚ã„ã‚çŸ­ã‹ãæ›¸ã‘ã‚‹
- Capybara.page ã§ Capybara.current_session ã‚’å‘¼ã¹ã‚‹
- Capybara.page ã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Capybara ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã«ç”Ÿãˆã‚‹
- ã¤ã¾ã‚Š Capybara.xxx ã¯ Capybara.current_session.xxx ã‚’å‘¼ã¶

## Capybara.xxx ã¨æ›¸ãã®ãŒé¢å€’

ã“ã‚Œã§ `Capybara.` ãŒçœç•¥ã§ãã‚‹

```ruby
class App
  include Capybara::DSL

  def run
    visit "https://www.google.co.jp/"
  end
end

App.new.run
```

ã—ã‹ã—ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ›–æ˜§ã«ãªã‚‹ã®ã§ã„ã‚„ã€‚
ã“ã‚“ãªã‚“ã§ã„ã„ã€‚

```ruby
module C
  extend Capybara::DSL
end

C.visit "https://www.google.co.jp/"
```

ãã‚Œãªã‚‰ `C = Capybara` ã§ã„ã„æ°—ã‚‚ã€‚

## é€”ä¸­ã§æ­¢ã‚ã¦DOMã®æ§‹é€ ã‚’èª¿ã¹ã‚‹

- byebug gem ã‚’å…¥ã‚Œã‚‹
- æœ¬å½“ã¯ debug gem ã®æ–¹ãŒã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„
  - ãŒã€ eshell ã‹ã‚‰ãªãœã‹å‹•ã‹ãªã„ã®ã§ byebug ã«ã™ã‚‹
  - å…·ä½“çš„ã«ã¯ debug gem ãŒä½¿ã£ã¦ã„ã‚‹ irb ãŒå‹•ã‹ãªã„
- ã•ãã•ãèª¿ã¹ãŸã„ã®ã§ default_max_wait_time ã‚’ 0 ã«ã—ã¦ã‹ã‚‰ debugger ã‚’èµ·å‹•ã™ã‚‹

```ruby
Capybara.using_wait_time(0) { debugger }
```

- snippet çš„ãªã‚„ã¤ã§ã™ãã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

## ãƒ­ãƒ¼ã‚«ãƒ«ã® HTML ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã‚ãªã„

- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ `open foo.html` ã§é–‹ã‘ã‚‹ã®ã§ `Capybara.visit("foo.html")` ã§é–‹ã„ã¦ãã‚Œã¦ã‚‚è‰¯ã•ãã†ã ã‘ã©é–‹ã‘ãªã„
  - invalid argument ã¨è¨€ã‚ã‚Œã‚‹ã ã‘
- `file://` ã‹ã‚‰ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã«ã™ã‚‹

```ruby
file = Pathname("foo.html").expand_path
Capybara.visit("file://#{file}")
```

## å¾…ã¤

- assert_xxx ç³»ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãã®çŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…ã¤ã®ã«ä½¿ãˆã‚‹
- sleep ã‚’ä½¿ã£ãŸã‚‰è² ã‘ã ã¨æ€ãˆ

## å¾…ã¡ç§’æ•°ã‚’å¤‰æ›´ã™ã‚‹

æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã ã‘
```ruby
Capybara.assert_title("Google", wait: 1)
```

å±€æ‰€çš„
```ruby
Capybara.using_wait_time(1) do
  Capybara.default_max_wait_time # => 1
end
```

å…¨ä½“
```ruby
Capybara.default_max_wait_time = 2
```

- ãƒãƒƒãƒã—ãªã„ã¨ãã«ã¨ã‚Šã‚ãˆãšå€¤ã‚’å¤§ããã™ã‚Œã°ã„ã„ã‚“ã˜ã‚ƒã­ï¼Ÿ ã¨ã—ã¦ã—ã¾ã„ãŒã¡ã ã‘ã©ã€ã“ã‚Œã§è§£æ±ºã™ã‚‹ã“ã¨ã¯ã»ã¼ãªã„
- é€†ã«é€Ÿã‚„ã‹ã«å¤±æ•—ã®åˆ¤å®šã‚’ã—ã¦ã„ãŸéƒ¨åˆ†ã§æ™‚é–“ãŒã‹ã‹ã£ã¦åŠ¹ç‡ãŒæ‚ªããªã‚‹ã®ã§å¢—ã‚„ã™ãª
- ãªã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 2 ã®ã¾ã¾ã§è‰¯ã„ã€‚è§¦ã‚“ãª
- æŒ‡å®šã™ã‚‹ã¨ã—ãŸã‚‰ wait ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ã‘ã«ç•™ã‚ã‚‹

## æŒ‡å®šã®è¦ç´ ãŒ1ä»¶ã«ãªã‚‹ã¾ã§å¾…ã¤

- ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ¤œç´¢ã§çµæœã®æ•°ãŒå¤‰å‹•ã™ã‚‹å ´åˆã«æœ‰ç”¨

```ruby
Capybara.assert_selector(".row", count: 1)
```

## æŒ‡å®šã®URLã«ãªã‚‹ã¾ã§å¾…ã¤

```ruby
Capybara.visit("https://www.youtube.com/results?search_query=capybara")
Capybara.assert_current_path("/results?search_query=capybara")
```

`Capybara.current_path` ã§ãƒ‘ã‚¹ãŒã‚ã‹ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦æ¬¡ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¯ã„ã‘ãªã„ã€‚

```ruby:é–“é•ã£ãŸä¾‹
assert Capybara.current_path == "/results"
```

ä¸Šã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã‚‹ã¨ã€å‹•ã„ãŸã‚Šå‹•ã‹ãªã‹ã£ãŸã‚Šä¸å®‰å®šãªå‹•ä½œã«ãªã‚‹ã€‚
ãã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ç½®ãæ›ãˆã‚‹ã€‚

```ruby:æ­£ã—ã„ä¾‹ (ã‚¯ã‚¨ãƒªéƒ¨åˆ†ã¯æ¯”è¼ƒã—ãªã„)
Capybara.assert_current_path("/results", ignore_query: true)
```

## ãƒ©ãƒ™ãƒ«ã«æ­£ç¢ºã«ãƒãƒƒãƒã•ã›ã‚‹

```ruby
Capybara.visit("https://httpbin.org/forms/post")
Capybara.fill_in("Customer name:", with: "foo", exact: true)
```

- exact ã¯ **æ­£ç¢º** ã®æ„å‘³
- æ¯å› `exact: true` ã¨æ›¸ãçŠ¶æ³ãªã‚‰ `Capybara.exact = true` ã¨ã—ã¦ãŠã

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ `exact = true` ã«ã—ã¦ã—ã¾ã†ã¨ assert_text ã¾ã§å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã—ã¾ã†ï¼Ÿ

ãªã£ã¦ã—ã¾ã‚ãªã„

- ã‚ãˆã¦å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã«ã¯ `assert_text "xxx", exact: true` ã¨æ›¸ã
- `Capybara.exact_text = true` ã¨ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹
  - ãŒã€ã“ã‚ŒãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã¯ãªã„

## æ”¹è¡Œã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®å½±éŸ¿ã§ assert_text ã®åˆ¤å®šãŒæºã‚‰ã

```ruby
Capybara.assert_text("foo bar", normalize_ws: true)
```

- `normalize_ws: true` ã™ã‚‹ã¨å¯¾è±¡ã‚’ `gsub(/[[:space:]]+/, ' ').strip` ã™ã‚‹
- ãªã®ã§ ` foo \n bar ` ã«ã‚‚ `foo bar` ãŒãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«ãªã‚‹

## assert_text ã§ãƒãƒƒãƒã—ãªã„

- æƒ³å®šã™ã‚‹ç”»é¢ã«ãªã£ã¦ã„ãªã„ã®ãŒã»ã¨ã‚“ã©ã®åŸå› 
- ãƒ‡ãƒãƒƒã‚¬ã§æ­¢ã‚ã¦ä»¥ä¸‹ã‚’ç¢ºèª
  - `Capybara.title`
  - `Capybara.current_url`
  - `Capybara.page.text`
  - `Capybara.page.text.include?("xxx")`

## ãƒã‚¦ã‚¹æ“ä½œã§ã¯æŠ¼ã›ã‚‹ã®ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰æŠ¼ã›ãªã„

1. ã‚µã‚¤ãƒˆå´ã®ä»•çµ„ã¿ã§å‡¦ç†ä¸­ã®æ“ä½œã‚’ç¦æ­¢ã™ã‚‹ãŸã‚ç”»é¢ã‚’ div ã§è¦†ã£ã¦ã„ã‚‹
1. å‡¦ç†ãŒçµ‚ã‚ã£ã¦ç”»é¢ã‚’è¦†ã†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯æ¶ˆãˆãŸ
1. ã ãŒã€ç”»é¢ã‚’è¦†ã† div ãŒå®Œå…¨ã«ã¯å–ã‚Šé™¤ã‹ã‚Œã¦ã„ãªã„

ãã‚“ãªã¨ãã«ä¸æ•´åˆãŒèµ·ãã‚‹ã‚ˆã†ã ã€‚
ãƒã‚¦ã‚¹ã§ã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ãŒã€Capybara ã‹ã‚‰ã¯ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã¨ã„ã†ã€‚

```
*** Selenium::WebDriver::Error::ElementClickInterceptedError Exception:
element click intercepted: Element <button>...</button> is not clickable at point (1503, 193).
Other element would receive the click: <div class="foo"></div>
```

ã“ã‚Œã¯ `<div class="foo"></div>` ãŒé‚ªé­”ã—ã¦ `(1503, 193)` ã®åœ°ç‚¹ã«ã‚ã‚‹ç›®çš„ã® button ãŒæŠ¼ã›ãªã‹ã£ãŸã¨ã„ã†æ„å‘³ã€‚

ã“ã®å ´åˆã¯ã€é‚ªé­”ã™ã‚‹è¦ç´ ã‚’æŠ¹æ®ºã™ã‚‹ã€‚

```ruby
Capybara.execute_script("document.querySelector('.foo').remove()")
```

## ç¢ºå®Ÿã«é¸æŠã§ãã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’å¾—ã‚‹

- Developer Tool ã§è©²å½“ã‚¿ã‚°ã®ä½ç½®ã‚’ç¤ºã™æƒ…å ±ã‚’ `Copy Selector` ã§ã‚³ãƒ”ã‚‹
- ã‚ã¨ã®ã“ã¨ã¯çŸ¥ã‚‰ã‚“ã€ä»Šå‹•ã‘ã°ã„ã„â”€â”€å ´åˆã«æœ‰ç”¨

## `Copy Selector` ã§ã‚³ãƒ”ã£ãŸã®ã«é¸æŠã§ããªã„

- iframe ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ãŒåŸå› 
- within_frame(selector) ã§ iframe å†…ã«å…¥ã‚‹

```html
<body>
  <iframe>
    <form></form>
  </iframe>
</body>
```

```ruby
Capybara.has_selector?("form")     # => false
Capybara.within_frame("iframe") do
  Capybara.assert_selector("form") # => true
end
```

## xpath ã¯ä½¿ã†ãª

```html
<button>é€ä¿¡ã™ã‚‹</button>
```

ã«å¯¾ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã°ãƒãƒƒãƒã™ã‚‹ã€‚

```ruby
Capybara.assert_selector(:xpath, "//button[contains(text(), 'é€ä¿¡')]")
```

ã—ã‹ã— button ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ§‹é€ ãŒå°‘ã—å¤‰ã‚ã£ã¦æ¬¡ã®ã‚ˆã†ã«ãªã‚‹ã¨ã‚‚ã†ãƒãƒƒãƒã—ãªããªã‚‹ã€‚

```html
<button>
  <span>é€ä¿¡ã™ã‚‹</span>
</button>
```

ã“ã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã€‚

```ruby
Capybara.assert_selector(:xpath, "//button/span[contains(text(), 'é€ä¿¡')]")
```

ã‚‚ã†å°‘ã—æ±ç”¨åŒ–ã™ã‚‹ã¨ã‚¢ã‚¹ã‚¿ãƒªã‚¯ã‚¹ã‚’ä½¿ã£ã¦æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã€‚

```ruby
Capybara.assert_selector(:xpath, "//button/*[contains(text(), 'é€ä¿¡')]")
```

ã ã£ãŸã‚‰æœ€åˆã‹ã‚‰ãã†ã—ã¨ã‘ã°è‰¯ããªã„ã‹ã¨æ€ã†ã‘ã©ã“ã‚Œã ã¨ `<button>é€ä¿¡ã™ã‚‹</button>` ã«ã¯ãƒãƒƒãƒã—ãªã„ã€‚

ãã‚“ãªæ„Ÿã˜ã§ xpath ã¯å½“ãŸã‚ŠãŒå³ã—ããƒ¡ãƒ³ãƒ†ã‚‚ã—ã¥ã‚‰ããªã‚‹ã®ã§ä½¿ã†ãªã€‚

## ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã

```html
<button>
  <span>é€ä¿¡ã™ã‚‹</span>
</button>
```

xpath ã¨é•ã£ã¦ CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’æŒ‡å®šã§ããªã•ãã†ã ãŒ text ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚Œã°åå¿œã—ã¦ãã‚Œã‚‹ã€‚

```ruby
Capybara.assert_selector("button", text: "é€ä¿¡")
```

ã“ã‚Œã¯ `<button>é€ä¿¡ã™ã‚‹</button>` ã«ã‚‚ãƒãƒƒãƒã™ã‚‹ã€‚
ã§ã€find ã«ç½®ãæ›ãˆã¦ click ã™ã‚‹ã®ã¯ã“ã†ãªã‚‹ã€‚

```ruby
Capybara.find("button", text: "é€ä¿¡").click
```

ã‚‚ã£ã¨ç°¡å˜ã«æ›¸ããªã‚‰ã“ã†ãªã‚‹ã€‚

```ruby
Capybara.click_on("é€ä¿¡")
Capybara.click_button("é€ä¿¡")
Capybara.click_link_or_button("é€ä¿¡")
```

## HTMLã‚’è‡ªåˆ†ã§ç”¨æ„ã—ã¦æ¤œè¨¼ã™ã‚‹

å®Ÿéš›ã®ã‚µã‚¤ãƒˆã®æ·±éƒ¨ã«è¡Œãã®ãŒé›£ã—ã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«å†ç¾ã—ãŸHTMLã§æ¤œè¨¼ã™ã‚‹ã€‚

```ruby
require "tempfile"

SOURCE = <<~EOT
<div>
  <button>é€ä¿¡</button>
</div>
EOT

path = Tempfile.open(["", ".html"]) { |e| e.tap { |e| e << SOURCE } }.path
Capybara.visit("file://#{path}")

Capybara.assert_selector("button")
```

- å®Ÿéš›ã®ã‚µã‚¤ãƒˆã§å‹•ä½œæ¤œè¨¼ã‚’é‡ã­ã¦ã„ã‚‹ã¨æ€ªã—ã¾ã‚Œã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œå…¼ã­ã‚“ã®ã§ãã†ã„ã†æ„å‘³ã§ã‚‚ãªã‚‹ã¹ããƒ­ãƒ¼ã‚«ãƒ«ã§è¡Œã†
- HTML ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ `Capybara.save_page("foo.html")` ã¨ã™ã‚‹
- Ruby ã® Tempfile ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚‚ã†ã¡ã‚‡ã£ã¨ä½¿ã„ã‚„ã™ããªã£ã¦ãã‚Œã‚‹ã¨ã‚ã‚ŠãŒãŸã„(å°å£°)

## xpath ã§æ··ä¹±ã—ã¦ããŸ

ã©ã†ã—ã¦ã‚‚ä½¿ã‚ãªã„ã¨ã„ã‘ãªã„ã¨ãç”¨ã®ä¾¿åˆ©ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

https://qiita.com/rllllho/items/cb1187cec0fb17fc650a

## `target="_blank"` ã§é–‹ã„ãŸã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹

```ruby
Capybara.switch_to_window(Capybara.windows.last)
```

## æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦ç§»å‹•ã—ã¦ä½•ã‹ã—ã¦é–‰ã˜ã¦æˆ»ã‚‹

```ruby
Capybara.within_window(Capybara.open_new_window) do
  # Capybara.visit("https://www.youtube.com/")
  # ä½•ã‹ã™ã‚‹
  Capybara.current_window.close
end
```

## ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

ä»Šã„ã‚‹ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
if Capybara.current_window != Capybara.windows.first
  Capybara.current_window.close
end
```

ä»–ã®ã‚¿ãƒ–ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹

```ruby
(Capybara.windows.drop(1) - [Capybara.current_window]).each(&:close)
```

å³å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows.drop(windows.find_index(current_window).next).each(&:close)
end
```

å·¦å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows[1...windows.find_index(current_window)].each(&:close)
end
```

ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.reset!
```

- ã„ã¡ã°ã‚“å·¦ç«¯ã®ã‚¿ãƒ– `windows.first` ã¯ close ã§ããªã„
- close ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `Not allowed to close the primary window`

## JavaScript ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å–å¾—ã™ã‚‹

```ruby
p Capybara.evaluate_script("window.navigator.userAgent")
# >> "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36"
```

## D&Dã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

dropybara gem ã‚’è¿½åŠ ã™ã‚‹

```ruby
`convert logo: file.png`
Capybara.visit("https://css-tricks.com/examples/DragAndDropFileUploading/")
Capybara.page.drop_file("form", "file.png")
```

## ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« set ã—ãŸã¤ã‚‚ã‚ŠãŒè¿½è¨˜ã•ã‚Œã¦ã—ã¾ã†

```ruby
Capybara.find(".foo").set("xxx", clear: :backspace)
```

## ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãªã„ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã‹ãªã„

```ruby
Capybara.find(".foo").hover
```

## `command + a` ã§ã€ã™ã¹ã¦ã‚’é¸æŠ

```ruby
Capybara.find("html").send_keys([:command, "a"])
```

## ç”»é¢ã®ä¸€ç•ªä¸‹ã¾ã§ç§»å‹•ã™ã‚‹

```ruby
Capybara.find("html").send_keys(:end)
```

## ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã‚‹

```ruby
module Clipboard
  extend self

  def write(text)
    IO.popen("pbcopy", "w") { |io| io.write(text) }
  end

  def read
    IO.popen("pbpaste", &:read)
  end
end

Clipboard.write("")
Capybara.visit("https://www.ruby-lang.org/ja/")
Capybara.find("html").send_keys([:command, "a"])
Capybara.find("html").send_keys([:command, "c"])
puts Clipboard.read.lines.take(2)
# >> Ruby
# >> A PROGRAMMER'S BEST FRIEND
```

## JavaScript ã‚’ä½¿ã£ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«å…¥ã‚Œã‚‹

```ruby
Clipboard.write("")
Capybara.visit("https://www.google.co.jp/")
Capybara.execute_script("await navigator.clipboard.writeText('foo')")
Clipboard.read # => "foo"
Capybara.first("form input").send_keys([:command, "v"])
```

## YouTubeã§ç”»é¢ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦ã‚¹ã‚¯ã‚·ãƒ§ã‚’å–ã‚‹

```ruby
Capybara.visit("https://www.youtube.com/watch?v=Ftm2uv7-Ybw")
Capybara.current_window.resize_to(640, 480)
sleep(1)
Capybara.save_screenshot("youtube.png")
```

- YouTubeã¯ç”»é¢ã®ãƒªã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãŒã€ã‹ãªã‚Šã‚‚ã£ã•ã‚Šã‚†ã£ãŸã‚Šã¨åˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãªã®ã§ã€ã“ã®ã‚ãŸã‚Šã¯æ·±è¿½ã„ã›ãšè¦‹å½“ã¤ã‘ã¦ sleep ã‚’å…¥ã‚Œã‚‹ (å‰è¨€æ’¤å›)

## RSpec å®Ÿè¡Œæ™‚ã«ã‚¹ã‚¯ã‚·ãƒ§ã‚’é›†ã‚ã‚‹

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
  gem "rspec", require: "rspec/autorun"
end

Capybara.current_driver = :selenium_chrome_headless

RSpec.configure do |config|
  config.before(:example) do |ex|
    @full_description = ex.full_description
  end

  config.include Module.new {
    def image_save
      name = @full_description.gsub(/\s+/, "_")
      Capybara.save_screenshot("#{name}.png")
    end
  }
end

RSpec.describe "Browsing" do
  it "Google" do
    Capybara.visit("https://www.google.co.jp/")
    image_save
  end

  it "YouTube" do
    Capybara.visit("https://www.youtube.com/")
    image_save
  end
end
# >> ..
# >>
# >> Finished in 7.38 seconds (files took 0.11407 seconds to load)
# >> 2 examples, 0 failures
# >>
```

```shell
$ exa -al --no-user Browsing*.png
.rw-r--r-- 130k 18 5 12:24 Browsing_Google.png
.rw-r--r-- 621k 18 5 12:24 Browsing_YouTube.png
```

- save_screenshot ã‚’å‘¼ã‚“ã§ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã¯ã©ã“ã®ã‚¹ã‚¯ã‚·ãƒ§ã ã£ãŸã‹åˆ¤æ–­ã§ããªã„
- ã‹ã¨ã„ã£ã¦ã€ã„ã¡ã„ã¡ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ãŸããªã„
- ã®ã§ full_description ã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºã‚ã‚‹
- ã‚¹ã‚¯ã‚·ãƒ§ãŒæ¬²ã—ã„ã¨ã“ã‚ã« image_save ã‚’ç½®ã

## è‡ªå‹•åŒ–å‡¦ç†ä¸­ã«çŠ¶æ³ã‚’çŸ¥ã‚‰ã›ã‚‹

ã“ã‚Œã‚’å®šç¾©ã—ã¨ã„ã¦

```ruby
def say(message)
  system "say '#{message}'"
end
```

çŸ¥ã‚‰ã›ãŸã„ã¨ã“ã‚ã«ç½®ã„ã¨ã

```ruby
say "ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"
```

## è‡ªå‹•åŒ–ã®æ•µ reCAPTCHA ãŒå‡ºãŸã‚‰äººé–“ã«é ¼ã‚€

ã“ã‚Œã‚’å®šç¾©ã—ã¨ã„ã¦

```ruby
def pause(message = "ä¸€æ™‚åœæ­¢")
  say message
  puts message
  gets
end
```

äººé–“ã®åŠ©ã‘ãŒå¿…è¦ãªã¨ã“ã‚ã«æŒŸã‚€

```ruby
pause "reCAPTCHA ã‚’å€’ã›"
```

## visit ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹

GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

```ruby
require "active_support/core_ext/object/to_query"
require "active_support/core_ext/object/blank"

Capybara::Session.prepend Module.new {
  def visit(uri, params = {})
    super [uri, params.to_query.presence].compact.join("?")
  end
}

Capybara.visit("https://www.google.co.jp/search", q: "foo")
```

## ä½¿ã„æ¨ã¦ã‚µãƒ³ãƒ—ãƒ«

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
end

Capybara.current_driver = :selenium_chrome

Capybara.visit "https://www.google.co.jp/"
Capybara.first("form input").set("foo")
Capybara.first("form input[type=submit]").click

gets
```
