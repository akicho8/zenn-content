---
title: "Capybaraã§ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œè‡ªå‹•åŒ–ã®çŸ¥è¦‹ã¾ã¨ã‚"
emoji: "ğŸ¦«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Capybara", "Ruby", "è‡ªå‹•åŒ–"]
published: true
---

é¢å€’ãªä½œæ¥­ã‚’å…¨éƒ¨ Capybara ã«ã‚„ã£ã¦ã‚‚ã‚‰ã£ã¦ã„ã‚‹ã†ã¡ã«ã„ã‚ã‚“ãªãƒã‚¦ãƒã‚¦ãŒæºœã£ãŸã®ã§å‚™å¿˜éŒ²ã‚’å…¼ã­ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« chromedriver ãŒã‚ã‚‹

```shell
$ which chromedriver
/usr/local/var/rbenv/shims/chromedriver
```

- ãã‚Œã¯ chromedriver-helper gem ã®æ®‹éª¸
- ä»–ã«ã‚‚ chromedriver ã§å§‹ã¾ã‚‹å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¯ãš
- gem ã‚‚å«ã‚ã¦æŠ¹æ®ºã™ã‚‹

```shell
$ gem uni -ax chromedriver-helper
$ rm /usr/local/var/rbenv/shims/chromedriver*
```

## ã¾ãŸ chromedriver ãŒå‡ºã¦ããŸ

```shell
$ which chromedriver
/usr/local/bin/chromedriver
```

- ãã‚Œã¯ `brew install chromedriver` ã§å…¥ã‚ŒãŸã‚„ã¤
- æŠ¹æ®ºã™ã‚‹

```shell
$ brew uninstall chromedriver
```

## chromedriver ãŒãªã„

```
Failure/Error: raise Error::WebDriverError, self.class.missing_text unless path

Selenium::WebDriver::Error::WebDriverError:
  Unable to find chromedriver. Please download the server from
  https://chromedriver.storage.googleapis.com/index.html and place it somewhere on your PATH.
  More info at https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver.
```

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šã‚Šã«ã€Œã“ã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ PATH ã‚’è¨­å®šã€ã—ã¦ã¯ã„ã‘ãªã„
- webdrivers gem ã‚’ä½¿ã†

## chromedriver ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã©ã“ã«ã‚ã‚‹ï¼Ÿ

```shell
$ exa -al --no-user ~/.webdrivers
.rwxr-xr-x 17M 10 7  2021 chromedriver
.rw-r--r--  13 16 5 06:23 chromedriver.version
```

## chromedriver ãŒã‚ã‚‹ã®ã«å‹•ä½œã—ãªã„

- Google Chrome ã¨ chromedriver ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ãªã„
- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã™ãã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

```shell:~/bin/capybara-version-check
"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version
~/.webdrivers/chromedriver --version
```

- Google Chrome ãŒ 70 ä»¥ä¸Šã§ã‚ã‚Œã° chromedriver ã¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¸€è‡´ã™ã‚‹ã¨ webdrivers ã® README ã«æ›¸ã„ã¦ã‚ã‚‹
- ã—ã‹ã— Google Chrome ãŒè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚ŒãŸç›´å¾Œã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒç”¨æ„ã•ã‚Œã¦ãªã„ã“ã¨ãŒã‚ã£ãŸ
- ãã‚Œã§ä¸€å›äº‹æ•…ã£ã¦å¤§å¤‰ãªç›®ã«ã‚ã£ãŸã®ã§æ™‚å·®ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ç–‘ã£ã¦ã„ã‚‹
- ãŸã æ˜”ã®ã“ã¨ã§è¨˜æ†¶ãŒæ€ªã—ã„ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰ brew ã® chromedriver ã¨ chromedriver-helper ã¨ webdrivers ãŒãã‚Œãã‚Œä½•ã‚’ã™ã‚‹ã‚‚ã®ã‹æ­£ç¢ºã«æŠŠæ¡ã§ãã¦ãŠã‚‰ãš webdrivers ã‚’æ­£ã—ãä½¿ãˆã¦ãªã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚ã‚‚ã—ãã†ãªã‚‰ webdrivers ã«ã¯ã™ã¾ã‚“

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ãªã„äº‹æ•…ã‚’é˜²ã

### æ–¹æ³•1. Google Chrome ã‚’è‡ªå‹•æ›´æ–°ã•ã›ãªã„

ã“ã‚Œãªã‚‰çµ¶å¯¾ã«ãšã‚Œãªã„ã€‚
ã¾ãšæ›´æ–°ãƒã‚§ãƒƒã‚¯é »åº¦ã‚’ 0 ã«ã™ã‚‹ã€‚

```shell
defaults write com.google.Keystone.Agent checkInterval 0
```

ã•ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æŠ¹æ®ºï¼†ãƒ€ãƒŸãƒ¼ã«ç½®ãæ›ãˆã‚‹ã€‚
~/Library å´

```shell
sudo rm -R ~/Library/Google/GoogleSoftwareUpdate/
sudo touch ~/Library/Google/GoogleSoftwareUpdate
sudo chmod 444 ~/Library/Google/GoogleSoftwareUpdate
sudo rm ~/Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R ~/Library/Caches/com.google.Keystone*
sudo rm ~/Library/Preferences/com.google.Keystone.Agent.plist
```

/Library å´

```shell
sudo rm -R /Library/Google/GoogleSoftwareUpdate/
sudo touch /Library/Google/GoogleSoftwareUpdate
sudo chmod 444 /Library/Google/GoogleSoftwareUpdate
sudo rm /Library/LaunchAgents/com.google.keystone.agent.plist
sudo rm -R /Library/Caches/com.google.Keystone*
sudo rm /Library/Preferences/com.google.Keystone.Agent.plist
```

ä¸Šã®æ‰‹é †ã¯ã‹ãªã‚Šæ˜”ã®ä½œæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã²ã£ã±ã£ã¦ããŸã‚‚ã®ãªã®ã§ç¾åœ¨ãã®é€šã‚Šã«ã—ã¦æœŸå¾…é€šã‚Šã«ãªã‚‹ã‹ã¯ã‚ã‹ã‚‰ãªã„ (ã˜ã‚ƒãè¼‰ã›ã‚“ãªã€‚å±ãªã„ã—)

### æ–¹æ³•2. ã„ã–äº‹æ•…ã£ãŸã‚‰æ‰‹å‹•ã§æˆ»ã™

ãã®ãŸã‚ã«æ—¥ã€…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãŠãã€‚

```sh:~/bin/capybara-env-backup.sh
#!/bin/sh
# (cd /Applications && rm -fr .git)
# (cd ~/.webdrivers && rm -fr .git)
# exit

cd /Applications
[ ! -d .git ] && git init -q
git add -A "Google Chrome.app"
"./Google Chrome.app/Contents/MacOS/Google Chrome" --version | git commit -uno -F -

cd ~/.webdrivers
[ ! -d .git ] && git init -q
git add -A
./chromedriver --version | git commit -F -
```

ã“ã‚Œã‚’ cron ã«ã‚»ãƒƒãƒˆã—ã¦ãŠãã€‚

webdrivers ã¯ Google Chrome ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ãŸ chromedriver ã‚’ç”¨æ„ã—ã¦ãã‚Œã‚‹ã¯ãšãªã®ã§ ~/.webdrivers ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚ãŒã€ã¾ã•ã«ãã®éƒ¨åˆ†ãŒä¿¡ç”¨ã§ãã¦ã„ãªã„ã®ã§ã€ã“ã¡ã‚‰ã‚‚ç®¡ç†ä¸‹ã«å…¥ã‚Œã¦ã™ãæˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

ãã‚Œã¨ã€ã„ã–ã¨ã„ã†ã¨ãã« `/Applications/Google Chrome.app` ã ã‘ã‚’éå»ã«æˆ»ã—ã¦ Google Chrome è‡ªä½“ãŒèµ·å‹•ã™ã‚‹ã®ã‹ä¸å®‰ã§ã¯ã‚ã‚‹ãŒã€ãã‚Œã¯é‹ã‚’å¤©ã«ä»»ã›ã‚‹ã€‚ã¨ã‚Šã‚ãˆãšå¸¸æ™‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ããŸã„å ´åˆã¯ã“ã£ã¡ã®æ–¹ãŒã‚ˆã„ã€‚

### æ–¹æ³•3. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼

çµå±€ã“ã†ã—ãŸ

1. è‡ªå‹•æ›´æ–°ã‚’æ­¢ã‚ã‚‹
1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚å–ã‚‹
1. ãã®ä¸Šã§ã€æœˆã«1å›ã»ã©æ‰‹å‹•ã§ Google Chrome ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹
    - å…·ä½“çš„ã«ã¯æ™®é€šã«æ–°è¦ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ /Applications ã«ã‚³ãƒ”ã‚‹
    - ã™ãã« webdrivers ã‚’èª­ã¿è¾¼ã‚“ã§åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® chromedriver ãŒå…¥ã£ãŸã‹ç¢ºèªã™ã‚‹

## Selenium ã§è­¦å‘ŠãŒå‡ºã‚‹

```
WARN Selenium [DEPRECATION] [:browser_options] :options as a parameter for driver initialization is deprecated. Use :capabilities with an Array of value capabilities/options if necessary instead.
```

- capybara ãŒå¤ã„ã®ãŒåŸå› 
- ã©ã“ã§ç›´ã£ãŸã®ã‹ã¯ã‚ã‹ã‚‰ãªã„ãŒ 3.37.1 ä»¥ä¸Šã ã¨è­¦å‘Šã¯å‡ºãªããªã£ã¦ã„ãŸ
  - ãŸã  3.37.1 ã«ã™ã‚‹ã«ã¯ Ruby 2.7.0 ä»¥ä¸Šã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹

## rack application ãŒå¿…è¦ã ã¨è¨€ã‚ã‚Œã‚‹

```shell
rack-test requires a rack application, but none was given (ArgumentError)
```

è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ current_driver ã« :selenium_chrome ã‚’æŒ‡å®šã™ã‚‹ã€‚

```ruby
Capybara.current_driver = :selenium_chrome
```

## ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†å ´åˆ

```ruby
Capybara.current_driver = ENV["HEADLESS"] ? :selenium_chrome_headless : :selenium_chrome
```

Thor ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†å ´åˆ

```ruby
Capybara.current_driver = :selenium_chrome

class MyApp < Thor
  class_option :headless, type: :boolean, desc: "ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è£ã§å‹•ã‹ã™"

  def initialize(...)
    super
    if options[:headless]
      Capybara.current_driver = :selenium_chrome_headless
    end
  end
end
```

## `require "capybara/dsl"` ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ

- ä¸€ã¤ã®ãƒ–ãƒ©ã‚¦ã‚¶ã—ã‹ä½¿ã‚ãªã„ã¨ã—ãŸä¸Šã§ã„ã‚ã„ã‚çŸ­ã‹ãæ›¸ã‘ã‚‹
- Capybara.page ã§ Capybara.current_session ã‚’å‘¼ã¹ã‚‹
- Capybara.page ã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Capybara ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã«ç”Ÿãˆã‚‹
- ã¤ã¾ã‚Š Capybara.xxx ã¯ Capybara.current_session.xxx ã‚’å‘¼ã¶
- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `Capybara::Session::DSL_METHODS` ã«åˆ—æŒ™ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘
  - active_element ãªã©ã¯ current_session ã‚’çµŒç”±ã§å‘¼ã¶ã“ã¨

## Capybara.xxx ã¨æ›¸ãã®ãŒé¢å€’

ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã¶ã¡ã¾ã‘ã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§

```ruby
module Playground
  extend Capybara::DSL

  visit "https://www.google.co.jp/"
end
```

ã¾ãŸã¯

```ruby
class App
  include Capybara::DSL

  def run
    visit "https://www.google.co.jp/"
  end

  new.run
end
```

ã¨ã™ã‚‹

Capybara ã®åå‰ãŒé•·ã„ã®ãŒæ°—ã«ãªã‚‹å ´åˆã¯

```ruby
module C
  extend Capybara::DSL
end

C.visit "https://www.google.co.jp/"
```

ã¨ã—ã¦ã‚‚è‰¯ã„ãŒã€ãã‚Œãªã‚‰ `C = Capybara` ã§ã„ã„æ°—ãŒã™ã‚‹

## é€”ä¸­ã§æ­¢ã‚ã¦DOMã®æ§‹é€ ã‚’èª¿ã¹ã‚‹

- byebug gem ã‚’å…¥ã‚Œã‚‹
- æœ¬å½“ã¯ debug gem ã®æ–¹ãŒã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„
  - ãŒã€ eshell ã‹ã‚‰å‹•ã‹ãªã„ã®ã§ byebug ã«ã™ã‚‹
  - å…·ä½“çš„ã«ã¯ debug gem ãŒä½¿ã£ã¦ã„ã‚‹ irb ãŒå‹•ã‹ãªã„
  - ã„ãã‚‰èª¿ã¹ã¦ã‚‚ã‚ã‹ã‚‰ãªã„
- ã•ãã•ãå‹•ä½œã•ã›ãŸã„ã®ã§ default_max_wait_time ã‚’ 0 ã«ã—ã¦ã‹ã‚‰ debugger ã‚’èµ·å‹•ã™ã‚‹

```ruby
Capybara.using_wait_time(0) { debugger }
```

- snippet çš„ãªã‚„ã¤ã§ã™ãã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

## ãƒ­ãƒ¼ã‚«ãƒ«ã® HTML ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã‚ãªã„

- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã¯ `open foo.html` ã§é–‹ã‘ã‚‹
- ã ã‹ã‚‰ `Capybara.visit("foo.html")` ã§é–‹ã„ã¦ãã‚Œã¦ã‚‚è‰¯ã•ãã†ã ã‘ã©é–‹ã‘ãªã„
- invalid argument ã¨è¨€ã‚ã‚Œã‚‹ã ã‘
- `file://` ã‹ã‚‰ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã«ã™ã‚‹ã¨èª­ã‚ã‚‹

```ruby
file = Pathname("foo.html").expand_path
Capybara.visit("file://#{file}")
```

## XML ãŒèª­ã‚ãªã„

- Capybara ã¯ HTML ãŒæ¥ã‚‹å‰æã«ãªã£ã¦ã„ã‚‹
- Google Chrome ã¯è‰¯ã‹ã‚Œã¨ XML ã‚’ HTML ã¨ã—ã¦è£…é£¾è¡¨ç¤ºã™ã‚‹
- çµæœã€Capybara ãŒæ··ä¹±ã™ã‚‹

```ruby
Capybara.visit("https://www.google.co.jp/sitemap.xml")
Capybara.page.text             rescue $! # => #<Capybara::ElementNotFound: Unable to find xpath "/html">
Capybara.assert_text("google") rescue $! # => #<Capybara::ElementNotFound: Unable to find xpath "/html">
Capybara.page.body[...40]                # => "<html xmlns=\"http://www.w3.org/1999/xhtm"
```

ã¨ãªã‚‹ã®ã§ faraday ã‚’ä½¿ã†

```ruby
require "faraday"
response = Faraday.get("https://www.google.co.jp/sitemap.xml")
node = Nokogiri::XML(response.body)
node.search("sitemap").count # => 24
```

## å¾…ã¤

assert_xxx ç³»ãƒ¡ã‚½ãƒƒãƒ‰ã¨ wait ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨æ¤œè¨¼ã‚ˆã‚Šã‚‚**ãã®çŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…ã¤**ã®ã«ä½¿ãˆã‚‹

## é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¡¨ã‚ã‚Œã‚‹ã¾ã§æœ€å¤§1åˆ†å¾…ã¤

```ruby
Capybara.assert_selector("button", text: "é€ä¿¡", exact_text: true, wait: 60)
```

`sleep(5)` ãªã©ã¨ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚Œã¦ã¯ã„ã‘ãªã„

## æŒ‡å®šã®ãƒ‘ã‚¹ã«ãªã‚‹ã¾ã§å¾…ã¤

```ruby
Capybara.visit("https://www.youtube.com/results?search_query=capybara")
Capybara.assert_current_path("/results?search_query=capybara")
Capybara.assert_current_path("/results", ignore_query: true)
```

## assert_current_path ã§ã¯ä¸ååˆ†ãªã¨ããŒã‚ã‚‹

ä¸‹æ‰‹ã« AJAX ã‚’å¤šç”¨ã—ãŸã‚µã‚¤ãƒˆã§ã¯èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ãŸã‚ã¨ã§ã‚‚ã€ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¶šã‘ã¦ã„ãŸã‚Šã—ã¦ã€ãã®ã‚µã‚¤ãƒˆã«æ¥ã¦ã¯ã„ã‚‹ãŒã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¾ã ç”¨æ„ã•ã‚Œã¦ã„ãªã„å ´åˆãŒã‚ã‚‹ã€‚

ãã†ã„ã†ã¨ãã¯ãƒ‘ã‚¹ã§ã¯ãªãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ãŒè¡¨ã‚ã‚Œã‚‹ã¾ã§å¾…ã¤ã‚ˆã†ã«ã™ã‚‹ã€‚

```ruby:Ã—ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã¯æ¥ã¦ã„ã‚‹ãŒä¸­èº«ãŒç©ºã®å ´åˆãŒã‚ã‚‹
Capybara.assert_current_path("/login", wait: 60)
```

```ruby:â—‹ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã¯å…¨éƒ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹
Capybara.assert_selector("button", text: "ãƒ­ã‚°ã‚¤ãƒ³", exact_text: true, wait: 60)
```

## ã‚ã‚Šãˆãªã„ã»ã©é‡ã„ã‚µã‚¤ãƒˆã«ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é‡ã­ã¦é–‹ãã¾ã§å¾…ã¤ä¾‹

```ruby
Capybara.visit("...")

success = false
100.times do |i|
  puts [i.next, Time.current, Capybara.current_url].join(" ")
  if Capybara.has_selector?("button", text: "é€ä¿¡", exact_text: true, wait: 60)
    success = true
    break
  end
  say "ãƒªãƒ­ãƒ¼ãƒ‰#{i.next}å›ç›®"
  Capybara.refresh
end
if !success
  say "å¤±æ•—"
end
```

- `<button>é€ä¿¡</button>` ãŒã‚ã‚Œã°é–‹ã„ãŸã¨è¦‹ãªã™
- 60ç§’çµŒã£ã¦ã‚‚åå¿œãŒç„¡ã‘ã‚Œã°æ­»ã‚“ã§ã„ã‚‹ã®ã§å†ã³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(ãƒªãƒ­ãƒ¼ãƒ‰)ã™ã‚‹
- ã“ã‚“ãªã“ã¨ã—ãªã„ã¨ã„ã‘ãªã„ã‚µã‚¤ãƒˆãŒã‚ã‚‹ã®ã‹ã¨æ€ã†ã‹ã‚‚ã—ã‚Œãªã„ãŒå®Ÿéš›ã«ã‚ã‚‹

## å¾…ã£ã¦ã„ã‚‹ã¨PCã®ãƒ•ã‚¡ãƒ³ãŒå”¸ã‚Šã‚’ä¸Šã’ã¦ã—ã¾ã†åŸå› ã¨å¯¾ç­–

ã“ã†æ›¸ãã¨å†…éƒ¨ã§ã¯ 0.01 ã®ã‚¦ã‚§ã‚¤ãƒˆãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚å‡¦ç†å›æ•°ã¯1ç§’é–“ã§ç´„100å›ã€å…¨ä½“ã§ç´„6000å›ã«ãªã‚‹

```ruby
Capybara.has_selector?(..., wait: 60)
```

ã“ã†ç½®ãæ›ãˆã‚‹ã¨1ç§’ã«1å›ãªã®ã§å…¨ä½“ã§60å›ã«ãªã‚‹

```ruby
60.times do
  break if Capybara.has_selector?(..., wait: 0)
  sleep(1)
end
```

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸãã®åˆ¤å®šã‚‚å«ã‚ã‚‹ã¨ã“ã†ãªã‚‹

```ruby
success = false
second = 1 # 1ç§’é–“æ¯ã«ä¸€ç¬ç¢ºèªã™ã‚‹
(60 / second).times do
  if Capybara.has_selector?(..., wait: 0)
    success = true
    break
  end
  sleep(second)
end
if success
  # æˆåŠŸ
else
  # å¤±æ•—
end
```

## å¾…ã¡ç§’æ•°ã®æŒ‡å®šã¯ wait ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ã‘ã«ç•™ã‚ã‚‹

å¾…ã¡ç§’æ•°ã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚‹ãŒâ”€â”€

æŒ‡å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã ã‘
```ruby
Capybara.assert_title("Google", wait: 60)
```

å±€æ‰€çš„(å¿˜ã‚Œã¦ã‚ˆã„)
```ruby
Capybara.using_wait_time(60) do
  Capybara.default_max_wait_time # => 60
end
```

å…¨ä½“(å¿˜ã‚Œã¦ã‚ˆã„)
```ruby
Capybara.default_max_wait_time = 60
```

- ãƒãƒƒãƒã—ãªã„ã‹ã‚‰ã¨ã„ã£ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å¢—ã‚„ã™ã¹ã‹ã‚‰ãš
- é€†ã«å¤±æ•—ã®åˆ¤å®šã‚’ã—ã¦ã„ãŸéƒ¨åˆ†ã§æ™‚é–“ãŒã‹ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã—ã¾ã†
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 2 ã®ã¾ã¾ã§è‰¯ã„ã€‚è§¦ã£ã¦ã¯ã„ã‘ãªã„
- é‡ã„ã¨ãã¯ã¨ã“ã¨ã‚“é‡ã„ã®ã§æŒ‡å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã§ wait ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†

## æŒ‡å®šã®è¦ç´ ãŒ1ä»¶ã«ãªã‚‹ã¾ã§å¾…ã¤

ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ¤œç´¢ã§çµæœã®æ•°ãŒå¤‰å‹•ã™ã‚‹å ´åˆã«æœ‰ç”¨

```ruby
Capybara.assert_selector(".foo", count: 1, wait: 60)
```

## ã‚µã‚¤ãƒˆãŒ 200 ã‚’è¿”ã™ã¾ã§å¾…ã¤

```ruby
require "faraday"

url = "https://www.google.co.jp/"
loop do
  response = Faraday.get(url)
  p [Time.now.strftime("%F %T"), url, response.reason_phrase]
  if response.success?
    break
  end
  sleep(2)
end
```

Capybara ã ã¨æˆ»å€¤ãŒã‚ã‹ã‚‰ãªã„ã®ã§ç¯€æ“ãªã faraday ã‚’ä½¿ã†

## WEBã«ã‚¢ã‚¯ã‚»ã‚¹ã›ãšã«ã‚»ãƒ¬ã‚¯ã‚¿ã®æ¤œè¨¼ã‚’ã™ã‚‹(é‡è¦)

```ruby
node = Capybara.string("<a></a>")
node.has_selector?("a") # => true
```

ã¨ã‚Šã‚ãˆãšå‹•ã‘ã°ã„ã„ã§ã¯ãªãå¸¸ã«å®Œç’§ãªã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ›¸ãã‚ˆã†ã«å¿ƒæ›ã‘ã‚‹ã€‚
ãã®ãŸã‚ã®æ¤œè¨¼ãƒ»ç·´ç¿’ã«ã¨ã¦ã‚‚å½¹ç«‹ã¤ã€‚

## CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ XPath ã«å¤‰æ›ã™ã‚‹(æœ‰ç”¨)

```ruby
Nokogiri::CSS.xpath_for("*")       # => ["//*"]
Nokogiri::CSS.xpath_for("a")       # => ["//a"]
Nokogiri::CSS.xpath_for("a, b")    # => ["//a", "//b"]
Nokogiri::CSS.xpath_for("a b")     # => ["//a//b"]
Nokogiri::CSS.xpath_for("a > b")   # => ["//a/b"]
Nokogiri::CSS.xpath_for("a[x=y]")  # => ["//a[@x='y']"]
Nokogiri::CSS.xpath_for("a[x*=y]") # => ["//a[contains(@x,'y')]"]
Nokogiri::CSS.xpath_for(".foo")    # => ["//*[contains(concat(' ',normalize-space(@class),' '),' foo ')]"]
Nokogiri::CSS.xpath_for("#foo")    # => ["//*[@id='foo']"]
Nokogiri::CSS.xpath_for("*[foo]")  # => ["//*[@foo]"]
Nokogiri::CSS.xpath_for("p:first") # => ["//p[position()=1]"]
```

CSS ã§ã¯ç¢ºã‹ã“ã†æ›¸ãã¯ãšã ã‘ã© XPath ã ã¨ãªã‚“ã ã£ã‘ï¼Ÿ ãªå ´åˆã«å½¹ç«‹ã¤ã€‚

## CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿ã¯å†…éƒ¨ã§ XPath ã«å¤‰æ›ã•ã‚Œã‚‹ (é‡è¦)

```ruby
Capybara.default_selector # => :css
node = Capybara.string("<a></a>")
node.find("a") # => #<Capybara::Node::Simple tag="a" path="/html/body/a">
```

ä¸Šã ã‘è¦‹ã¦ã‚‚ã‚ã‹ã‚‰ãªã„ãŒã€å†…éƒ¨ã§ã¯ `a` ã‚’ `//a` ã«å¤‰æ›ã—ã¦ã‹ã‚‰æ¢ã—ã¦ã„ã‚‹ã€‚

```ruby
xpath = Nokogiri::CSS.xpath_for("a") # => ["//a"]

node = Nokogiri.XML("<a></a>")
node.at(xpath.first) # => #<Nokogiri::XML::Element:0xa8c name="a">
```

## default_selector ãŒ :css ãªã®ã«ãã®ã¾ã¾ XPath ã‚‚æ›¸ã‘ã‚‹ã®ã¯ãªãœã‹ï¼Ÿ (è¶…é‡è¦)

`a` ã§ãªã `//a` ã§ãƒãƒƒãƒã—ã¦ã„ã‚‹ã€‚ãªãœã‹ï¼Ÿ

```ruby
Capybara.default_selector # => :css
node = Capybara.string("<a>xxx</a>")
node.has_selector?("//a") # => true
```

å½“åˆã€èé€šã‚’åŠ¹ã‹ã›ã¦ãã‚Œã¦ã„ã‚‹ã®ã ã¨æ€ã£ã¦ã„ãŸã€‚
Nokogiri ã«ã¯ `LOOKS_LIKE_XPATH` ã¨ã„ã†å®šæ•°ãŒã‚ã‚Šã€ã“ã‚Œã«ãƒãƒƒãƒã™ã‚‹ã¨ XPath ã¨è¦‹ãªã—ã¦ã„ã‚‹ã®ã‹ã¨ã€‚

```ruby
Nokogiri::XML::Searchable::LOOKS_LIKE_XPATH # => /^(\.\/|\/|\.\.|\.$)/
node = Nokogiri.XML("<a></a>")
node.at("a")              # => #<Nokogiri::XML::Element:0x9ec name="a">
node.at("//a")            # => #<Nokogiri::XML::Element:0x9ec name="a">
```

ã ãŒã€ãã‚Œã«æƒ‘ã‚ã•ã‚Œã¦ã¯ã„ã‘ãªã„ã€‚
ã“ã“ã§æœ€åˆã®ä»•çµ„ã¿ã‚’æ€ã„å‡ºã™ã€‚

**CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿ã¯å†…éƒ¨ã§ XPath ã«å¤‰æ›ã•ã‚Œã‚‹**

ã ã‹ã‚‰ã“ã†ãªã‚‹ã€‚

```ruby
xpath = Nokogiri::CSS.xpath_for("//a") # => ["////a"]

node = Nokogiri.XML("<a></a>")
node.at(xpath.first) # => #<Nokogiri::XML::Element:0xaa0 name="a" children=[#<Nokogiri::XML::Text:0xa8c "xxx">]>
```

è¦‹ã‚‹ã¨ã€

1. CSS ã¨ã—ã¦ `//a` ãŒå…¥åŠ›ã•ã‚ŒãŸ (ãã‚“ãª CSS ã®è¡¨è¨˜ã¯ãªã„)
1. `////a` ã«å¤‰æ›ã•ã‚ŒãŸ (ãã‚“ãª XPath ã®è¡¨è¨˜ã‚‚ãªã„)
1. ã—ã‹ã—ã€å¼•ã‘ãŸ (ãªãœï¼Ÿ)

ãŸã¾ãŸã¾ã§ã‚‚å‹•ããªã‚‰ CSS ã« XPath ã‚’æ›¸ã‘ã‚‹ã£ã¦ã“ã¨ã§ã„ã„ã‚“ã˜ã‚ƒãªã„ï¼Ÿ
ã„ã‚„ã€çµ¶å¯¾ã ã‚ã€‚ãªãœãªã‚‰â”€â”€ (ç¶šã)

## default_selector ãŒ :css ã®ã¨ãã« XPath ã‚’æ›¸ã„ã¦ã¯ã„ã‘ãªã„ç†ç”± (è¶…é‡è¦)

- å‹•ã‹ãªã„ã‚»ãƒ¬ã‚¯ã‚¿ã‚‚ã‚ã‚‹ã‹ã‚‰
- ä¾‹ãˆã°éƒ¨åˆ†ä¸€è‡´ã®ã‚»ãƒ¬ã‚¯ã‚¿ã¯å‹•ã‹ãªã„

```ruby
Capybara.default_selector # => :css
node = Capybara.string("<a>xxx</a>")
node.has_selector?("//a[text()='xxx']")                    # => true
node.has_selector?("//a[contains(text(), 'x')]") rescue $! # => #<Nokogiri::CSS::SyntaxError: unexpected 'text(' after 'contains('>
```

ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã™ãŒã€

**CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿ã¯å†…éƒ¨ã§ XPath ã«å¤‰æ›ã•ã‚Œã‚‹**

ã®ã§è©¦ã™ã¨ä»Šåº¦ã¯å¤±æ•—ã™ã‚‹ã€‚

```ruby
Nokogiri::CSS.xpath_for("//a[contains(text(), 'x')]") rescue $! # => #<Nokogiri::CSS::SyntaxError: unexpected 'text(' after 'contains('>
```

- ã“ã®å•é¡ŒãŒã‚„ã£ã‹ã„ãªã®ã¯ã ã„ãŸã„ã® XPath ã‚»ãƒ¬ã‚¯ã‚¿ã¯é€šã‚‹ã¨ã“ã‚
- å®Œå…¨ä¸€è‡´ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚‚é€šã‚‹
- ã ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´ã®ã‚»ãƒ¬ã‚¯ã‚¿ã ã‘ãŒé€šã‚‰ãªã„ç†ç”±ãŒã‚ã‹ã‚‰ãªã„
- å¸¸è­˜çš„ã«è€ƒãˆã¦ã€åŸå› ã¯éƒ¨åˆ†ä¸€è‡´ã®æ›¸ãæ–¹ã«ã‚ã‚‹ã¨è€ƒãˆã¦ã—ã¾ã†
- ãã—ã¦ã€ã¾ã™ã¾ã™æ·±ã¿ã«ã¯ã¾ã£ã¦ã„ã£ãŸ
  - å®Ÿéš›4å¹´ãã‚‰ã„æ··ä¹±ã—ã¦ã„ãŸ
  - XPath ææ€–ç—‡ã«ãªã£ã¦ã„ãŸ
- æ€ã†ã« `Nokogiri::CSS.xpath_for` ãŒå…ƒå‡¶ã ã£ãŸ
  - CSS ã¨ã—ã¦ XPath ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã‚¨ãƒ©ãƒ¼ã¨ã™ã¹ã
  - `//` ã‚„ `./` ã§å§‹ã¾ã‚‹é–“é•ã£ãŸã‚»ãƒ¬ã‚¯ã‚¿ã‚’ã‚¨ãƒ©ãƒ¼ã¨ã™ã¹ã

çµè«–
- XPath ã‚’æ›¸ãã¨ãã¯ **å¿…ãš XPath ã‚’æ˜ç¤º** ã™ã‚‹

ã“ã‚“ãªã‚“ã¯å¶ç„¶å‹•ã„ã¦ã„ã‚‹ã ã‘ã€‚æœ¬æ¥ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ãŒç´ é€šã‚Šã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã ã‘ã€‚ç½®ãæ›ãˆã‚‹ã€‚
- `assert_selector?("//...")` â†’ `assert_selector?(:xpath, "//...")`
- `assert_selector?("//...")` â†’ `assert_xpath?("//...")`
- `has_selector?("//...")` â†’ `has_xpath?("//...")`
- `find("//...")` â†’ `find(:xpath, "//...")`

## ãƒ©ãƒ™ãƒ«ã«æ­£ç¢ºã«ãƒãƒƒãƒã•ã›ã‚‹

```ruby
Capybara.visit("https://httpbin.org/forms/post")
Capybara.fill_in("Customer name:", with: "foo", exact: true)
```

- exact ã¯ **æ­£ç¢º** ã®æ„å‘³
- æ¯å› `exact: true` ã¨æ›¸ãçŠ¶æ³ãªã‚‰ `Capybara.exact = true` ã¨ã—ã¦ãŠã

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ `exact = true` ã«ã™ã‚‹ã¨ assert_text ã‚‚å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹ï¼Ÿ

- ãªã‚‰ãªã„
- assert_text ã«ã¯å°‚ç”¨ã® `Capybara.exact_text` ãŒã‚ã‚‹
- ãŒã€ã“ã‚Œã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§è¨­å®šã™ã‚‹ã“ã¨ã¯æ™®é€šãªã„
- ãƒ¡ã‚½ãƒƒãƒ‰ã«æŒ‡å®šã™ã‚‹ã¨ãã¯ `assert_text "xxx", exact: true` ã¨æ›¸ã
  - `exact_text: true` ã§ã¯ãªã„ç‚¹ã«æ³¨æ„

## æ”¹è¡Œã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®å½±éŸ¿ã§ assert_text ã®åˆ¤å®šãŒæºã‚‰ã

```ruby
Capybara.assert_text("foo bar", normalize_ws: true)
```

- `normalize_ws: true` ã™ã‚‹ã¨å¯¾è±¡ã‚’ `gsub(/[[:space:]]+/, ' ').strip` ã™ã‚‹
- ãªã®ã§ `foo \n bar` ã«ã‚‚ `foo bar` ãŒãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«ãªã‚‹

## assert_text ã§ãƒãƒƒãƒã—ãªã„

- æƒ³å®šã™ã‚‹ç”»é¢ã«ãªã£ã¦ã„ãªã„ã®ãŒã»ã¨ã‚“ã©ã®åŸå› 
- ãƒ‡ãƒãƒƒã‚¬ã§æ­¢ã‚ã¦ä»¥ä¸‹ã‚’ç¢ºèª
  - `Capybara.title`
  - `Capybara.current_url`
  - `Capybara.page.text`
  - `Capybara.page.text.include?("xxx")`

## ç”»é¢ã‚’è¦†ã†å·¨å¤§ãª div ãŒé‚ªé­”ã§æŠ¼ã›ãªã„

`<div class=".spinner"></div>` ãŒç”»é¢ã‚’è¦†ã£ã¦ç›®çš„ã® button ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ããªã„å ´åˆã€æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

```
*** Selenium::WebDriver::Error::ElementClickInterceptedError Exception:
element click intercepted: Element <button>...</button> is not clickable at point (1503, 193).
Other element would receive the click: <div class="spinner"></div>
```

å¯¾ç­–1. æ¶ˆãˆã‚‹ã¾ã§å¾…ã¤

```ruby
Capybara.assert_no_selector?(".spinner", wait: 10)
```

- 10ç§’çµŒéã—ã¦ã‚‚ã‚¹ãƒ”ãƒŠãƒ¼ãŒã§ã£ã±ãªã—ãªã‚‰ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹

å¯¾ç­–2. è¦ç´ ã‚’æŠ¹æ®ºã™ã‚‹

ã‚µã‚¤ãƒˆå´ã®ä¸å…·åˆã§æ°¸é ã«æ®‹ã£ã¦ã—ã¾ã†å ´åˆã¯å¼·å¼•ã«æ¶ˆã—ã¦ã—ã¾ã†

```ruby
Capybara.execute_script("document.querySelector('.spinner').remove()")
```

å¯¾ç­–3. æ‹¡ç¸®ã‚’ã‚„ã‚ã¦ã¿ã‚‹

ã“ã‚Œã§æŠ¼ã›ãªã„è¦ç´ ãŒæŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ãŒå®Ÿéš›ã«ã‚ã‚‹

```ruby
Capybara.execute_script("document.body.style.zoom = 1.0")
```

## ã‚µã‚¤ãƒˆè¨ªå•æ™‚ã®ã‚¹ãƒ”ãƒŠãƒ¼ãŒå‡ºã‚‹é †åºã«æ°—ã‚’ã¤ã‘ã‚‹

æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¦ã€

1. æœ€åˆã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå§‹ã¾ã£ã¦ã‚¹ãƒ”ãƒŠãƒ¼ãŒæ•°ç§’é–“è¡¨ç¤ºã•ã‚Œã‚‹
1. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

å®Ÿéš›ã¯ã“ã†ãªã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹

1. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
1. æœ€åˆã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå§‹ã¾ã£ã¦ã‚¹ãƒ”ãƒŠãƒ¼ãŒæ•°ç§’é–“è¡¨ç¤ºã•ã‚Œã‚‹
1. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

å‰è€…ã ã¨æ€ã£ã¦æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¨ã€ã„ããªã‚Š `set("foo")` ãŒå‘¼ã°ã‚Œã€ã‚¹ãƒ”ãƒŠãƒ¼ãŒé‚ªé­”ã—ã¦æŠ¼ã›ãªã„ã€‚

```ruby
Capybara.assert_no_selector?(".spinner", wait: 10)
Capybara.find("input").set("foo")
```

## ç¢ºå®Ÿã«é¸æŠã§ãã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ã‚’å¾—ã‚‹

- Developer Tool ã§è©²å½“ã‚¿ã‚°ã‚’ `Copy Selector` ã§ã‚³ãƒ”ã‚‹
- ã‚ã¨ã®ã“ã¨ã¯çŸ¥ã‚‰ãªã„ã€ä»Šå‹•ã‘ã°ã„ã„â”€â”€å ´åˆã«æœ‰ç”¨

## `Copy Selector` ã§ã‚³ãƒ”ã£ãŸã®ã«é¸æŠã§ããªã„

- iframe ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ãŒåŸå› 
- within_frame(selector) ã§ iframe å†…ã«å…¥ã‚‹

```html
<body>
  <iframe>
    <form></form>
  </iframe>
</body>
```

```ruby
Capybara.has_selector?("form")     # => false
Capybara.within_frame("iframe") do
  Capybara.assert_selector("form") # => true
end
```

- selector ã¯ "iframe" ãŒåˆæœŸå€¤ãªã®ã§ä¸Šã®å ´åˆã¯ selector ã‚’çœç•¥ã—ã¦ã‚‚ã‚ˆã„

## ãƒã‚¦ã‚¹ã‚’é‡ã­ã‚‹ã¨è¦‹ãˆã‚‹ã‚¿ã‚°ã‚’é¸æŠã™ã‚‹

- `visible: :all` ã‚’ã¤ã‘ã‚‹

```ruby
node = Capybara.string("<a style='display:none'></a>")
node.has_selector?("a")                 # => false
node.has_selector?("a", visible: :all)  # => true
```

### visible ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä»–ã«ä½•ãŒæŒ‡å®šã§ãã‚‹ï¼Ÿ

- `visible: :hidden` ã«ã™ã‚‹ã¨è¦‹ãˆãªã„ã‚¿ã‚°ã ã‘ãŒé¸æŠã§ãã‚‹
- ã ã‹ã‚‰æ™®é€šã«é¸æŠã§ããŸã‚‚ã®ã¯é€†ã«é¸æŠã§ããªããªã‚‹

```ruby
node = Capybara.string("<a></a>")
node.has_selector?("a", visible: :hidden) # => false
```

- ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹ã§ã®ãƒ†ã‚¹ãƒˆã«æœ‰ç”¨ã‹ã‚‚ã—ã‚Œãªã„
- `Capybara.ignore_hidden_elements` ã«æŒ‡å®šã™ã‚‹ã¨åˆæœŸå€¤ã«ãªã‚‹
  - åå‰ãŒå…¨ç„¶é•ã†ã®ãŒã‚ˆããªã„
  - `default_visible` ãªã©ã«ã™ã¹ã
  - ãã‚‚ãã‚‚3æŠã§å€¤ã«`visible` ãŒã‚ã‚‹ã®ã«ã‚­ãƒ¼ãŒ `visible` ãªã®ãŒã‚¤ã‚±ã¦ãªã„
- è¨­å®šå€¤ã«çœŸå½å€¤ã‚‚ä½¿ãˆã‚‹ãŒã€ã‚ã‹ã‚Šã«ãã„ã®ã§å¿˜ã‚Œã‚ˆã†
- hidden ã‚‚åŸºæœ¬å¿˜ã‚Œã¦ã„ã„

| ã‚·ãƒ³ãƒœãƒ« | è¦‹ãˆã‚‹ã‚¿ã‚° | è¦‹ãˆãªã„ã‚¿ã‚° |        |          |
|----------|------------|--------------|--------|----------|
| visible  | â—‹         |              | åˆæœŸå€¤ | â† true  |
| all      | â—‹         | â—‹           |        | â† false |
| hidden   |            | â—‹           |        |          |

## ã‚»ãƒ¬ã‚¯ã‚¿ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

```html:å¯¾è±¡
<button><span>é€ä¿¡ã™ã‚‹</span></button>
```

ã‚¿ã‚°ã®æ§‹é€ ã‚’å«ã‚ã¦å®Œå…¨ä¸€è‡´ã§ãƒãƒƒãƒã™ã‚‹

```ruby
has_xpath?("//button/span[text()='é€ä¿¡ã™ã‚‹']")
```

ãƒ†ã‚­ã‚¹ãƒˆã¯éƒ¨åˆ†ä¸€è‡´ã§è‰¯ã„

```ruby
has_xpath?("//button/span[contains(text(), 'é€ä¿¡')]")
```

span ãŒåˆ¥ã®ã‚¿ã‚°ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„

```ruby
has_xpath?("//button/*[contains(text(), 'é€ä¿¡')]")
```

span ãŒç„¡ããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„

```ruby
has_xpath?("//button[contains(., 'é€ä¿¡')]")
```

contains ã¨æ›¸ããŸããªã„

```ruby
has_xpath?("//button", text: "é€ä¿¡")
```

`//` ã‚’æ›¸ããŸããªã„

```ruby
has_css?("button", text: "é€ä¿¡")
```

button ã‚¿ã‚°ã¨ã¯é™ã‚‰ãªã„

```ruby
has_selector?(:link_or_button, text: "é€ä¿¡")
```

ãã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã„

```ruby
find(:link_or_button, text: "é€ä¿¡").click
```

çŸ­ã‹ãæ›¸ããŸã„

```ruby
click_on("é€ä¿¡")
```

## æ–‡è¨€ã ã‘ã‚’é ¼ã‚Šã«ãã‚Œã‚’ç›´ä¸‹ã«æŒã¤ã‚¿ã‚°ã‚’æ¢ã™

```ruby
find(:xpath, "//*[contains(text(), 'é€ä¿¡')]") # => #<Capybara::Node::Simple tag="span" path="/html/body/button/span">
find(:xpath, "//*[text()='é€ä¿¡ã™ã‚‹']")        # => #<Capybara::Node::Simple tag="span" path="/html/body/button/span">
```

- `text()` ã¯è‡ªåˆ†ã®ç›´ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆãªã®ã§ãƒãƒƒãƒã™ã‚Œã°è‡ªåˆ†è‡ªèº«ã®ã‚¿ã‚°ãŒè¿”ã‚‹
- æ˜¨ä»Šã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ä½•ãŒ click ã§ãã‚‹ã®ã‹æƒ³åƒã¤ã‹ãªã„
- ã¨ã‚Šã‚ãˆãšã€ãã®æ–‡è¨€ã‚’æŒã£ãŸã‚¿ã‚°ã‚’ click ã™ã‚Œã°ä¼æ¬ã™ã‚‹ã ã‚ã†
- ãã†ã„ã†ã¨ãç”¨

## ã‚»ãƒ¬ã‚¯ã‚¿ã« `*` ã‚„ `.` ã‚’ä½¿ã£ãŸã¨ãã®ã¯ã¾ã‚Šã©ã“ã‚

ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã® HTML ã‚¿ã‚°ã«ãƒãƒƒãƒã—ã¦ã„ã‚‹

```ruby
find(:xpath, "*", text: "é€ä¿¡") # => #<Capybara::Node::Simple tag="html" path="/html">
```

html, body, button, span ã®ã™ã¹ã¦ã®ã‚¿ã‚°ãŒãƒãƒƒãƒã—ã¦ã„ã‚‹

```ruby
find(:xpath, "//*", text: "é€ä¿¡")        rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 4 elements matching visible xpath "//*" with text "é€ä¿¡">
find(:element, text: "é€ä¿¡")             rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 4 elements matching visible element nil with text "é€ä¿¡">
find(:xpath, "//*[.='é€ä¿¡ã™ã‚‹']")        rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 4 elements matching visible xpath "//*[.='é€ä¿¡ã™ã‚‹']">
find(:xpath, "//*[contains(., 'é€ä¿¡')]") rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 4 elements matching visible xpath "//*[contains(., 'é€ä¿¡')]">
```

## ã€Œé€ä¿¡ã€ã‚’é¸æŠã™ã‚‹ã¤ã‚‚ã‚ŠãŒã€Œé€ä¿¡ç¢ºèªã€ã‚‚é¸æŠã—ã¦ã—ã¾ã†

```ruby
node = Capybara.string("<button>é€ä¿¡ç¢ºèª</button><button>é€ä¿¡</button>")
node.find("button", text: "é€ä¿¡") rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 2 elements matching visible css "button" with text "é€ä¿¡">
```

- `exact_text: true` ã‚’ã¤ã‘ã‚‹ã¨å®Œå…¨ä¸€è‡´ã«ãªã‚‹
  - `exact` ãªã®ã‹ `exact_text` ãªã®ã‹ã‚„ã‚„ã“ã—ã„
- `text` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ­£è¦è¡¨ç¾ã«ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹

```ruby
node.find("button", text: "é€ä¿¡", exact_text: true).path # => "/html/body/button[2]"
node.find("button", text: /\Aé€ä¿¡\z/).path               # => "/html/body/button[2]"
```

- xpath ã§ã‚ã‚Œã° contains ã‚’é¿ã‘ã‚‹

```ruby
node.find(:xpath, "//*[contains(text(), 'é€ä¿¡')]") rescue $! # => #<Capybara::Ambiguous: Ambiguous match, found 2 elements matching visible xpath "//*[contains(text(), 'é€ä¿¡')]">
node.find(:xpath, "//*[text()='é€ä¿¡']").path # => "/html/body/button[2]"
```

## æœ€å°é™ã®HTMLã‚’ç”¨æ„ã—ã¦å•é¡Œã‚’ç‰¹å®šã™ã‚‹(è¶…é‡è¦)

å®Ÿéš›ã®ã‚µã‚¤ãƒˆã®æ·±éƒ¨ã«è¡Œãã®ãŒé›£ã—ã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«å†ç¾ã—ãŸHTMLã§æ¤œè¨¼ã™ã‚‹ã€‚

```ruby
require "tempfile"

SOURCE = <<~EOT
  <a href="https://www.google.co.jp/">æ¤œç´¢</a>
EOT

path = Tempfile.open(["", ".html"]) { |e| e.tap { |e| e << SOURCE } }.path
Capybara.visit("file://#{path}")

Capybara.click_on("æ¤œç´¢")
gets
```

- ä»–è€…ã®ã‚µã‚¤ãƒˆã«ç„¡é§„ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’é‡ã­ã¦è¿·æƒ‘ã‚’ã‹ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹æ„å‘³ã‚‚ã‚ã‚‹
- æ¢ç´¢ä¸­ã® HTML ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ `Capybara.save_page("foo.html")` ã¨ã™ã‚‹
- å˜ã«ã‚»ãƒ¬ã‚¯ã‚¿ã®ç¢ºèªã§ã‚ã‚Œã° `Capybara.string` ã‚’ä½¿ã†
- ã“ã¡ã‚‰ã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®æŒ™å‹•ã‚’å«ã‚ã¦ç¢ºèªã—ãŸã„ã¨ãã«ç”¨ã„ã‚‹

## é€£ç¶šã™ã‚‹è¦ç´ ã®æŒ‡å®šç•ªç›®ã®è¦ç´ ã‚’æ‹¾ã†ã®ã« all ã¯ä½¿ã£ã¦ã¯ãªã‚‰ãªã„

```ruby
node = Capybara.string(<<~EOT)
<div>A</div>
<div>B</div>
<div>C</div>
EOT
```

ãƒ€ãƒ¡ãªä¾‹

```ruby
node.all("div")[1].text            # => "B"
```

æ­£ã—ã„ä¾‹

```ruby
node.find("div:nth-child(2)").text # => "B"
```

## æŒ‡å®šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€è¦ç´ ã®è¦ªã‹ã‚‰è¦‹ãŸâ”€â”€ã¨ãªã£ã¦ãã‚‹ã¨ XPath ã§ãªã„ã¨é›£ã—ã„

å¤–å´ã® div ãŒå¤§é‡ã«ã‚ã£ã¦ç›®å°ã¯ h2 å†…ã®æ—¥ä»˜ã ã‘ã¨æƒ³å®š

```ruby
node = Capybara.string(<<~EOT)
<div>
  <h2>2000-01-01</h2>
  <ul>
    <li>A</li>
    <li>B</li>
  </ul>
</div>
EOT

node.find("h2", text: "2000-01-01").path                                            # => "/html/body/div/h2"
node.find(:xpath, "//h2[contains(text(),'2000-01-01')]/../ul").path                 # => "/html/body/div/ul"
node.find(:xpath, "//h2[contains(text(),'2000-01-01')]/parent::*/ul").path          # => "/html/body/div/ul"
node.find(:xpath, "//h2[contains(text(),'2000-01-01')]/following-sibling::ul").path # => "/html/body/div/ul"
```

- CSS ã®æ›¸ãæ–¹ã§ã¯ h2 ã¾ã§ã¯è¡Œã‘ã‚‹ãŒä¸Šã«ä¸ŠãŒã‚Œãªã„
- `..` ã¨ `parent::*` ã¯åŒã˜
- `following-sibling::ul` ã¯ h2 ã®ã‚ã¨ã§ã«å‡ºã¦ãã‚‹å…„å¼Ÿã® ul
- ã¨ã„ã†ã‹å…¨éƒ¨ XPath ã§æ›¸ãã®ã§ã¯ãªãä¸Šã«ä¸ŠãŒã‚‹ã¨ã“ã‚ã ã‘ XPath ã§æ›¸ã„ãŸæ–¹ãŒæ¥½

```ruby
node.find("h2", text: "2000-01-01").find(:xpath, "..").all("li")
```

## ãªã‚‹ã¹ãçµ„ã¿è¾¼ã¿ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ç†ç”±

ã‚»ãƒ¬ã‚¯ã‚¿ã« `"button"` ã‚’ä½¿ã†ã‚ˆã‚Š `:button` ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ç†ç”±ã¯ `disabled` å±æ€§ã‚’è€ƒæ…®ã—ã¦ãã‚Œã‚‹ã‹ã‚‰ã€‚

ä¾‹ãˆã°æ¬¡ã®ã‚¿ã‚°ã¯ disabled ãªã®ã§æŠ¼ã›ãªã„

```html
<button disabled>é€ä¿¡</button>
```

ã ã‘ã© find + CSS ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã†ã¨å–å¾—ã§ãã¦ã—ã¾ã†ã€‚ãã®ä¸Š(è¦‹ã‹ã‘ä¸Šã¯)æŠ¼ã›ã¦ã—ã¾ã†ã€‚

```ruby
Capybara.find("button", text: "é€ä¿¡").click # => #<Capybara::Node::Element tag="button" path="/HTML/BODY[1]/DIV[1]/BUTTON[1]">
```

ã‚‚ã¡ã‚ã‚“ã‚µã‚¤ãƒˆå´ã§ã¯ä½•ã‚‚èµ·ããªã„ã®ã§ disabled å±æ€§ãŒã‚ã‚‹ã“ã¨ã«æ°—ä»˜ã‹ãªã‘ã‚Œã°ã‹ãªã‚Šã¯ã¾ã‚‹ã“ã¨ã«ãªã‚‹ã€‚ã¨ã„ã†ã‹ã¯ã¾ã£ãŸã€‚
ã§ã€ã“ã“ã§ãªã‚“ã¨ã‹ã™ã‚‹ã¨ã™ã‚Œã° disabled ã®é€†ã‚’æ„å‘³ã™ã‚‹ enabled ã‚’æŒ‡å®šã—ãªã„ã¨ã„ã‘ãªã„ã‘ã©æ¯å›æŒ‡å®šã™ã‚‹ã®ã¯é¢å€’ã ã€‚

```ruby
Capybara.find("button:enabled", text: "é€ä¿¡") rescue $! # => #<Capybara::ElementNotFound: Unable to find css "button:enabled">
```

ã“ã‚Œã‚’è‡ªå‹•çš„ã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ãŒç™»éŒ²æ¸ˆã¿ã® `:button` ã‚»ãƒ¬ã‚¯ã‚¿ã«ãªã‚‹ã€‚

```ruby
Capybara.find(:button, text: "é€ä¿¡") rescue $! # => #<Capybara::ElementNotFound: Unable to find visible button nil with text "é€ä¿¡" that is not disabled>
```

`find_button` ã‚‚å†…éƒ¨ã§ `:button` ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯åŒã˜

```ruby
Capybara.find_button("é€ä¿¡") rescue $! # => #<Capybara::ElementNotFound: Unable to find visible button "é€ä¿¡" that is not disabled>
```

ã ã‹ã‚‰çµ„ã¿è¾¼ã¿ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ã€‚

## disabled ã‚’è€ƒæ…®ã™ã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ä¸€è¦§

```shell
$ capybara-3.37.1/lib/capybara/selector/definition $ rg -wl disabled
field.rb
option.rb
button.rb
datalist_input.rb
datalist_option.rb
link_or_button.rb
fieldset.rb
checkbox.rb
fillable_field.rb
select.rb
file_field.rb
radio_button.rb
```

## çµ„ã¿è¾¼ã¿ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã„ã¤ã¤ disabled ãªã‚¿ã‚°ã‚‚é¸æŠã—ãŸã„

`disabled: true` ã‚’ã¤ã‘ã‚‹

```ruby
node = Capybara.string("<button disabled>foo</button>")
node.has_selector?(:button)                 # => false
node.has_selector?(:button, disabled: true) # => true
```

## çµ„ã¿è¾¼ã¿ã‚»ãƒ¬ã‚¯ã‚¿ã ã¨ãƒãƒƒãƒã—ã™ãã‚‹ã‘ã©å¿…ãšãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹æ–¹æ³•ãŒã‚ã‚‹

```ruby
node = Capybara.string(<<~EOT)
<input type="submit" value='a' />
<input type="reset" value='b' />
<input type="image" value='c' />
<input type="button" value='d' />
<button>e</button>
EOT
```

ã™ã¹ã¦ã«ãƒãƒƒãƒã—ã¦ã—ã¾ã†

```ruby
node.all(:button).collect { |e| e.value || e.text }.join # => "abcde"
```

ç‰¹å®šã®ã‚¿ã‚°ã ã‘æ‹¾ã†æ–¹æ³•ãŒã‚ã‚‹

```ruby
node.find(:button, type: "submit").value # => "a"
node.find(:button, type: "reset").value  # => "b"
node.find(:button, type: "image").value  # => "c"
node.find(:button, type: "button").value # => "d"
node.find(:button, text: "e").text       # => "e"
```

ã“ã“ã§é‡è¦ãªã®ãŒ `type` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `:button` ã ã‹ã‚‰ä½¿ãˆã‚‹ã¨ã„ã†ã“ã¨ã€‚
`find("button")` ã§ã¯ä½¿ãˆãªã„ã€‚

## çµ„ã¿è¾¼ã¿ã‚»ãƒ¬ã‚¯ã‚¿ã®å¼•æ•°ä¸€è¦§

https://github.com/teamcapybara/capybara/blob/8350c78823d6869c3380f5d8174f18e86dff4d9c/lib/capybara/selector.rb#L8

## `target="_blank"` ã§é–‹ã„ãŸã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹

```ruby
Capybara.switch_to_window(Capybara.windows.last)
```

## æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦ç§»å‹•ã—ã¦ä½•ã‹ã—ã¦é–‰ã˜ã¦æˆ»ã‚‹

```ruby
Capybara.within_window(Capybara.open_new_window) do
  # Capybara.visit("https://www.youtube.com/")
  # ä½•ã‹ã™ã‚‹
  Capybara.current_window.close
end
```

## ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

ä»Šã„ã‚‹ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
if Capybara.current_window != Capybara.windows.first
  Capybara.current_window.close
end
```

ä»–ã®ã‚¿ãƒ–ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹

```ruby
(Capybara.windows.drop(1) - [Capybara.current_window]).each(&:close)
```

å³å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows.drop(windows.find_index(current_window).next).each(&:close)
end
```

å·¦å´ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.instance_eval do
  windows[1...windows.find_index(current_window)].each(&:close)
end
```

ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹

```ruby
Capybara.reset!
```

- ã„ã¡ã°ã‚“å·¦ç«¯ã®ã‚¿ãƒ– `windows.first` ã¯ close ã§ããªã„
- close ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `Not allowed to close the primary window`

## JavaScript ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å–å¾—ã™ã‚‹

```ruby
p Capybara.evaluate_script("window.navigator.userAgent")
# >> "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36"
```

## D&Dã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

dropybara gem ã‚’ä½¿ã‚ã›ã¦ã‚‚ã‚‰ã†

```ruby
`convert logo: file.png`
Capybara.visit("https://css-tricks.com/examples/DragAndDropFileUploading/")
Capybara.page.drop_file("form", "file.png")
```

## ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« set ã—ãŸã¤ã‚‚ã‚ŠãŒè¿½è¨˜ã•ã‚Œã¦ã—ã¾ã†

```ruby
Capybara.find(".foo").set("xxx", clear: :backspace)
```

## ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãªã„ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã‹ãªã„

```ruby
Capybara.find(".foo").hover
```

## `command + a` ã§ã€ã™ã¹ã¦ã‚’é¸æŠ

```ruby
Capybara.find("html").send_keys([:command, "a"])
```

## ãƒšãƒ¼ã‚¸ã®æœ€å¾Œã¾ã§ç§»å‹•ã™ã‚‹

```ruby
Capybara.find("html").send_keys(:end)
```

## ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã‚‹

```ruby
module Clipboard
  extend self

  def write(text)
    IO.popen("pbcopy", "w") { |io| io.write(text) }
  end

  def read
    IO.popen("pbpaste", &:read)
  end
end

Clipboard.write("")
Capybara.visit("https://www.ruby-lang.org/ja/")
Capybara.find("html").send_keys([:command, "a"])
Capybara.find("html").send_keys([:command, "c"])
puts Clipboard.read.lines.take(2)
# >> Ruby
# >> A PROGRAMMER'S BEST FRIEND
```

## JavaScript ã‚’ä½¿ã£ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«å…¥ã‚Œã‚‹

```ruby
Clipboard.write("")
Capybara.visit("https://www.google.co.jp/")
Capybara.execute_script("await navigator.clipboard.writeText('foo')")
Clipboard.read # => "foo"
Capybara.first("form input").send_keys([:command, "v"])
```

## YouTubeã§ç”»é¢ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦ã‚¹ã‚¯ã‚·ãƒ§ã‚’å–ã‚‹

```ruby
Capybara.visit("https://www.youtube.com/watch?v=Ftm2uv7-Ybw")
Capybara.current_window.resize_to(640, 480)
sleep(1)
Capybara.save_screenshot("youtube.png")
```

- YouTubeã¯ç”»é¢ã®ãƒªã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãŒã€ã‹ãªã‚Šã‚‚ã£ã•ã‚Šã‚†ã£ãŸã‚Šã¨åˆ‡ã‚Šæ›¿ã‚ã‚‹
- ãªã®ã§ã€ã“ã®ã‚ãŸã‚Šã¯æ·±è¿½ã„ã›ãšè¦‹å½“ã¤ã‘ã¦ sleep ã‚’å…¥ã‚Œã‚‹ (å‰è¨€æ’¤å›)

## RSpec å®Ÿè¡Œæ™‚ã«ã‚¹ã‚¯ã‚·ãƒ§ã‚’é›†ã‚ã‚‹

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
  gem "rspec", require: "rspec/autorun"
end

Capybara.current_driver = :selenium_chrome_headless

RSpec.configure do |config|
  config.before(:example) do |ex|
    @full_description = ex.full_description
  end

  config.include Module.new {
    def image_save
      name = @full_description.gsub(/\s+/, "_")
      Capybara.save_screenshot("#{name}.png")
    end
  }
end

RSpec.describe "Browsing" do
  it "Google" do
    Capybara.visit("https://www.google.co.jp/")
    image_save
  end

  it "YouTube" do
    Capybara.visit("https://www.youtube.com/")
    image_save
  end
end
# >> ..
# >>
# >> Finished in 7.38 seconds (files took 0.11407 seconds to load)
# >> 2 examples, 0 failures
# >>
```

```shell
$ exa -al --no-user Browsing*.png
.rw-r--r-- 130k 18 5 12:24 Browsing_Google.png
.rw-r--r-- 621k 18 5 12:24 Browsing_YouTube.png
```

- å˜ã«ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‹ã‚‰ã¯ã©ã“ã®ã‚¹ã‚¯ã‚·ãƒ§ã ã£ãŸã‹åˆ¤æ–­ã§ããªã„
- ã‹ã¨ã„ã£ã¦ã€ã„ã¡ã„ã¡ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ãŸããªã„
- ã®ã§ full_description ã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºã‚ã‚‹
- ã‚¹ã‚¯ã‚·ãƒ§ãŒæ¬²ã—ã„ã¨ã“ã‚ã« image_save ã‚’ç½®ã

## è‡ªå‹•åŒ–å‡¦ç†ä¸­ã«çŠ¶æ³ã‚’çŸ¥ã‚‰ã›ã‚‹

ã“ã‚Œã‚’å®šç¾©ã—ã€

```ruby
def say(message)
  system "say '#{message}'"
end
```

çŸ¥ã‚‰ã›ãŸã„ã¨ã“ã‚ã«ç½®ã

```ruby
say "ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"
```

say ã‚’å®šç¾©ã—ãŸã¯ãšãŒã—ã‚ƒã¹ã‚‰ãªã„åŸå› ã¯ Thor ã® say ãƒ¡ã‚½ãƒƒãƒ‰ã¨å¹²æ¸‰ã—è² ã‘ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã‚‹

## è‡ªå‹•åŒ–ã®æ•µ reCAPTCHA ã¯äººé–“ã«é ¼ã‚€

ã“ã‚Œã‚’å®šç¾©ã—ã€

```ruby
def pause(message = "ä¸€æ™‚åœæ­¢")
  say message
  puts message
  s = $stdin.gets.strip
  if s == "d"
    Capybara.using_wait_time(0) { debugger }
  end
end
```

äººé–“ã®åŠ©ã‘ãŒå¿…è¦ãªã¨ã“ã‚ã«æŒŸã‚€

```ruby
pause "reCAPTCHA ã‚’å€’ã›"
```

- `$stdin.gets` ã—ã¦ã„ã‚‹ã®ã¯ Thor ã‹ã‚‰ä½¿ã†å ´åˆã‚’è€ƒæ…®ã—ã¦ã„ã‚‹
- `gets` ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã¨è¦‹ãªã—ãŸå¼•æ•°ã‚’èª­ã¿è¾¼ã‚‚ã†ã¨ã—ã¦ã—ã¾ã†
- ã¤ã„ã§ã« `d ENTER` ã§ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã‚’èµ·å‹•ã•ã›ã‚‹

## visit ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹

GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

```ruby
require "active_support/core_ext/object/to_query"
require "active_support/core_ext/object/blank"

Capybara::Session.prepend Module.new {
  def visit(uri, params = {})
    super [uri, params.to_query.presence].compact.join("?")
  end
}

Capybara.visit("https://www.google.co.jp/search", q: "foo")
```

## ä½¿ã„æ¨ã¦ã‚µãƒ³ãƒ—ãƒ«

```ruby
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
end

Capybara.current_driver = :selenium_chrome

Capybara.visit "https://www.google.co.jp/"
Capybara.first("form input").set("foo")
Capybara.first("form input[type=submit]").click

gets
```

## ç”»é¢ã‚’50%ã¾ã§ç¸®å°ã™ã‚‹æ–¹æ³•

`command + -` ã‚’5å›æŠ¼ã—ã¦50%ã«ã—ãŸã¨ãã¨åŒã˜è¦‹ãŸç›®ã«ãªã‚‹

```ruby
Capybara.execute_script("document.body.style.zoom = 0.5")
```

æ¬¡ã®æ–¹æ³•ã§ã¯å‹•ã‹ãªã„

```ruby
Capybara.find("html").send_keys([:command, "-"])
```

ã¾ãŸæ¬¡ã®æ–¹æ³•ã§ã‚‚ãƒ•ã‚©ãƒ³ãƒˆã ã‘ã¯ç¸®å°ã•ã‚Œã‚‹ãŒæœŸå¾…ã—ãŸå‹•ä½œã¨ã¯ç•°ãªã‚‹

```ruby
Capybara.execute_script("document.body.style.fontSize = '50%'")
```

## `document.body.style.zoom` ã‚’å¼„ã‚‹ã¨æŠ¼ã›ã‚‹è¦ç´ ãŒæŠ¼ã›ãªããªã‚‹å ´åˆãŒã‚ã‚‹

æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯

```
*** Selenium::WebDriver::Error::ElementClickInterceptedError Exception:
element click intercepted: Element <button>...</button> is not clickable at point (1503, 193).
Other element would receive the click: <div class="xxx"></div>
```

ã„ã£ãŸã‚“ã“ã‚Œã§å…ƒã«æˆ»ã™ã¨æŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã‚‹å ´åˆãŒã‚ã£ãŸ

```ruby
Capybara.execute_script("document.body.style.zoom = 1.0")
```

## form ã® onSubmit ãƒ•ãƒƒã‚¯ãŒé‚ªé­”ã—ã¦ submit ã§ããªã„

- onSubmit ãƒ•ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

```ruby
Capybara.execute_script("document.querySelector('form').onsubmit = undefined")
Capybara.click_on("é€ä¿¡")
```

## é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¬ã®è¦ç´ ã«é‚ªé­”ã•ã‚Œã¦ submit ã§ããªã„

- form ã‚’ç›´æ¥ submit ã™ã‚‹
- é‚ªé­”ãªè¦ç´ ã‚’ `remove()` ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹

```ruby
Capybara.execute_script("document.querySelector('form').submit()")
```

## ç¸¦ã«é•·ã„ãƒ•ã‚©ãƒ¼ãƒ ã§ã„ã¡ã°ã‚“ä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰ç”»é¢å¤–ã«å‡ºãŸä¸€ç•ªä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒé¸æŠã§ããªããªã£ãŸ

- ã¾ã•ã‹ç”»é¢å¤–ã«å‡ºã‚‹ã¨é¸æŠã§ããªã„ï¼Ÿ ã¨ã€å‹˜é•ã„ã—ã¦ã—ã¾ã†ã‚ˆã†ãªä½•ã‹ãŒé‚ªé­”ã—ã¦ã„ã‚‹ã¯ãš
- æ™®é€šã¯ç”»é¢å¤–ã§ã‚‚é¸æŠã§ãã‚‹
- ã§ã€`Unable to find visible css "#xxx` ãŒå‡ºãŸã‚‰ã¨ã‚Šã‚ãˆãš `visible: :all` ã‚’ã¤ã‘ã‚‹ã¨é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

```ruby
Capybara.find("#xxx", visible: :all)
```

## assert ã‚’ä»•æ›ã‘ã¾ãã‚‹

HTMLä»¥å¤–ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã€ã“ã†ãªã£ã¦ã„ã‚‹ã¹ããªã¨ã“ã‚ã«ã¯ã©ã‚“ã©ã‚“ assert ã‚’ä»•æ›ã‘ã¦ãŠã

```ruby
def assert(value)
  if !value
    say "äºˆæœŸã›ã¬äº‹æ…‹ã§ã™"
    raise "must not happen"
  end
end

assert windows.count == 5
```

## confirm ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã® OK ã‚’æŠ¼ã™æ–¹æ³•

```ruby
Capybara.accept_confirm
```

- æ­£æ”»æ³•ã ãŒã„ã¾ã„ã¡
- åŸå› ãŒã‚ã‹ã‚‰ãªã„ãŒã“ã®æ–¹æ³•ã¯ä¸å®‰å®šã€ã¨ã„ã†ã‹ã»ã¨ã‚“ã©ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
- `accept_confirm` ã®ç›´å‰ã§ãƒ‡ãƒãƒƒã‚¬ã§æ­¢ã‚ã€æ‰‹å‹•ã§ `accept_confirm` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ç¢ºå®Ÿã« `Unable to find modal dialog (Capybara::ModalNotFound)` ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
- ã‚·ãƒ³ãƒ—ãƒ«ãªHTMLã§ confirm ãŒå‡ºã‚‹å‡¦ç†ã¨ accept_confirm ã‚’é€£ç¶šã§å®Ÿè¡Œã—ãŸã¨ãã ã‘ä¸€å¿œå‹•ã„ãŸ

## accept_confirm ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¨ãã®å¯¾å‡¦æ³•

- `Unable to find modal dialog` ãŒå‡ºã‚‹ã®ã§ accept_confirm ã¯è«¦ã‚ã‚‹
- ä»£ã‚ã‚Šã« confirm è‡ªä½“ãŒ true ã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹

```ruby
Capybara.execute_script("window.confirm = () => true")
```

## é »ç¹ã«å‡ºã‚‹ alert ã‚’ç„¡è¦–ã—ãŸã„

accept_alert ã§ OK ã‚’æŠ¼ã—ãŸã“ã¨ã«ã§ãã‚‹ã‚‰ã—ã„ãŒã€ã“ã¡ã‚‰ã‚‚ confirm ã¨åŒæ§˜ã®ç¾è±¡ãŒèµ·ãã‚‹ã®ã§å‡¦ç†ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã®ãŒã¦ã£ã¨ã‚Šæ—©ã„

```ruby
Capybara.execute_script("window.alert = () => true")
```

## é–‰ã˜ãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã„ã‚‹çŠ¶æ…‹ã§ open_new_window ã™ã‚‹ã¨ä¾‹å¤–ãŒã§ã‚‹

```ruby
Capybara.switch_to_window(Capybara.open_new_window)
Capybara.current_window.close
Capybara.open_new_window rescue $! # => #<Selenium::WebDriver::Error::NoSuchWindowError: no such window: target window already closed
```

ç”Ÿãã¦ã„ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã„ã£ãŸã‚“æˆ»ã‚Œã°å•é¡Œãªã„

```ruby
Capybara.switch_to_window(Capybara.open_new_window)
Capybara.current_window.close
Capybara.switch_to_window(Capybara.windows.first) # â†
Capybara.open_new_window # => #<Window @handle="CDwindow-EA4763FC0D41D15C065A53F092C21BFA">
```

ã™ãæˆ»ã‚‹ãªã‚‰ `within_window + open_new_window` ã‚’ä½¿ã†

```ruby
Capybara.within_window(Capybara.open_new_window) do
  ...
  Capybara.current_window.close
end
```

## ã„ã¾ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ã¦ã„ã‚‹è¦ç´ ã‚’å–å¾—ã™ã‚‹

```ruby
Capybara.current_session.active_element # => #<Capybara::Node::Element tag="body" path="/HTML/BODY[1]">
```

- `Capybara.active_element` ã§ã¯å‘¼ã¹ãªã„ã®ã§æ³¨æ„

## ã©ã“ã‹ã‚’é¸æŠã™ã‚‹ã®ã§ã¯ãªãä»Šã„ã‚‹å ´æ‰€ã§å…¥åŠ›

```ruby
Capybara.current_session.active_element.send_keys("foo")
```

## ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ¤œç´¢ã®å®šç•ªã‚³ãƒ¼ãƒ‰

- 1ä»¶ã«ãªã‚‹ã¾ã§å¾…ã¤
- è¦‹ã¤ã‹ã‚‹ã¾ã§5ç§’é–“ã¯å¾…ã¤
- é€£ç¶šã§æ¤œç´¢ã™ã‚‹ã¨ããªã©ã¯ã¨ãã«æ¤œç´¢æ–‡å­—åˆ—è‡ªä½“ã‚’ has_selector? ã§æ¢ã™ã®é‡è¦

```ruby
Capybara.find("input[type=search").set("alice", clear: :backspace)
if Capybara.has_selector?(".row", text: "alice", count: 1, wait: 5)
  Capybara.find(".row").text
else
  # è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ
end
```

## Capybara ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ã¯ Capybara ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯ãªã DSL ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¿½åŠ ã™ã‚‹

Capybara ã¯ DSL ã‚’ extend ã—ã¦ã„ã‚‹ã®ã§ DSL ã«å®šç¾©ã™ã‚Œã° Capybara.xxx ã¨ã—ã¦å®Ÿè¡Œã§ãã‚‹

è¤‡æ•°ã® URL ã‚’ä¸€æ°—ã«é–‹ã„ã¦æœ€åˆã®ã‚¿ãƒ–ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹ä¾‹

```ruby
module Capybara::DSL
  def visit_all(urls)
    windows = urls.collect do |e|
      switch_to_window(open_new_window)
      visit(e)
      current_window
    end
    if window = windows.first
      switch_to_window(window)
    end
    windows
  end
end
```

## ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æœ€å¤§åŒ–ã¯æœ€åˆã®visitã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§1å›ã ã‘å®Ÿè¡Œã™ã‚‹

ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æœ€å¤§åŒ–è‡ªä½“ã¯ã“ã†ã™ã‚‹

```shell
Capybara.current_window.maximize
```

å½“åˆã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æœ€å¤§åŒ–ã¯ visit ã™ã‚‹æ¯ã«å®Ÿè¡Œã—ãªã„ã¨ã„ã‘ãªã„ã®ã‹ã¨å‹˜é•ã„ã—ã¦ã„ãŸãŒã€`Capybara.current_driver` ã®è¨­å®šã¨åˆã‚ã›ã¦æœ€åˆã«ä¸€åº¦å®Ÿè¡Œã—ã¦ãŠãã ã‘ã§ã‚‚ã‚ˆã„ã€‚

ãŸã ã— Capybara ã‚’ä½¿ã‚ãªã„ã¨ãã‚‚ `Capybara.current_window.maximize` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã„ã¦ã—ã¾ã†ã®ãŒæ°—ã«ãªã‚‹ã®ã§ã€æœ€åˆã« visit ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æœ€å¤§åŒ–ã•ã›ã‚‹ã€‚

```ruby
Capybara::Session.prepend Module.new {
  def visit(...)
    current_window_maximize_once
    super
  end

  def current_window_maximize_once
    @current_window_maximize_once ||= yield_self do
      current_window.maximize
      true
    end
  end
}
```

## ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

https://github.com/teamcapybara/capybara
https://gist.github.com/palkan/9a9ba6fd0b54f41428eb62b32f988bfc
