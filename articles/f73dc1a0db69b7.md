---
title: "Capybara の知見まとめ"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Capybara", "Ruby", "自動化"]
published: false
---

## 動作検証用の使い捨てサンプルが欲しい

```ruby
require "bundler/inline"

gemfile(true) do
  source "https://rubygems.org"
  gem "webdrivers"
  gem "capybara", require: "capybara/dsl"
end

Capybara.current_driver = :selenium_chrome

Capybara.visit "https://www.google.co.jp/"
Capybara.first("form input").set("Hello, world!")
Capybara.first("form input[type=submit]").click

gets
```

## Selenium でオプションの警告が出る

```
WARN Selenium [DEPRECATION] [:browser_options] :options as a parameter for driver initialization is deprecated. Use :capabilities with an Array of value capabilities/options if necessary instead.
```

- capybara が古いのが原因
- 3.37.1 以上だと警告は出なかった

## chromedriver がないと言われる

```
Failure/Error: raise Error::WebDriverError, self.class.missing_text unless path

Selenium::WebDriver::Error::WebDriverError:
  Unable to find chromedriver. Please download the server from
  https://chromedriver.storage.googleapis.com/index.html and place it somewhere on your PATH.
  More info at https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver.
```

- エラーメッセージ通りに指定のURLから chromedriver をダウンロードして PATH を設定する、などしてはいけない
- webdrivers gem を入れる

## chromedriver はローカルのどこにある？

```shell
$ exa -al --no-user ~/.webdrivers
.rwxr-xr-x 17M 10 7  2021 chromedriver
.rw-r--r--  13 16 5 06:23 chromedriver.version
```

## chromedriver があるのに正しく動作しない

- Google Chrome と chromedriver のバージョンが一致していないのかもしれない
  - Google Chrome のバージョンは `chrome://settings/help` でわかる
  - chromedriver のバージョンは `cat ~/.webdrivers/chromedriver.version` でわかる
- Google Chrome のバージョンが70以上であれば Google Chrome と chromedriver のバージョンは一致する、と webdrivers gem の README に書いてある
  - しかし Google Chrome が自動アップデートされた直後に同じバージョンの chromedriver がまだ用意されてないことがあった
  - それで一回事故って大変な目にあったことがあるのでバージョン一致説には疑念を持っている
  - なので自分のところでは Google Chrome のバージョンを無理やり固定している
- 絶対に事故らない何か良い方法はないんだろうか？(誰かおせーて)

## グローバルに chromedriver がある

```shell
$ which chromedriver
/usr/local/var/rbenv/shims/chromedriver
```

- それは chromedriver-helper gem の残骸
- 他にも chromedriver で始まる外部コマンドがあるはず
- 全部抹殺しよう

```shell
$ rm /usr/local/var/rbenv/shims/chromedriver*
```

## また chromedriver が出てきた

```shell
$ which chromedriver
/usr/local/bin/chromedriver
```

- それは `brew install chromedriver` で入れたやつ
- 抹殺しよう

```shell
$ brew uninstall chromedriver
```

## rack application が必要だとか言われる

```shell
rack-test requires a rack application, but none was given (ArgumentError)
```

- それは見なかったことにして current_driver に :selenium_chrome を指定する

```ruby
Capybara.current_driver = :selenium_chrome
```

## `require "capybara/dsl"` するとどうなる？

- いろいろ短かく書けるようになる
- Capybara.page で Capybara.current_session を呼べるようになる
- Capybara.page に対するメソッドが Capybara モジュール自体に定義される
- つまり Capybara.current_session.xxx が Capybara.xxx と書けるようになる

## 待ち秒数を変更する

全体
```ruby
Capybara.default_max_wait_time = 2
```

局所的
```ruby
Capybara.using_wait_time(1) do
  Capybara.default_max_wait_time # => 1
end
```

指定したメソッドだけ
```ruby
Capybara.assert_title("Google", wait: 1)
```

- マッチしないときにこれを増やしがちだけどこれで解決することはほぼない
- なのでデフォルト 2 のままで良い
- 例外的に App Store Connect のような激重サイトであれば増やしてもよいかもしれない

## 途中で止めてDOMの構造を調べる

- byebug gem を入れる
- 本当は debug gem の方がいいのかもしれないが eshell からなぜか動かないので byebug にしている
- さくさく調べたいので default_max_wait_time を 0 にしてから debugger を起動する

```ruby
Capybara.using_wait_time(0) { debugger }
```

- snippet 的なやつですぐに入力できるようにしておこう

## 待つ

assert_xxx 系のメソッドはその状態になるまで待つのに使える

## 指定の要素が1件になるまで待つ

- インクリメンタル検索などで結果の数が変動する場合に有用

```ruby
Capybara.assert_selector(".row", count: 1)
```

## 指定のURLになるまで待つ

```ruby
Capybara.visit("https://www.youtube.com/results?search_query=ruby")
Capybara.assert_current_path("/results?search_query=ruby")
```

`Capybara.current_path` でもパスがわかるからといって次のように書いてはいけない。

```ruby:間違った例
raise unless Capybara.current_path == "/results"
```

その場合は次のように置き換える。

```ruby:正しい例 (クエリ部分は比較しない)
Capybara.assert_current_path("/results", ignore_query: true)
```

## `target="_blank"` で開いたタブに移動する

```ruby
Capybara.switch_to_window(Capybara.windows.last)
```

## D&Dでファイルアップロードするには？

dropybara gem を追加する

```ruby
`convert logo: file.png`
Capybara.visit("https://css-tricks.com/examples/DragAndDropFileUploading/")
Capybara.page.drop_file("form", "file.png")
```

## マウス操作では押せるのにプログラムから選択できない

阻害している DOM を探し出して抹殺する

```ruby
Capybara.execute_script("document.querySelector('.foo').remove()")
```

## 確実に選択できるセレクターを得る

- Developer Tool で該当タグの位置を示す情報を `Copy Selector` でコピる

## YouTubeでブラウザの画面サイズを調整してスクショを取る

```ruby
Capybara.visit("https://www.youtube.com/watch?v=Ftm2uv7-Ybw")
Capybara.current_window.resize_to(640, 480)
sleep(1)
Capybara.save_screenshot("youtube.png")
```

- YouTubeは画面のリサイズに応じて切り替わる速度が遅い
- このあたりは見当つけてウェイトを入れた方がよいだろう

## RSpec 実行時にスクショを集める

## App Store Connect にログインできない
